\ifx\all\undefined
\include{base}
\begin{document}
\fi
  
\chapter{Diseño y desarrollo}

Al momento de escritura de este informe, la Ciudad autónoma de Buenos Aires presenta la mayor cantidad de servicios ofrecidos en el país por la televisión digital abierta: 16 servicios ofrecidos a nivel nacional, más 10 servicios emitidos en AMBA y CABA y 2 adicionales en provincia de Buenos Aires, sumando un total de 28 servicios. 

En una red privada de transmisión de televisión analógica por cable, el número de servicios asciende a 70. Está claro que la televisión digital terrestre no puede competir con la televisión por cable en este ámbito. A pesar del uso más eficiente que implica la digitalización de la señal.

La escacés de servicios que ofrece ISDB-T radica en el número de canales físicos de radiofrecuencia asignados a la transmsión de servicios. Para este problema no hay una solución previsible a futuro mediato. 

IPTV usa una red de internet que además está siendo exigida por otros clientes. Lo cual quiere decir que cualquiera de los nodos puede caerse por motivos ajenos  a iptv. Es decir, no es una infraestructura dedicada. Con lo cual está sujeta a la cantidad de clientes, no solo en iptv, si no en tv.

La masividad del consumo televisivo, por otro lado, dificulta la utilización de mecanismos que no utilicen broadcasting. Es necesaria una infraestructura extremadamete robusta para soportar la alimentación de millones de sistemas de recepción[AGREGAR UNA CITA A INTRODUCCION CON EJEMPLOS DE LOS PENALES CON HOLANDA?]. Por ejemplo, la transmisión de IPTV, en estos casos, es riesgosa y la caída del sistema implica dejar sin servicio a un gran porcentaje de la población, potencialmente.

El problema de IPTV radica en que la infraestructura es suceptible al número de consumidores en un momento dado, siendo que es compleja y delicada. La sobreexigencia puede denegar a la entrega parcial o totalmente a los receptores.

El objetivo de este capítulo es explicar el diseño  y detallar el método de construcción de un prototipo de recepción. un sistema que obtenga las mejores características de cada formato de entrega. El resultado esperado es un sistema de transmisión que cuente con la robustez del esquema broadcast y la extensibilidad de la transmisión multicast.








\section{Señalización y distribución de servicios}

El primer paso para combinar los sistemas de transmisión es definir qué servicios viajan por qué medio e indicar esto a los dispositivos de recepción. Llamaremos a la entrega de información sobre los servicios para la construcción de la lista \emph{señalización}. 

La señalización del sistema de entrega debe ser, en lo posible, centralizada y debe estar disponible siempre que el sistema de entrega lo esté. Para estos fines, la transmisión ISDB-T resulta adecuada:

Como hipótesis de trabajo, la señalización de los servicios debe poseer las siguientes características:

\begin{itemize}
\item Centralizada.
\item Disponible para todos los dispositivos de recepción, independientemente de los consumidores del servicio.
\item Debe aprovechar el sistema de señalización que ya provee ISDB-T a través del formato MPEG-TS.
\end{itemize}

\subsection{Extensión del formato MPEG-TS}

El primer punto de trabajo es agregar una extensión al flujo de transporte para que sea capaz de indicarle al receptor la existencia de un servicio cuyos flujos elementales deben ser obtenidos por medio de una red IP, en emisión multicast.

Para que un receptor reconozca un servicio y lo incluya a su lista de servicios disponibles, debe encontrar una entrada correspondiente en la \sdt, en la \pat\ y, finalmente, una \pmt\ asignada al servicio. Como es ésta última la encargada de indicar la ubicación de los flujos elementales, la extensión corresponde (y debe limitarse a) esta tabla.

\section{\emph{Elementaries relocation descriptor}}

Siguiendo el segundo de los principios de diseño \textbf{SOLID}(\emph{Open/Closed Principle}), uno de los objetivos de este desarrollo es evitar violar el formato MPEG-TS tanto como sea posible, sino extenderlo. Entonces, se busca agregar los comportamientos a entidades nuevas en lugar de modificar las ya existentes.

Para señalizar nuevos servicios cuyos flujos elementales se deben obtener desde una red IP, entonces, se utilizará el \emph{Elementaries Relocation Descriptor}. Como su nombre lo indica, esta entidad denota un descriptor del estándar MPEG-TS. Éste descriptor sólo puede hallarse en la \pmt\ e implica que el servicio al cual está asociada la tabla, posee las características mencionadas.

El \emph{Elementaries Relocation Descriptor} tiene asignado el \emph{descriptor\_tag} 170. No existe, actualmente, un descriptor en el formato MPEG-TS con el mismo nombre o \emph{descriptor\_tag} o semántica similar.

Para que el receptor sea capaz de obtener los flujos elementales, al ser una red IP el medio y multicast el esquema de envío de paquetes, es necesario proveer a través del descriptor un grupo multicast y un puerto asociado. Entonces la sintaxis del descriptor es la siguiente:

\begin{table}[H]
\begin{center}
\begin{tabular}{ | l | c | c | c | } 
\hline
Elemento                   & Rango de valores            & Número de bits asignado & Bit de comienzo \\
\hline 
\emph{descriptor\_tag}     & 170                         & 8        & 0       \\
\emph{descriptor\_length}  & 6                           & 8        & 8       \\
\textbf{Grupo Multicast}            & 3758096384 -- 4026531839    & 32       & 16      \\
\textbf{Puerto}                     & 1 -- 65535                  & 16       & 48      \\
\hline 
\end{tabular}
\caption{Sintaxis del \emph{Elementaries Relocation Descriptor}}
\end{center}
\end{table}

Descripción de los elementos:
\begin{itemize}
\item \emph{descriptor\_tag}: Elemento requerido por la definición sintáctica de los descriptores. Lleva el valor 170 para identificar al \emph{Elementaries Relocation Descriptor} en el \emph{descriptor loop}.
\item \emph{descriptor\_length}: Elementor requerido por la definición sintáctica de los descriptores. El \emph{Elementaries Relocation Descriptor} tiene una longitud fija de 8 bytes. De modo que este campo siempre lleva el valor 6 (no incluye los primeros dos campos del descriptor).
\item \textbf{Grupo Multicast}: Grupo Multicast al que se debe unir el receptor para capturar los flujos elementales del servicio al que está asociada la PMT en la que viaja este descriptor. El rango de valores se debe a que las direcciones IP asignadas a los grupos multicast se hallan en el rango 224.0.0.0 -- 239.255.255.255. Estas direcciones IP codificadas en \emph{big-endian} (el byte más significativo en la menor dirección de memoria) resultan en esos valores.
\item \textbf{Puerto}: El puerto al cual se realiza la emisión. Son dos bytes codificados en \emph{big-endian}. Cabe notar que el valor 0 representa un número de puerto inválido.
\end{itemize}

\section{Construcción de un flujo de transporte de referencia}

Para la descripción de la construcción de un flujo de referencia para el sistema de transmisión, se parte de un flujo de transporte ISDB-T válido. Es decir, se explicará el agregado de servicios a un flujo de tranporte existente. Se utilizará como ejemplo el ejemplo de canal 23 del capítulo de introducción técnica.

Los pasos de extensión se resumen a continuación. Este procedimiento se debe repetir por cada servicio que se quiera agregar al flujo de transporte.

\begin{enumerate}
	\item Crear una entrada en la \sdt\ que indique:
	\begin{enumerate}
		\item \emph{service\_id} del servicio
		\item Nombre del servicio
		\item Tipo del servicio (en general, 1, correspondiente a televisión digital)
		\item TODO: Alguno más?
	\end{enumerate}
	\item Crear una entrada en la \pat. La entrada debe incluir:
	\begin{enumerate}
		\item \emph{service\_id} del servicio
		\item \pid\ de la PMT que se le agregará al flujo de transporte
	\end{enumerate}
	\item Crear una \pmt\ correspondiente al servicio a agregar. Los elementos que incluye la \pmt\ son:
	\begin{enumerate}
		\item \emph{service\_id} del servicio
		\item El \emph{Elementaries Relocation Descriptor} con grupo multicast y puerto por los que se emiten los flujos elementales.
		\item TODO: Qué pasa si no le ponemos flujos la PMT! Eso está bueno
	\end{enumerate} 
	\item Insertar la \pmt\ al flujo de transporte. Siendo que la \pmt\ debe hallarse en un período de 200 milisegundos, es necesario conocer el bitrate de emisión. 
\end{enumerate}

\subsection{Extensión de OpenCaster}

Para facilitar la construcción de las estructuras de MPEG-TS, se realizó una extensión al proyecto OpenCaster. Esta extensión le permite a la herramienta reconocer el descriptor agregado, como si fuera parte del estándar, para así incluirla en la \pmt, de igual manera que con cualquier otro descriptor.

\begin{figure}
\begin{center}

\resizebox{\linewidth}{!}{
\input{diagrams/open_caster_modif}
}

\caption{Diagrama de Clases de OpenCaster modificado}
\end{center}
\end{figure}

El \emph{Elementaries Relocation Descriptor} se modela con una clase con dos variables de instancia. Una asociada al grupo multicast y la segunda asociada al puerto. Definiendo el método \texttt{bytes}, la clase luego se empaqueta en la estructura sintáctica definida anteriormente.

La forma de instanciar la clase correspondiente al descriptor es:

\lstinputlisting[language=Python,caption={Instanciación del descriptor en OpenCaster}]{src_code/descriptor_instantiation.py}

Donde XX.XX.XX.XX debe ser reemplazado por el grupo multicast e YYYY por el puerto.

\subsection{Construcción de flujo de transporte de referencia}

Para la construcción del flujo de transporte se pueden aprovechar las herramientas incluidas en OpenCaster. Los elementos requeridos en el paso a paso presentado anteriormente se pueden construir con un \emph{script python} similar al siguiente.

\lstinputlisting[language=Python,caption={Ejemplo de creación de tablas en OpenCaster}]{src_code/table_gen.py}

\subsection{Extensión del flujo de transporte del Canal 23}

Utilizaremos como base el flujo de transporte con los tres servicios: ``TV Pública HD'', ``Tecnópolis'' y ``TV Pública'' emitido por la frecuencia 527MHz. En el ejemplo se revisa cómo se incluyen dos servicios cuyos flujos elementales se emiten por un grupo multicast.

Para empezar es importante definir cuáles son los nuevos servicios que se van a agregar. A fines ilustrativos, llamaremos a estos servicios ``TV Universidad'' y ``La Plata TV''.

Repasando la lista anterior, repasamos los pasos de construcción:

\begin{enumerate}
	\item El primer paso es crear una entrada en la \sdt\ que indique los nombres de los servicios y que son servicios de TV digital. Para esto, la \sdt\ debe hacer referencia al \emph{service\_id}. La única limitación que existe para elegir este número es que no haya sido ocupado por algún otro servicio en el mismo flujo de transporte o ser 0. Los \emph{service\_id} ya utilizados en el TS son 59201, 59224 y 59202.
		\subitem Los \emph{service\_id} serán: 60000 para ``TV Universidad'' y 60001 para ``TV La Plata''.
	\item A continuación se debe incluir una entrada a la \pat\ para cada servicio. Habiendo ya definido los \emph{service\_id}, sólo queda definir \pid s para cada \pmt. En el caso de los \pid\, es importante cuidar que no se utilice un número de \pid\ reservado. Se incluye una lista en el apéndice [TODO: Apéndice].
		\subitem Los \pid\ asignados a las \pmt\ serán 1000 para ``TV Universidad'' y 1001 para ``TV La Plata''.
	\item Como son dos los servicios a agregar al flujo de transporte, es necesario crear dos \pmt. Una por cada uno. 
		\subitem Ya se definieron sus \pid\ y sus \emph{service\_id}. El único elemento restante es el \emph{Elementaries Relocation Descriptor}, que a su vez debe incluir grupo multicast y puerto por los que se emiten los flujos elementales. Asignaremos el grupo 239.1.1.1 a ``TV Universidad'' y 239.1.1.2 a ``TV La Plata''. Ambos por puerto 1000.
	\item Finalmente, sólo resta insertar las \pmt\ al flujo de transporte. Con el objetivo de mantener exactamente el mismo bitrate, se pueden ubicar en el lugar de paquetes nulos. Para hacer la inserción, es necesario conocer el bitrate de emisión del flujo de transporte y, a su vez, calcular la posición de las inserciones a realizar, dado que la \pmt\ debe aparecer en un período de 200 milisegundos.
	\item Para poner en funcionamiento el sistema se debe modular el flujo de transporte en radiofrecuencia, emitir los flujos elementales por los grupos multicast y puertos adecuados, y consumir todo desde un software de recepción. A continuación se presenta \emph{Mara}, diseñado con este objetivo. 
\end{enumerate}


%----------------------------------------------------------------------------------------------------------
TODO: Al final podemos poner una captura de pantalla de los servicios resultantes.
TODO: Acá podemos poner un paso a paso de los servicios que incluye el transport stream de la frecuencia 527. 
TODO: También podemos pensar en un ejemplo en el que se pasan los servicios a Multicast, por ejemplo, y se libera muchísimo bitrate. Se puede lograr algo así como ``Realocación por eventos''.
%----------------------------------------------------------------------------------------------------------

\section{Software de recepción: Mara}

El siguiente paso en el sistema es construir un software de recepción que sea capaz de capturar al flujo de transporte extendido y reaccionar acordemente. Esto es:

\begin{itemize}
	\item Construir la lista de servicios disponibles.
	\item Identificar aquellos que posean el \emph{Elementaries Relocation Descriptor} asociado.
	\item Asociar el servicio sintonizado por el usuario a los flujos elementales apropiados:
	\begin{itemize}
		\item Si la \pmt\ del servicio no posee el descriptor agregado, el receptor se debe comportar de manera tradicional
		\item Si la \pmt\ sí posee el descriptor asociado, entonces debe unirse al grupo multicast indicado en el mismo y capturar los flujos elementales desde ese medio.
	\end{itemize}
\end{itemize}

Notando que la mayoría de los comportamientos del software de recepción se mantienen igual a uno tradicional, los cambios se aplicarán a un reproductor existente: \emph{Wari}. Llamaremos \emph{Mara} al nuevo reproductor, resultante de la extensión introducida.

\subsection{Construcción de Mara}

Los pasos de modificación del reproductor \emph{Wari} son:

\begin{enumerate}
	\item El sistema debe ser capaz de capturar el descriptor, identificarlo y obtener sus contenidos.
	\item En concordancia con los contenidos del descriptor, se debe modificar el modelo/estdo del sistema.
	\item Finalmente, cuando el usuario sintoniza un servicio, el contenido audiovisual de la reproducción debe ser adquirido del medio correcto. 
\end{enumerate}

\subsection{Obtención y \emph{parsing} del descriptor}

\begin{figure}
\begin{center}

\resizebox{\linewidth}{!}{
\input{diagrams/descriptor_parsing_class_diagram}
}

\caption{Diagrama de Clases de parseo de descriptores en Wari}
\end{center}
\end{figure}

\begin{figure}
\begin{center}

\resizebox{\linewidth}{!}{
\input{diagrams/descriptor_parsing_sequence_diagram}
}
\caption{Diagrama de Secuencia de parseo de descriptores en Wari}
\end{center}
\end{figure}


Se agregó el modelo del descriptor, el descriptor tag y la función de parsing. También ahora el servicio invoca el parser del \emph{Elementaries Relocation Descriptor} en process descriptors.

\subsection{Modificación del modelo}

\begin{figure}
\begin{center}

\resizebox{\linewidth}{!}{
\input{diagrams/wari_service_model_modification}
}
\caption{Detalle de parsing de descriptores en Mara}
\end{center}
\end{figure}

\begin{figure}
\begin{center}

\resizebox{\linewidth}{!}{
\input{diagrams/wari_elem_streams_capture_sequence}
}
\caption{Diagrama de secuencia de captura de flujos elementales en Wari}
\end{center}
\end{figure}


TODO: Explicar cómo funciona la captura de los elementary streams

\begin{figure}
	\begin{center}

		\begin{minipage}{.49\linewidth}
			\centering
			\resizebox{\linewidth}{!}{
			\input{diagrams/mara_elem_streams_capture_sequence}
			}
		\end{minipage}
		\caption{Diagrama de secuencia de captura de flujos elementales en Mara}
	\end{center}
\end{figure}

Se metió un booleano en la clase descriptor, junto a un string que modela el grupo multicast y un short para el puerto. Una crotada básicamente.

\subsection{Reproducción de servicio}

\begin{figure}
\begin{center}

\resizebox{\linewidth}{!}{
\input{diagrams/play_class_diagram}
}
\caption{Diagrama de clases de infraestructura de reproducción en Wari}
\end{center}
\end{figure}

TODO: Diagrama de clases, luego diagrama de secuencia nuevo.

\begin{figure}
\begin{center}

\resizebox{\linewidth}{!}{
\input{diagrams/play_sequence_diagram_wari}
}
\caption{Diagrama de secuencia de infraestructura de reproducción en Wari}
\end{center}
\end{figure}

Si se encuentra que es un servicio relocado, entonces en la URL se manda una dirección IP en vez del URL inventado.

\begin{figure}
\begin{center}

\resizebox{\linewidth}{!}{
\input{diagrams/play_sequence_diagram_mara}
}
\caption{Diagrama de secuencia de infraestructura de reproducción en Mara}
\end{center}
\end{figure}

\section{Emisión multicast de los flujos elementales por IP}

La emisión por multicast IP consiste en el envío de datagramas a múltiples receptores sin la necesidad para el emisor de eviar más de una copia. Siendo que los envíos se realizan sobre el protocolo UDP, no existe protección ante pérdida de paquetes.

El formato MPEG-TS fue diseñado para entornos con pérdidas y errores, entonces resulta adecuado para estas características de transmisión. Sin embargo, existen algunas diferencias con el uso que se le da en televisión digital terrestre:

\begin{itemize}
	\item El bitrate de emisión de una red IP no es necesariamente constante, de modo que los paquetes nulos incurren en un desperdicio de ancho de banda.
	\item Por el mismo motivo, los paquetes no se envian en un flujo constante, si no que pueden ser enviados en ráfagas. 
	\item En el caso de la televisión digital terrestre, cada canal tiene un bitrate independiente y se busca aprovechar cada uno al máximo. En el caso de la transmisión multicast, las vías de transmisión (los grupos multicast) comparten la infraestructura. De modo que la multiplexación de servicios no tiene razón de ser.
\end{itemize}

\ifx\all\undefined
\end{document}
\fi