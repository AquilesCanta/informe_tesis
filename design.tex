\ifx\all\undefined
\include{base}
\begin{document}
\fi
  
\chapter{Desarrollo}

El objetivo de este capítulo es explicar el diseño de un sistema de entrega de televisión digital que integra emisión ISDB-Tb e IPTV. El desarrollo se divide en cuatro secciones:

\begin{itemize}
	\item \textbf{Señalización de los servicios}: Se denominará \emph{señalización} a la entrega de información sobre los servicios para la construcción de la lista y su reproducción. Esta sección abarcará la extensión de ISDB-Tb necesaria para combinar la norma con IPTV.
	\item \textbf{Flujo de transporte de referencia}: Creación de un flujo de transporte que exponga las modificaciones diseñadas en la sección anterior para la norma ISDB-Tb.
	\item \textbf{Emisión multicast de los flujos elementales por IP}: Diseño del método de emisión de IPTV por multicast. Definición del formato contenedor y las características importantes de emisión.
	\item \textbf{Recepción del sistema integrado}: Diseño y desarrollo de un prototipo de recepción del sistema combinado.
\end{itemize}

\section{Señalización de los servicios}

Combinar los sistemas de transmisión implica definir qué servicios viajan por qué medio e indicar esto a los dispositivos de recepción. Usando la infraestructura que actualmente provee la norma ISDB-Tb, sólo es posible señalizar servicios que se encuentran en el mismo flujo de transporte.

Como hipótesis de trabajo, la señalización poseerá las siguientes características:

\begin{itemize}
\item Será centralizada. La información para construir la lista de servicios y sintonizarlos se proveerá por un único medio, evitando redundancia y problemas de inconsistencia de información.
\item Será transparente. El usuario podrá abstraerse del origen de los servicios al consumir alguno de ellos.
\item Estará disponible para todos los dispositivos de recepción, independientemente de la posibilidad de acceso a internet o una red.
\item Hará uso del sistema de señalización que ya provee la norma ISDB-Tb a través del formato MPEG-TS.
\end{itemize}

\subsection{Extensión de ISDB-Tb}

En su estado actual, la norma ISDB-Tb no permite una señalizar servicios que se encuentran fuera del flujo de transporte. Por esto, el desarrollo requiere una extensión de la norma. Para realizar una extensión, los datos introducidos se deben adecuar al formato MPEG-TS, con que ISDB-Tb contenidos a los dispositivos de recepción. La \cref{fig:servicepointing} representa esquemáticamente el comportamiento buscado.

\begin{figure}[]
\begin{center}
\includegraphics[width=13cm]{imgs/cable_flujo_c23_extendido.png}
\caption{Diagrama de un flujo de transporte con señalización a dos servicios\label{fig:servicepointing}}
\end{center}
\end{figure}

Las extensiones deben introducirse al formato flujo de transporte. El objetivo es posibilitar la indicación al receptor de la existencia de un servicio cuyos flujos elementales deben ser obtenidos por medio de una red IP, en emisión multicast, identificada por una IP de grupo y un puerto.

En el caso normal, para que un receptor reconozca un servicio y lo incluya a su lista de servicios disponibles, debe encontrar una entrada correspondiente en la \sdt. Luego, para sintonizarlo, debe filtrar una \pat\ para luego filtrar la \pmt, que le indica la forma de encontrar los flujos elementales. En el \emph{loop} de flujos elementales, se incluyen aquellos que deben ser obtenidos desde el mismo flujo de transporte. Siendo que estos no se incluyen, este \emph{loop} viajará vacío.

En este punto es imposible indicar que los mismos vienen por un medio distinto que el flujo de transporte. La extensión tiene por objetivo permitir que la \pmt\ indique al receptor la búsqueda de flujos elementales en un grupo multicast.

La extensión no debería modificar la estructura propia de la tabla, porque podría implicar que un receptor estándar no sería capaz de interpretar los contenidos, independientemente de la ubicación de los flujos elementales. En consecuencia, la extensión de incorporarse en forma de descriptor.

\subsection{\emph{Elementary streams relocation descriptor}}

Siguiendo el segundo de los principios de diseño \textbf{SOLID}(\emph{Open/Closed Principle})\cite{openclosed}, es útil para el desarrollo evitar modificar el formato MPEG-TS tanto como sea posible, sino extenderlo. Entonces, se busca agregar los comportamientos por medio de entidades nuevas en lugar de modificar las existentes.

Para señalizar nuevos servicios cuyos flujos elementales se deben obtener desde una red IP, definiremos un nuevo descriptor de acuerdo al formato \textbf{MPEG-TS}. Lo llamaremos \emph{Elementary Streams Relocation Descriptor}. 

Éste descriptor sólo puede hallarse (de forma opcional) en la \pmt\ e implica que el servicio correspondiente a la tabla posee las características mencionadas. Esto es, sus flujos elementales se emiten por multicast.

El \emph{Elementary Streams Relocation Descriptor} tiene asignado el \emph{descriptor\_tag} 170. No existe, actualmente, un descriptor en el formato MPEG-TS con el mismo nombre o \emph{descriptor\_tag} o semántica similar.

Para que el receptor sea capaz de obtener los flujos elementales, es necesario identificar el grupo multicast y el puerto por el que se envían los flujos. Para esto, es necesario proveer a través del descriptor esta información.

La \cref{tab:descsyntax} define la sintaxis del descriptor:

\begin{table}[H]
\begin{center}
\resizebox{\linewidth}{!}{
	\begin{tabular}{ | l | c | c | c | c |} 
	\hline
	Elemento                   			& Rango de valores            & Cantidad de bits & Bit de comienzo & mnemotécnico\tablefootnote{Sigla que identifica al tipo del campo; comúnmente utilizada en documentos de especificación de sintaxis.}	\\
	\hline 
	\hline
	\emph{descriptor\_tag}     			& 170                         & 8        		& 0 		&	\textbf{uimsbf}\tablefootnote{\textbf{uimsbf} significa \emph{unsigned integer, most significant bit first}. Lo cual significa \emph{entero sin signo, bit más significativo primero}.}  \\ 
	\emph{descriptor\_length}  			& 6                           & 8        		& 8			& 	\textbf{uimsbf}  \\
	\textbf{Grupo Multicast}            & 3758096384 -- 4026531839    & 32       		& 16		&	\textbf{uimsbf}	\\
	\textbf{Puerto}                     & 1 -- 65535                  & 16      		& 48   		&	\textbf{uimsbf}  \\
	\hline 
	\end{tabular}
}
\caption{Sintaxis del \emph{Elementary Streams Relocation Descriptor}\label{tab:descsyntax}}
\end{center}
\end{table}

Descripción de los elementos:
\begin{itemize}
\item \emph{descriptor\_tag}: Elemento requerido por la definición sintáctica de los descriptores. Lleva el valor 170 para identificar al \emph{Elementary Streams Relocation Descriptor} en el \emph{descriptor loop}.
\item \emph{descriptor\_length}: Elementor requerido por la definición sintáctica de los descriptores. El \emph{Elementary Streams Relocation Descriptor} tiene una longitud fija de 8 bytes. De modo que este campo siempre lleva el valor 6 (no incluye los primeros dos campos del descriptor).
\item \textbf{Grupo Multicast}: Grupo Multicast al que se debe unir el receptor para capturar los flujos elementales del servicio al que está asociada la PMT en la que viaja este descriptor. El rango de valores se debe a que las direcciones IP asignadas a los grupos multicast se hallan en el rango 224.0.0.0 -- 239.255.255.255. Estas direcciones IP codificadas en \emph{big-endian} (el byte más significativo en la menor dirección de memoria) resultan en esos valores.
\item \textbf{Puerto}: El puerto al cual se realiza la emisión. Son dos bytes codificados en \emph{big-endian}. Cabe notar que el valor 0 representa un número de puerto inválido.
\end{itemize}

A modo de ejemplo, si se desea indicar que los flujos elementales de un servicio viajan por el grupo multicast 239.1.1.1 y puerto 10000, se debe incluir el siguiente \emph{Elementary Streams Relocation Descriptor} en la \pmt\ del servicio. Nótese que el descriptor tiene una longitud fija de 8 bytes, contando campos obligatorios de \emph{descriptor\_tag} y longitud.


\begin{table}[H]
\begin{center}
\begin{tabular}{ | l | c | c | c | } 
\hline
Elemento                   			& Significado del contenido 	& Contenido real(Decimal)			& Contenido real(Hexadecimal) 	\\
\hline 
\hline
\emph{descriptor\_tag}     			& 170                        	& 170       						& 0xAA       					\\
\emph{descriptor\_length}  			& 6                           	& 6        							& 0x06       					\\
\textbf{Grupo Multicast}            & 239.1.1.1    					& 4009820417       					& 0xEF010101      				\\
\textbf{Puerto}                     & 10000                  	    & 10000       						& 0x2710      					\\
\hline 
\end{tabular}
\caption{Ejemplo de uso del \emph{Elementary Streams Relocation Descriptor}\label{tab:descexample}}
\end{center}
\end{table}

\begin{table}[H]
\begin{center}
\begin{tabular}{ | l | r | r | r | r | r | r | r | r | } 

\hline
\textbf{Byte}				& 0 	& 1 	& 2 	& 3 	& 4 	& 5 	& 6 	& 7  \\
\hline 
\textbf{Valor del byte}		& 0xAA	& 0x06	& 0xEF	& 0x01 	& 0x01 	&0x01 	& 0x27 	& 0x10 \\
\hline 
\end{tabular}
\caption{Volcado de contenido (hexadecimal) del ejemplo de uso del \emph{Elementary Streams Relocation Descriptor}\label{tab:descexamplebinary}}
\end{center}
\end{table}

\section{Flujo de transporte de referencia}

El flujo de transporte de una señal ISDB-Tb es una sequencia de bits organizada por el formato MPEG-TS. En el caso de la emisión de televisión digital, parte del proceso se realiza en tiempo real, al momento de multiplexar varios servicios que provienen de distintos orígenes, para luego modular la señal a emitir.

En el caso del flujo de transporte de referencia para este desarrollo, éste se volcará en un archivo para su persistencia. Los flujos de transporte se persisten representando los paquetes en secuencia, donde cada uno es un fragmento de 188 bytes, que se podría volcar aisladamente, de ser necesario. Así, una tabla que ocupa un único paquete se persiste como un archivo de 188 bytes.

Para las tablas que deben ser construidas, que señalizan los servicios, se utilizará OpenCaster. Dado que aún no posee soporte para el \emph{Elementary Streams Relocation Descriptor}, parte del desarrollo necesario es una extensión al proyecto. La misma se explica a continuación.

%
% OpenCaster extension
% % % % % % % % % % % % % % % % % % % % % % % % % % % %


\subsection{Extensión de OpenCaster}

Para facilitar la construcción de las estructuras de MPEG-TS, se realizó una extensión a OpenCaster. La versión actual ya cuenta con funcionalidad para representar la mayoría de las entidades del estándar ISDB-Tb. La extensión le permite a la herramienta reconocer el descriptor \emph{Elementary Streams Relocation Descriptor}, como si fuera parte del estándar, para así incluirla en la \pmt, de igual manera que con cualquier otro descriptor.

La \cref{fig:opencastermodif} incluye un diagrama de clases que explica la jerarquía de descriptores de OpenCaster, incluyendo el nuevo descriptor.

\begin{figure}[]
\begin{center}
\resizebox{0.5\linewidth}{!}{
\input{diagrams/open_caster_modif}
}
\caption{Diagrama de Clases de OpenCaster con el nuevo descriptor\label{fig:opencastermodif}}
\end{center}
\end{figure}

OpenCaster presenta una jerarquía de clases para modelar las entidades \textbf{MPEG-TS} que se incluyen en un flujo de transporte. El formato reserva lugar para la extensíón por parte de privados. Al igual que otros estándares, ISDB-T introduce algunas entidades al formato \textbf{MPEG-TS}, como tablas y descriptores.

La extensión consiste en la creación de la clase ``service\_elementaries\_relocation\_descriptor'', que hereda de \texttt{Descriptor}, como se muestra en \cref{fig:opencastermodif}.

El \emph{Elementary Streams Relocation Descriptor} se modela con una clase con dos variables de instancia. Una asociada al grupo multicast y la segunda asociada al puerto. Definiendo el método \texttt{bytes}, la clase luego se empaqueta en la estructura sintáctica definida anteriormente.

Posteriormente se proveen ejemplos de utilización de esta clase, en el \cref{lst:pmtopencaster}.

\subsection{Extensión del flujo de transporte de Canal 23}

La construcción de un flujo de transporte completo escapa al objetivo de este informe [TODO: Apéndice o referencia a Liendo]. Para la conformación del flujo de transporte de referencia se utilizará el ejemplo de canal 23, al cual se le incorporarán dos servicios. La \cref{fig:extended23} presenta un esquema del flujo de transporte resultante esperado.

\begin{figure}[h]
	\begin{center}
	\includegraphics[width=14cm]{imgs/canal_23_extended_tables.png}
	\caption{Esquema del flujo de transporte de Canal 23 extendido\label{fig:extended23}} 
	\end{center}
\end{figure}

El flujo de transporte base posee tres servicios servicios: ``TV Pública HD'', ``Tecnópolis'' y ``TV Pública''. A éstos se le añadirán dos, cuyos flujos elementales serán emitidos a través de dos grupos multicast distintos.

Para empezar es importante definir cuáles son los nuevos servicios que se van a agregar. A fines ilustrativos, llamaremos a estos servicios ``TV Universidad'' y ``TV La Plata''. Los pasos de adición de los servicios se explican a continuación.

\subsubsection{Adición de servicios a \sdt}

Por cada servicio que se busca agregar a un flujo de transporte, es necesario agregar un \emph{service\_descriptor} a la \sdt. Éste descriptor posee la siguiente información:

	\begin{enumerate}
		\item \emph{service\_id} del servicio.
		\item Nombre del servicio.
		\item Tipo del servicio (en general, 1, correspondiente a televisión digital).
	\end{enumerate}

Los nombres de los servicios que contendrá la nueva \sdt\ son ``TV Pública HD'', ``Tecnópolis'', ``TV Pública'', ``TV Universidad'', y ``TV La Plata''. Los primeros tres pertenecen aquellos servicios que ya se encontraban en el flujo de transpore. Los últimos dos son aquellos que extienden la lista a través del \emph{Elementary Streams Relocation Descriptor}.

Los tipos de servicio se conservan en los servicios anteriores, mientras que los agregados son servicios de TV digital, a los cuales les corresponde el tipo 1.

Finalmente, la información se debe asignar a un \emph{service\_id}. Los servicios que ya se encontraban conservan los que tenían, que son 59201, 59224 y 59202. En el caso de los nuevos servicios es necesario asignarles uno. La única limitación que existe para elegir este número es que no haya sido ocupado por algún otro servicio en el mismo flujo de transporte o ser 0.

Los \emph{service\_id} serán: 60000 para ``TV Universidad'' y 60001 para ``TV La Plata''. El \cref{lst:sdtopencaster} contiene el script \emph{Python} utilizado en la creación de la \sdt\ del flujo de transporte de referencia.

\lstinputlisting[language=Python,caption={Creación de SDT en OpenCaster}]{src_code/sdt_gen.py}\label{lst:sdtopencaster}

\subsubsection{Adición de servicios a la \pat}

La \pat\ es asigna PID's a las \pmt\ de los servicios del flujo de transporte. Habiendo ya definido los \emph{service\_id}, sólo resta definir los \pid s. En el caso de los \pid\, es importante cuidar que no se utilice un número de \pid\ reservado o utilizado por alguna otra componente del flujo. Se incluye una lista en el apéndice [TODO: Apéndice de los pids reservados].

Los \pid\ asignados a las \pmt\ serán 1000 para ``TV Universidad'' y 1001 para ``TV La Plata''.

\lstinputlisting[language=Python,caption={Creación de PAT en OpenCaster}]{src_code/pat_gen.py}\label{lst:patopencaster}

\subsubsection{Inserción de \pmt's nuevas}

Como son dos los servicios a agregar al flujo de transporte, es necesario crear dos \pmt. Una por cada uno. Las \pmt\ de los servicios que ya existen se conservarán intactos. 

Ya se definieron los \pid\ y \emph{service\_id} de los servicios nuevos. El único elemento restante es el \emph{Elementary Streams Relocation Descriptor} (siendo que el \emph{loop} de flujos elementales se mantiene vacío). Éste, a su vez, debe incluir grupo multicast y puerto por los que se emiten los flujos elementales. El uso del nuevo descriptor se puede observar en las líneas 5 y 17 del \cref{lst:pmtopencaster}.

Asignaremos el grupo 239.1.1.1 a ``TV Universidad'' y 239.1.1.2 a ``TV La Plata''. Ambos por puerto 1000.

\lstinputlisting[language=Python,caption={Creación de PMT's en OpenCaster}]{src_code/pmt_gen.py}\label{lst:pmtopencaster}

\subsubsection{Multiplexación}

Finalmente, sólo resta multiplexar el nuevo flujo de transporte. Una posibilidad es extraer todos los servicios del flujo de transporte y remultiplexarlo, intercalando las nuevas tablas en el intervalo adecuado. Sin embargo existe una solución más simple.

Las tablas generadas con los script incluidos poseen la característica de ocupar un único paquete. Por eso, es posible reemplazaar las antiguas \sdt\ y \pat\ por las nuevas, generadas con OpenCaster. La \pmt\ por otro lado, introduce un inconveniente. Las dos nuevas \pmt\ no se encuentran en el flujo de transporte original, e insertarlas en el medio, implica desplazar todos los paquetes siguientes una posición cada vez que se inserta. Esto incurre en una modificación del bitrate y la consecuente degradación de los servicios.

Con el objetivo de mantener exactamente el mismo bitrate, se pueden ubicar en el lugar de paquetes nulos, reemplazándolos. Para hacer la inserción, es necesario conocer el bitrate de emisión del flujo de transporte y, a su vez, calcular la posición de las inserciones a realizar, dado que la \pmt\ debe aparecer en un período de 200 milisegundos.

Para realizar estas tareas se utilizará la librería \emph{ts\_util}\cite{tsutil} desarrollada específicamente para este trabajo. Incluye varias herramientas. En la multiplexación intervienen \texttt{packet\_replacer}(reemplaza los paquetes de un flujo de transporte de un PID definido por otro) y \texttt{packet\_inserter}(inserta un paquete en un flujo de transporte en el lugar de un paquete nulo, a fin de que aparezca en un período dado).

\lstinputlisting[language=bash,caption={Multiplexación a través de \emph{ts\_util}}]{src_code/mux.sh}\label{lst:tsutilmux}

El \cref{lst:tsutilmux} incluye las líneas utilizadas en la multiplexación final del flujo de transporte de referencia. La línea ...

TODO: detallar el proceso de multiplexación y poner unos listings que expliquen cómo se reemplazan e insertan las tablas con tsutil, etc.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% IPTV
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Emisión multicast de los flujos elementales por IP}

La emisión por multicast IP consiste en el envío de datagramas a múltiples receptores sin la necesidad para el emisor de eviar más de una copia. Siendo que los envíos se realizan sobre el protocolo UDP, no existe protección ante pérdida de paquetes.

El formato MPEG-TS fue diseñado para entornos con pérdidas y errores, entonces resulta adecuado para estas características de transmisión. Sin embargo, existen algunas diferencias con el uso que se le da en televisión digital terrestre:

\begin{itemize}
	\item El bitrate de emisión de una red IP no es estrictamente constante, de modo que los paquetes nulos incurren en un desperdicio de ancho de banda.
	\item Por el mismo motivo, los paquetes no se envian en un flujo constante, si no que pueden ser enviados en ráfagas. 
	\item En el caso de la televisión digital terrestre, cada canal tiene un bitrate independiente y se busca aprovechar cada uno al máximo. En el caso de la transmisión multicast, cada servicio se puede enviar un un grupo distinto, para ahorrar el ancho de banda utilizado por cada usuario. Por esto, la multiplexación de servicios no tiene razón de ser.
\end{itemize}

La \cref{fig:servicepointingwithts} presenta un esquema similar a la \cref{fig:servicepointing}, con el agregado de emitir los flujos elementales en formato MPEG-TS.   

\begin{figure}[h]
	\begin{center}
		\includegraphics[width=13cm]{imgs/cable_flujo_c23e_ts.png}
		\caption{Diagrama de un flujo de transporte con señalización a dos servicios, emitidos con formato de flujo de transporte.\label{fig:servicepointingwithts}}
	\end{center}
\end{figure}

Existe un gran número de herramientas para la realizar la emisión de los flujos elementales. En este trabajo se ha utilizado la herramienta \texttt{packet\_streamer}, también incluída en el proyecto \emph{ts\_util}\cite{tsutil}, desarrollado con él propósito de asistir en el desarrollo del prototipo de sistema descripto en este informe.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% Recepción
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Recepción del sistema integrado}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% MODULACION
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{itemize}
	\item Una señal ISDB-Tb extendida modulada sobre el espectro radioeléctrico. La infraestructura de hardware y software requerida para esta tarea no cambia respecto a una emisión ISDB-Tb común.
	\item Emisión de flujos elementales de los servicios a través de un grupo multicast en una red IP manejada.
	\item Un software capaz de recibir la señal ISDB-Tb, y capturar los flujos elementales cuando el usuario sintoniza un servicio que lo requiere.
\end{itemize}

La última componente del sistema concierne a la recepción. A continuación se introduce \emph{Mara}, una modificación de \emph{Wari} que es capaz de consumir el \emph{Service Elementaries Relocation Descriptor} y entregar la lista extendida completa de servicios de un flujo de transporte con el descriptor. 

%----------------------------------------------------------------------------------------------------------
TODO: Al final podemos poner una captura de pantalla de los servicios resultantes.
TODO: Acá podemos poner un paso a paso de los servicios que incluye el transport stream de la frecuencia 527. 
TODO: También podemos pensar en un ejemplo en el que se pasan los servicios a Multicast, por ejemplo, y se libera muchísimo bitrate. Se puede lograr algo así como ``Realocación por eventos''.
%----------------------------------------------------------------------------------------------------------

El desarrollo de Mara se ubica sobre Wari aprovechando la absoluta mayoría de funcionalidades que no sufren cambios respecto a ISDB-Tb tradicional. Específicamente, Mara se comporta de manera idéntica a Wari cuando consume un flujo de transporte regular.





El siguiente paso es construir un prototipo de software de recepción que sea capaz de capturar el flujo de transporte extendido y reaccionar acordemente. Esto es:

\begin{itemize}
	\item Construir la lista de servicios disponibles.
	\item Identificar aquellos que posean el \emph{Elementary Streams Relocation Descriptor} asociado.
	\item Asociar el servicio sintonizado por el usuario a los flujos elementales apropiados:
	\begin{itemize}
		\item Si la \pmt\ del servicio no posee el descriptor agregado, el receptor se debe comportar de manera corriente.
		\item Si la \pmt\ sí posee el descriptor asociado, entonces debe unirse al grupo multicast indicado en el mismo y capturar los flujos elementales desde ese medio.
	\end{itemize}
\end{itemize}

La \cref{fig:maraflowdiag} presenta un diagrama de flujo para la reproducción de servicios con la inclusión de la nueva funcionalidad.

\begin{figure}[h]
	\begin{center}
		\includegraphics[height=\textheight]{imgs/play_flow_diagram_mara.png}
		\caption{Diagrama de flujo modificado para la recepción del \emph{Elementary Streams Relocation Descriptor}.\label{fig:maraflowdiag}}
	\end{center}
\end{figure}


\subsection{Construcción de Mara}

Las modificaciones a realizar sobre el reproductor \emph{Wari} se agrupan en tres responsabilidades distintas:

\begin{enumerate}
	\item \textbf{Modificación del modelo de servicios}: Para empezar, Mara debe se capaz de modelar los servicios cuyos flujos elementales llegan desde una red IP. Para esto, se debe extender la lista de atributos de la clase \texttt{Service} de Wari.
	\item \textbf{Parsing del descriptor}: El sistema debe ser capaz de capturar el descriptor, identificarlo y obtener sus contenidos. Estos contenidos, luego, deben verse reflejados en el estado del sistema, sobre las modificaciones del ítem anterior.
	\item \textbf{Reproducción}: Finalmente, cuando el usuario sintoniza un servicio, el contenido audiovisual de la reproducción debe ser adquirido del medio correcto, usando la información guardada en el model de la clase \texttt{service}. 
\end{enumerate}

%--------------------------------------------------------------------------------
% Modificación del modelo
%--------------------------------------------------------------------------------

\subsubsection{Modificación del modelo}

El diagrama de clases presentado en la \cref{fig:classdiagramservices} presenta el modelo de los servicios de Wari, a través de la clase \texttt{Service}. Es necesario agregar 3 atributos para representar de manera simple la característica de los servicios de poseer flujos elementales fuera del flujo de transporte. Esto se refleja en la \cref{fig:classdiagramserviceext}. 

\begin{figure}[H]
	\begin{center}

		\resizebox{\linewidth}{!}{
		\input{diagrams/mara_service_class}
		}
		\caption{Modelo del servicio en Mara\label{fig:classdiagramserviceext}}
		
	\end{center}
\end{figure}

En la figura se resaltan las tres nuevas variables de instancia de la clase.

\begin{itemize}
	\item \texttt{\_isRelocatedService}: Valor \emph{booleano}\footnote{Tipo que posee únicamente dos valores posibles que intentan denotar los valores lógicos de verdad y falsedad, generalmente denominados \emph{verdadero}(o \emph{true}) y \emph{falso}(o \emph{false}).} que establece si los flujos elementales del servicio deben obtenerse desde una red IP o no.
	\item \texttt{\_multicastRelocatedGroup}: Dirección IP que identifica el grupo multicast de la emisión de flujos elementales pertenecientes al servicio.
	\item \texttt{\_multicastRelocatedPort}: Puerto destino de los datagramas UDP por los que viajan los paquetes TS\footnote{Denominación común a los paquetes de un flujo de transporte.} que transportan las partes de los flujos elementales.
\end{itemize}

TODO: Agregar getters y setters y emprolijarlo a la mierda.

%--------------------------------------------------------------------------------
% Parsing del descriptor
%--------------------------------------------------------------------------------

\subsubsection{Parsing del descriptor}

En detalle, el \emph{parsing} de descriptores en Mara implica los siguientes cambios en Wari:

\begin{itemize}
	\item Cuando en el \emph{loop} de descriptores se halla el \emph{descriptor\_tag} 170, se debe invocar a la función que interpreta el contenido.
	\item Este contenido se debe invocar a un modelo en memoria del descriptor, un registro.
	\item El servicio debe ser modificado acordemente, modificando su estado a partir del registro que representa al descriptor.
\end{itemize}


\begin{figure}[h]
\begin{center}

\resizebox{\linewidth}{!}{
\input{diagrams/wari_service_model_modification}
}
\caption{Detalle de parsing de descriptores en Mara}
\end{center}
\end{figure}

TODO: Dividirlo en secciones e incluir listings para cada parte.


\lstinputlisting[language=C++,caption={Captura de \emph{Elementary Streams Relocation Descriptor} en Mara}]{src_code/desc_capture.cpp}\label{lst:desccapture}

Y acá a bajo el parser.

\lstinputlisting[language=C++,caption={\emph{Parsing} de \emph{Elementary Streams Relocation Descriptor} en Mara}]{src_code/desc_parse.cpp}\label{lst:descparse}


Y listo. Nada más.




%--------------------------------------------------------------------------------
% Modificación de la reproducción
%--------------------------------------------------------------------------------

\subsubsection{Reproducción}


Recolectar los flujos elementales implica solicitar al dispositivo de sintonización que filtre los paquetes de acuerdo a su \pid. No obstante, esto corresponde sólamente cuando es necesario demultiplexar servicios de un flujo e interviene un dispositivo sintonizador. En el caso de recepción de un flujo por IP, este paso puede omitirse.

A partir de los \pid\ filtrado, las clases de demultiplexación construyen un URL de reproducción. Cuando se halla el \emph{Elementary Streams Relocation Descriptor}, esta URL debe ser reemplzada por la obtenida desde el descriptor.

\begin{figure}[h]
\begin{center}

\resizebox{\linewidth}{!}{
\input{diagrams/play_sequence_diagram_mara}
}
\caption{Diagrama de secuencia de infraestructura de reproducción en Mara, para servicio con \emph{Elementary Streams Relocation Descriptor}}
\end{center}
\end{figure}

\lstinputlisting[language=C++,caption={Construcción de URL de reproducción en Mara}]{src_code/mara_play.cpp}\label{lst:maraplay}


\ifx\all\undefined
\end{document}
\fi

