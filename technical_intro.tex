\ifx\all\undefined
\include{base}
\begin{document}
\fi
\chapter{Introducción técnica}

La Televisión Digital(TVD) es un servicio innovador que significa la mayor revolución tecnológica en el rubro televisivo desde la televisión a color en la década del '50. El término \textbf{Televisión Digital} define la transmisión de audio y video a través de una señal procesada y multiplexada digitalmente, en contrapartida con la señal analógica utilizada por la \emph{televisión analógica}, antecesora de la primera. Muchos países continúan hoy en día reemplazando la televisión analógica por televisión digital, haciendo un mejor y más variado uso del espectro de radiofrecuencia.

Las ventajas de la televisión digital por sobre la analógica son numerosas:
\begin{enumerate}
	\item Exhibe una mejor calidad de sonido e imagen.
	\item Permite contenidos en alta definición.
	\item Posibilita la multiprogramación, dado que permite la transmisión de varias señales en el mismo ancho de banda asignado a la emisora. Esta es una diferencia sustancial respecto de la correspondencia unívoca entre servicio y canal de radiofrecuencia de la televisión analógica.
	\item Permite que un mismo servicio provea varios flujos distintos de un mismo tipo. Por ejemplo, para transmitir una película con audio en varios idiomas.\footnote{La televisión analógica utiliza técnicas (como \emph{Second Audio Program}) para la emisión de dos alternativas de audio o \emph{closed caption}. No obstante, no se puede hablar de multiplicidad de flujos, dado que se limita a tipos específicos de flujos y, en general, a dos alternativas.}
	\item Permite brindar servicios complementarios, como aplicaciones interactivas y guía electrónica de programación.
	\item Ahorra ancho de banda. Es posible transmitir más servicios en el mismo ancho de banda.
	\item Permite brindar servicios a una mayor cantidad de dispositivos, como teléfonos celulares, computadoras portátiles, o GPS's con sintonizador. Esto se conoce como \emph{producción para multiplataforma}. Un mismo servicio se puede reproducir en distintos dispositivos, con diferentes soportes de resolución.
\end{enumerate}

\section{Conceptos Preliminares}\label{sec:concep_prelim}

La televisión digital utiliza \emph{bits} para codificar tanto contenidos audiovisuales como metainformación. Las señales digitales pueden ser canalizadas por distintos medios y viajar con distintos formatos. Los principales tipos de televisión digital son (ver \cite{liendo}):
\begin{itemize}
\item Terrestre: Emite la señal a través del espectro de radiofrecuencia de la atmósfera terrestre sobre las bandas UHF\footnote{\emph{Ultra High Frequency}: designación del \emph{Iternational Telecommunication Union} para las frecuencias que oscilan entre los 300MHz y 3GHz}.
\item Satelital: Consiste en retransmitir desde un satélite una señal emitida desde un punto en la Tierra utilizando SHF\footnote{\emph{Super High Frequency}: designación del \emph{Iternational Telecommunication Union} para las frecuencias que oscilan entre los 3GHz y 30GHz}. 
\item Cable: Utilizan la señal propagada por redes de cable coaxial o fibra óptica.
\item \emph{Internet Protocol Television}(IPTV): El término ha adquirido múltiples significados con el crecimiento de las tecnologías. La \emph{International Telecommunication Union}\cite{ituiptv} define al término de la siguiente manera:

\begin{definition}
	IPTV define a la entrega de servicios como televisión/video/audio/texto/imágenes/datos sobre redes basadas en IP manejadas para proveer el nivel requerido de calidad de servicio y experiencia, seguridad, interactividad y confiabilidad.\label{def:iptv}
\end{definition}
% IPTV is defined as multimedia services such as television/video/audio/text/graphics/data delivered over IP based networks managed to provide the required level of quality of service and experience, security, interactivity and reliability.

\item \emph{Over the Top}(OTT): Consiste en la transmisión de televisión por internet. A diferencia de IPTV, al no utilizar una red manejada, no presenta garantías de calidad de servicio.
\end{itemize}

%TODO: Podemos agregar la categoría WebTV (OTT). Y explicar en qué se diferencia de IPTV, en el alcance de este informe.

Las primeras dos categorías se denominan \emph{de radiodifusión}, dado que utilizan el espectro radioeléctrico en emisión \emph{broadcast}. La televisión digital terrestre y satelital se encuentran rigurosamente legisladas y reguladas en todos los países del mundo\cite{liendotodospaisesdelmundo}. En el caso particular de la televisión digital terrestre, hay cuatro estándares ampliamente adoptados:

\begin{itemize}
\item \emph{Terrestrial Integrated Services Digital Broadcasting (ISDB-T)}: Adoptado en Japón y las islas Filipinas. \textbf{ISDB-T International} (también denomiado \textbf{ISDB-Tb)} es una adaptación de este estándar que ha sido aplicada en gran parte de sudamérica. 
\item \emph{Digital Video Broadcasting-Terrestrial (DVB-T)}: Estándar adoptado en Europa, Australia y Nueva Zelanda. 
\item \emph{Advanced Television System Committee (ATSC)}: Estándar adoptado en Estados Unidos, Canadá, México, Corea del Sur, República Dominicana y Honduras.
\item \emph{Digital Terrestrial Multimedia Broadcasting (DTMB)}: Estándar adoptado en la República Popular de China, incluyendo Hong Kong y Macao.
\end{itemize} 

\section{ISDB-Tb}

\textbf{ISDB-Tb} (o ISDB-T Internacional) es un estándar de transmisión de televisión digital terrestre. Fue desarrollado originalmente por la Asociación de Empresas e Industrias de Radio(ARIB\cite{arib}) del Japón y, posteriormente, incluyó modificaciones propuestas por la Asociación Brasileña de Normas Técnicas\cite{abnt}. Es la norma de televisión digital adoptada en Argentina y utilizada en la Televisión Digial Abierta (TDA\cite{tda}).

La televisión terrestre envía información a través del espectro de radiofrecuencia de la atmósfera que oscila entre los 300Mhz y los 3GHz. Al ser éste un fenómeno físico intrínsecamente analógico, la información digital que se desea transmitir se codifica por medio de variaciones de amplitud y fase de la señal. Estas variaciones se denominan \textbf{modulación}. ISDB-Tb permite utilizar varios parámetros de modulación distintos.

Por encima de la capa de codificación de la información digital o modulación de bits, la norma define una forma de organización de los bytes. Ésta organización compone lo que se denomina \emph{formato contenedor}. En el caso de ISDB-Tb, el formato contenedor de la transmisión es el \textbf{Flujo de Transporte MPEG} (\emph{MPEG Transport Stream}), definido en MPEG-2 ISO/IEC standard 13818. Es este formato el que permite la multiplexación de servicios y flujos multimedia en una misma señal de radiofrecuencia. Por supuesto, aprovechando la efectividad de las técnicas avanzadas de modulación de información digital.

\subsection{Modulación y bitrate disponible}

En la norma ISDB-Tb, el espectro de radiofrecuencia se divide en canales físicos de 6 MHz (denominados \emph{bandas UHF}) por los que viaja un flujo multiplexado de servicios, que denominaremos ``flujo de transporte''. Cada uno de estos canales físicos dispone de un \emph{bitrate} constante definido por los parámetros de modulación de la señal. La capacidad máxima de transmisión del sistema \textbf{ISDB-Tb} es de unos 23 Mbps\cite{liendo} que debe distribuirse entre los contenidos a transmitir.

\begin{figure}[h!]
	\begin{center}
	\includegraphics[width=8cm]{imgs/canal_fisico.png}
	\caption{Diagrama esquemático de un flujo de transporte} 
	\end{center}
\end{figure}

La limitación de bitrate de los canales físicos establece una cota superior para el número se servicios que puede transportar, dependiendo ulteriormente del ancho de banda requerido por los mismos. Cada servicio está compuesto a su vez por flujos más pequeños que llevan audio, video u otras componentes.

\begin{figure}[h!]
	\begin{center}
	\includegraphics[width=12cm]{imgs/cable_flujo_mpeg.png}
	\caption{Composición de servicios en un flujo de transporte} 
	\end{center}
\end{figure}

Para ejemplificar, un fragmento de la señal emitida por el canal 23 (frecuencia 527 Mhz) de la Televisión Digital Abierta Argentina del 5 de Junio de 2013 dispone de un ancho de banda de 17,3 Mbps. Presenta 3 servicios: TV Pública HD(un video HD, dos audios), Tecnópolis(un video SD, un audio) y TV Pública(un video LD, un audio). El bitrate promedio para estos videos se presenta en \cref{tab:avgbitrates}.

\begin{table}[H]
\begin{center}
\resizebox{\linewidth}{!}{
	\begin{tabular}{| l | c | c | c |}
	\hline 
	\textbf{Nombre del servicio} & \textbf{Tipo de video} & \textbf{\begin{tabular}[x]{@{}c@{}}Bitrate promedio\\utilizado\end{tabular}} & \textbf{\begin{tabular}[x]{@{}c@{}}Porcentaje del bitrate\\del flujo utilizado\end{tabular}}\\
	\hline 
	TV Pública HD & \emph{High Definition Video} & 11,7 Mbps & 67,7\% \\
	\hline
	TV Pública & \emph{Low Definition Video} & 0,3 Mbps & 1,9\% \\
	\hline
	Tecnópolis & \emph{Standard Definition Video} & 2,0 Mpbs & 11,7\% \\
	\hline
	\hline
	\textbf{Total:} & --- & 14 Mbps & 81,3\% \\
	\hline 
	\end{tabular}
}
\caption{Utilización de bitrate por el video en el ejemplo de Canal 23\label{tab:avgbitrates}}
\end{center}
\end{table}

La \cref{tab:avgbitrates} indica el bitrate promedio utilizado por los videos, sumando un total de 14Mbps. Dado que el bitrate disponible total es de 17,3 Mbps, resta indicar en qué se utilizan 3.3 Mbps(18,7\%) del ancho de banda siendo que, como se ha mencionado, el mismo es constante en la norma ISDB-Tb. Los audios toman un \emph{bitrate} promedio de $0,4$ Mbps entre los 4. La información requerida por el flujo de transporte para ser demultiplexable y utilizable por un decodificador comprende un $0,4\%$ del \emph{bitrate} total(unos $0,07 Mbps$). La guía electrónica de programación, por otro lado, ocupa casi el doble, con un $0,7\%$ del ancho de banda total. 

Cuando el contenido de un flujo de transporte no llega a cubrir el ancho de banda disponible del canal físico, el emisor debe completar con contenido \emph{dummy} que el receptor debe ignorar. Este contenido se compone de \emph{paquetes nulos}. De modo que en la muestra utilizada por el ejemplo anterior, un promedio de $2,4$ Mbps son llenados con paquetes nulos. Contenidos con la finalidad de completar el bitrate disponible.

Considerando los promedios del ejemplo, podría pensarse en la posibilidad de agregar un servicio LD sin riesgo de que falte bitrate. No obstante, es importante tener en mente que las magnitudes presentes son calculadas por promedio. En el caso del servicio HD, el video alcanza los $24$ Mbps, por momentos. Por la variabilidad del bitrate de los contenidos multimedia, es necesario que la suma de los bitrate promedio sea inferior al bitrate total si se busca una calidad estable en los servicios. 

% +---------------+---------------+---------------+---------------+
% |PID            |Bytes          |Percentage     |Mbps           |
% +---------------+---------------+---------------+---------------+
% |0              |280496         |            0.0|            0.0| PAT
% +---------------+---------------+---------------+---------------+
% |16             |28012          |            0.0|            0.0| NIT
% +---------------+---------------+---------------+---------------+
% |17             |13912          |            0.0|            0.0| SDT
% +---------------+---------------+---------------+---------------+
% |18             |2308264        |            0.7|            0.1| EIT
% +---------------+---------------+---------------+---------------+
% |20             |5640           |            0.0|            0.0| TOT
% +---------------+---------------+---------------+---------------+
% |36             |28012          |            0.0|            0.0| 
% +---------------+---------------+---------------+---------------+
% |39             |41736          |            0.0|            0.0|
% +---------------+---------------+---------------+---------------+
% |258            |280496         |            0.0|            0.0| PMT del servicio 59201
% +---------------+---------------+---------------+---------------+
% |259            |280496         |            0.0|            0.0| PMT del servicio 59202
% +---------------+---------------+---------------+---------------+
% |288            |485416         |            0.1|            0.0| Lleva el PCR del HD 59201
% +---------------+---------------+---------------+---------------+
% |289            |218471416      |           67.7|           11.7| Video HD (Servicio 59201)
% +---------------+---------------+---------------+---------------+
% |290            |1830932        |            0.5|            0.0| Audio del HD (Servicio 59201)
% +---------------+---------------+---------------+---------------+
% |291            |4685524        |            1.4|            0.2| Audio del HD (Servicio 59201)
% +---------------+---------------+---------------+---------------+
% |304            |485416         |            0.1|            0.0| Lleva el PCR de SD (Servicio 59202)
% +---------------+---------------+---------------+---------------+
% |305            |37562964       |           11.6|            2.0| Video SD (Servicio 59202)
% +---------------+---------------+---------------+---------------+
% |306            |1874172        |            0.5|            0.1| Audio SD (Servicio 59202)
% +---------------+---------------+---------------+---------------+
% |528            |121448         |            0.0|            0.0| PCR del LD (Servicio 59224)
% +---------------+---------------+---------------+---------------+
% |529            |6201556        |            1.9|            0.3| Video LD (Servicio 59224)
% +---------------+---------------+---------------+---------------+
% |530            |935488         |            0.2|            0.0| Audio LD (Servicio 59224)
% +---------------+---------------+---------------+---------------+
% |532            |42300          |            0.0|            0.0| Private Data (QUE ES?) (Servicio 59201 y ld)
% +---------------+---------------+---------------+---------------+ 
% |8136           |280496         |            0.0|            0.0| PMT del programa 59224
% +---------------+---------------+---------------+---------------+
% |8191           |46091208       |           14.2|            2.4|
% +---------------+---------------+---------------+---------------+
%  TOTAL           322335400
% Tablas(excluyendo EIT): 280496 + 28012 + 13912 + 5640 + 28012 + 41736 + 280496 + 280496 + 42300 + 280496 = 1281596 (0.397%) (con EIT 3589860, 1.1% )

Ya es conocida la importancia de la modulación de información digital en este formato de televisión. Aún así, este proceso no es suficiente para la entrega de contenidos. Aún es necesario organizar los bytes para que tengan significado en el receptor. De otra manera, el receptor observaría un flujo ininterrumpido de bytes dispuestos fuera de contexto. A fin de interpretar los mismos es necesario agruparlos de alguna manera y asignarles un significado. Éste es el objetivo del formato contenedor \emph{MPEG-2 Transport Stream}.

\subsection{MPEG Transport stream}
 
 El formato contenedor de los datos que viajan en las emisiones ISDB-Tb, está definido por el estándar \textbf{MPEG-2 Transport Stream} o simplemente \emph{flujo de transporte}. El flujo de transporte MPEG posee características que lo hacen ideal para la televisión terrestre. 

\begin{itemize}
	\item Está diseñado para ambientes de transmisión o persistencia no confiables, es decir, con presencia de errores y pérdida. En el caso de ISDB-Tb, este medio son los canales físicos de radiofrecuencia.
	\item El flujo de transporte MPEG permite la multiplexación se servicios con bitrates variables e independientes. Esto permite aprovechar al máximo la capacidad de transmisión de los canales de radiofrecuencia. Incluye mecanismos para la identificación y presentación de estos servicios.
	\item Especifica mecanismos para la sincronización de flujos de audio y video.
	\item Es un formato extensible para adecuarse a los medios sobre los que se utiliza.
\end{itemize}

La modulación de la señal permite pensar en cada canal físico como un flujo constante de bits. Para organizarlo, el flujo de transporte MPEG agrupa los bits en paquetes de 188 bytes cada uno. Los paquetes de longitud fija poseen la característica de simplificar la inclusión de campos para la detección y corrección de errores. A su vez, permite transportar varios servicios en una misma línea de tiempo, sin la necesidad de contar con una referencia de reloj común a todos ellos, puesto que se intercalan paquetes de cada uno.

\subsection{Estructura de los paquetes \textbf{MPEG-TS}}

Desde el punto de vista de un receptor de señal, el flujo de transporte es una serie de dígitos binarios, de modo que es imposible definir dónde termina un paquete y comienza el siguiente. El receptor también necesita saber qué información viaja en el interior de un paquete, para interpretar el contenido binario. Con estos objetivos, entre otros, cada paquete de un flujo de transporte contiene un prefijo de 4 \emph{bytes}.

El primer byte de ellos es el \textbf{byte de sincronización}, que sirve al receptor para identificar el comienzo de los paquetes. Transporta siempre el valor $47_H$. Entonces, cuando el receptor sintoniza un canal de radiofrecuencia dado, debe utilizar este campo para encontrar el comienzo de los paquetes. Este proceso se conoce como \emph{sincronización}. El estándar \textbf{MPEG-TS}\cite{isoiec13818} define que, al encontrar 5 bytes de sincronización intercalados por 187 bytes, el receptor puede asumir que se ha sincronizado al flujo.

%El estándar de implementación de un sistema de recepción establece que al encontrar 5 bytes de sync en sus lugares, el receptor puede asumir que ha logrado sincronización. y si no encuentra uno en 3 lugares, ha perdido la sincronización.

Otro campo del prefijo de los paquetes de igual importancia que el byte de sincronización transporta el \emph{packet identifier}(\textbf{PID}) del paquete. Consiste en un entero sin signo de 13 \emph{bits} que identifica los contenidos. Gracias a este valor, el receptor puede obtener los paquetes de audio, video y datos. En general, es necesario conocer el PID con el que viaja una entidad del formato a fin de buscar la información que contiene.

\begin{figure}[H]
	\begin{center}
	\includegraphics[width=14cm]{imgs/ts_packet.png}
	\caption{Estructura de un paquete de flujo de transporte} 
	\end{center}
\end{figure}

Para información más detallada relacionada con la estructura de los paquetes del flujo de transporte ver \cref{App:AppendixA}.

\subsection{Recepción de señal \textbf{ISDB-Tb}\label{sec:consumeisdbt}}

Los receptores de señal ISDB-Tb tienen dos tareas básicas. La primera tarea es entregar al usuario la lista de servicios disponibles. La segunda es reproducir aquel servicio que el usuario elija. Ambas necesitan la información provista a través del formato contenedor, el flujo de transporte MPEG. 

\subsubsection{Construcción de la lista de servicios}

%http://web.archive.org/web/20131215053925/http://es.wikipedia.org/wiki/Televisi%C3%B3n_Digital_Terrestre_en_Argentina#Lista_de_canales_de_la_Plataforma_Estatal

%VISITAR ESO QUE AHI ESTA LA LISTA DE SERVICIOS COMPLETA
A diferencia de la televisión analógica, en televisión digital cada banda UHF contiene más de un servicio. Si se desea conocer los servicios que viajan por un canal, es necesario sintonizar ese canal e identificar los servicios a través de la información que contiene el flujo de transporte.

La \cref{tab:servicestablec23} presenta una lista de servicios de la \textbf{Televisión Digital Abierta}. La primer columna indica el canal físico por el que viaja cada flujo de transporte y la segunda, todos los servicios asociados al mismo.

\newpage
\begin{table}[H]
	\begin{center}
		\begin{tabular}[t]{ | c | c | c | c | }
			\hline
			Canal 	& Servicio 		& Logotipo		&		Formato de video\tablefootnote{La letra minúscula que acompaña al formato de video define el tipo de scan utilizado. \emph{i} define entrelazado y \emph{p} define progresivo.} \\
			\hline\hline
			\multirow{5}{*}{22 (521MHz)}	& Encuentro 	& \includegraphics[width=1cm]{imgs/logoencuentro.png}	& SD (576i, 50Hz) \\\cline{2-4}
								& Paka Paka 	& \includegraphics[width=1cm]{imgs/logopakapaka.png}	& SD (576i, 50Hz) \\\cline{2-4}
								& TaTeTi 		& \includegraphics[width=1cm]{imgs/logotateti.png}	& SD (576i, 50Hz) \\\cline{2-4}
								& INCAA TV 		& \includegraphics[width=1cm]{imgs/logoincaa.png}	& SD (576i, 50Hz) \\\cline{2-4}
								& Encuentro LD 	& \includegraphics[width=1cm]{imgs/logoencuentro.png}	& LD (240p, 30Hz) \\\hline\hline
			\multirow{3}{*}{23 (527MHz)}	& TV Pública HD & \includegraphics[width=1cm]{imgs/logotvpublicahd.png}	& HD (1080i, 50Hz)\\\cline{2-4}
								& Tecnópolis	& \includegraphics[width=1cm]{imgs/logotecnopolis.png}	& SD (576i, 50Hz) \\\cline{2-4}
								& TV Pública 	& \includegraphics[width=1cm]{imgs/logotvpublica.png}	& LD (240p, 30Hz) \\\hline\hline
			\multirow{6}{*}{24 (533MHz)}	& DeporTV		& \includegraphics[width=1cm]{imgs/logoencuentro.png}	& SD (576i, 50Hz) \\\cline{2-4}
								& Vivra			& \includegraphics[width=1cm]{imgs/logovivra.png}	& SD (576i, 50Hz) \\\cline{2-4}
								& Suri TV 		& \includegraphics[width=1cm]{imgs/logosuritv.png}	& SD (576i, 50Hz) \\\cline{2-4}
								& Arpeggio 		& \includegraphics[width=1cm]{imgs/logoarpeggio.jpeg}	& SD (576i, 50Hz) \\\cline{2-4}
								& Viajar 		& \includegraphics[width=1cm]{imgs/logoviajar.png}	& SD (576i, 50Hz) \\\cline{2-4}
								& Depor TV LD 	& \includegraphics[width=1cm]{imgs/logodeportv.jpeg}	& LD (240p, 30Hz) \\\hline\hline
			\multirow{6}{*}{25 (539MHz)}	& CN23 			& \includegraphics[width=1cm]{imgs/logocn23.png}	& SD (576i, 50Hz) \\\cline{2-4}
								& C5N			& \includegraphics[width=1cm]{imgs/logoc5n.png}	& SD (576i, 50Hz) \\\cline{2-4}
								& Telesur		& \includegraphics[width=1cm]{imgs/logotelesur.png}	& SD (576i, 50Hz) \\\cline{2-4}
								& 360 TV 		& \includegraphics[width=1cm]{imgs/logo360tv.jpg}	& SD (576i, 50Hz) \\\cline{2-4}
								& Construir TV	& \includegraphics[width=1cm]{imgs/logoconstruirtv.png}	& SD (576i, 50Hz) \\\cline{2-4}
								& CN 23 LD 	 	& \includegraphics[width=1cm]{imgs/logocn23.png}	& LD (240p, 30Hz) \\\hline
		\end{tabular}
		\caption{Lista de servicios de la plataforma nacional de la Televisión Digital Abierta\label{tab:servicestablec23}}
	\end{center}
\end{table}


Cada canal físico contiene un flujo de transporte independiente, que multiplexa a su vez varios servicios. Un sintonizador puede decodificar un único canal físico en un momento dado. De modo que para indicar al usuario la lista completa de servicios debe memorizarlos previamente. A este proceso se lo conoce como ``\emph{scan}''.

El \emph{scan} consiste en recorrer todas las frecuencias posibles, sincronizándose y memorizando información del sistema. A partir de esta información, el receptor puede conocer los nombres de los servicios y su tipo. A su vez, recordará en qué canal se encuentra cada uno, para su posterior sintonización.

Asumiendo que se desea construir la lista de servicios correspondiente a la \cref{tab:servicestablec23}, el \emph{scan} consiste en recorrer los canales 22, 23, 24 y 25, memorizando toda la información que provee cada flujo de transporte. Ejemplo de esta información, en términos del Canal 23, son el nombre de la red transmisora (``RTA C23''), los nombres de los servicios (``TV Pública'', ``TV Pública HD'' y ``Tecnópolis'') y el nombre del flujo de transporte (``TVPublica''). Estos tres servicios se sumarían a todos los de otros flujos de transporte de otros canales físicos, como ``Encuentro'' de canal 22 (Frecuencia 521MHz).

El proceso de \emph{scan} puede demorar algunos minutos, dependiendo de la cantidad de frecuencias recorridas. Por eso, la información obtenida y construida hasta aquí suele ser persistida. Así, aún luego de apagar el sistema de recepción, el usuario no requerirá volver a repetir este procedimiento.

\subsubsection{Sintonización de servicios}

Esta tarea se puede realizar únicamente una vez la lista de servicios está disponible y se debe llevar a cabo cada vez que el usuario solicita un servicio. 

\begin{enumerate}
\item Si el usuario está mirando ``TV Pública HD'' y decide sintonizar ``Encuentro'', es necesario realizar un salto de canal en el receptor. El primero viene por Canal 23 (Frecuencia 527MHz) y el segundo por Canal 22 (Frecuencia 521MHz).

Si por el contrario el usuario quisiera sintonizar ``Tecnópolis'' en lugar de ``Encuentro'', este paso podría ignorarse, dado que ambos se encuentran en el mismo flujo de transporte, ya sintonizado.

El proceso de cambiar de canal físico, implica demodular la nueva señal y sincronizarse con la emisión, para distinguir el comienzo de cada paquete e interpretar correctamente la información.

\item Una vez el receptor esté recibiendo el flujo de transporte buscado, debe lograr distinguir y filtrar los paquetes que pertenecen al servicio requerido por el usuario. Es decir, si se sintoniza ``Encuentro'', el receptor debe decodificar el video de este servicio de televisión, y no de ``TV Pública HD''. Lo mismo ocurre con el audio y otros flujos multimedia.

\item Para finalizar, todo el contenido multimedia debe ser redirigido a los dispositivos de entrega: Televisor, monitor y altavoces, dispositivo móvil, etc.
\end{enumerate}


\subsection{Tablas}

En la televisión analógica, un sistema de recepción se limita a sintonizar un canal físico, interpretar la señal y reproducirla para el usuario. La televisión digital requiere de procesos más complejos, como la construcción de la lista de servicios. Para estos, el receptor requiere información por parte del emisor fuera del contenido multimedia propiamente dicho. Para entregar dicha información, ISDB-Tb utiliza \textbf{tablas}. 

Las tablas son estructuras sintácticas concebidas en el formato \textbf{MPEG-TS} que cumplen una función específica como transportadores de información. Existe un conjunto de cuatro tablas denominado \emph{Program Specific Information}(\textbf{PSI}, creadas por el formato MPEG-TS) que interviene directamente en la demultiplexación de servicios. Estas son \textbf{PAT}, \textbf{CAT}, \textbf{NIT} y \textbf{PMT}, que serán exploradas a continuación. Como el formato MPEG-TS trasciende los dominios específicos como la televisión digital, es necesario que algunas tablas sean agregadas por normas como ISDB-Tb. De las tablas ajenas al PSI, sólo la \textbf{SDT} es de interés para este trabajo, que es agregada para la distribución de TV digital. La lista completa de tablas en la norma ISDB-Tb se define en ARIB-STD B10\cite{dibeg}.

% Los paquetes tienen tamaño de 188 bytes y disponen de aún menos para enviar contenidos. Las tablas, por ejemplo, pueden exceder este tamaño. Por ello viajan en un formato denominado ``secciones'' de longitud variable, que se dividen entre tantos paquetes como sean necesarios. El receptor debe recostruir las secciones para obtener las tablas que contiene. 

La \cref{fig:esquema_servicios_c23} muestra la relación entre las distintas tablas. Las referencias entre tablas se realizan a través del PID que tienen asignado. A continuación se desarrolla la utilidad de cada una.

\begin{figure}[h]
\begin{center}
\includegraphics[width=12cm]{imgs/canal_23_tables.png}
\caption{Esquema general de tablas en el ejemplo de Canal 23\label{fig:esquema_servicios_c23}}
\end{center}
\end{figure}

Es importante notar que los paquetes del flujo de transporte tienen un tamaño de 188 bytes y disponen de aún menos para cargar contenidos. Las tablas pueden exceder este tamaño. Para zanjar este problema, las mismas viajan en \emph{secciones}, que son estructuras de longitud variable y se dividen entre tantos paquetes como sean necesarios. El receptor debe recostruir las secciones para obtener las tablas que contiene. 

\subsubsection{\emph{Program allocation table} (\pat)}

La \pat\ es la primera tabla que debe buscar el decodificador para sintonizar un servicio. Viaja con \pid\ 0. Existe una \pat\ por flujo de transporte y asocia a cada servicio con un \textbf{PID}. La identificación del servicio se hace a través del número de \emph{service\_id}. El término programa se puede utilizar como sinónimo de servicio.\\

\begin{table}[H]
\begin{center}
\begin{tabular}{ l | c }
\emph{service\_id} & Program PID (o PID de PMT) \\
\hline 
59201 & 258 \\
59202 & 8136 \\
59224 & 259 \\
\end{tabular}
\caption{Contenidos de la PAT emitida por Canal 23}
\end{center}
\end{table}

\subsubsection{\emph{Program Map Table} (\pmt)}

La \pmt\ define los contenidos multimedia que corresponden a un programa. El \pid\ que tiene asignado un servicio por \pat, es el \pid\ con el que viaja la \pmt\ de tal servicio. Esta tabla le permite al decodificador acceder a los paquetes que llevan los flujos con contenidos multimedia a través de sus respectivos \pid.

Todos los paquetes de un mismo \pid\ que transportan contenido multimedia componen lo que se denomina \emph{flujo elemental}. De modo que la \pmt\ permite al receptor encontrar los flujos elementales.\\

\begin{table}[H]
\begin{center}
\begin{tabular}{ l | c }
Tipo de flujo & PID del flujo \\
\hline 
27(Video) & 289 \\
17(Audio) & 290 \\
17(Audio) & 291 \\
\end{tabular}
\caption{PMT que viaja con PID 258 en el ejemplo de Canal 23}
\end{center}
\end{table}

\subsubsection{\emph{Service Description Table} (\sdt)}

La \sdt\ describe con más detalle los programas transportados por un flujo de transporte. Viaja con \pid\ 17. Es una tabla descriptiva, como el nombre lo indica, en términos de que incluye información textual sobre el servicio, como su nombre. También establece de qué tipo de servicio se trata: radio, TV, \etc\\

\begin{table}[H]
\begin{center}
\begin{tabular}{ l | c | c }
\emph{service\_id} & Nombre del servicio & Tipo del servicio \\
\hline 
59201 & TV Pública HD & Televisión \\
59202 & Tecnópolis & Televisión \\
59224 & TV Pública & (Data Service) Televisión Móvil \\
\end{tabular}
\caption{Contenidos de la SDT emitida por Canal 23}
\end{center}
\end{table}

\subsubsection{\emph{Network Information Table} (\nit)}

La transmisión de la \nit\ es obligatoria en los sistemas de televisión terrestre. Se envía en paquetes con \pid\ 16 y contiene información obligatoria sobre la organización física de la red de transmisión que la emite, pero también de forma opcional puede enviar información de otras redes.

\subsubsection{Descriptores}

Dentro de las tablas, parte de la información viaja en un formato de longitud variable denominado ``descriptores''. Cada descriptor es identificado numéricamente de forma unívoca por un \emph{descriptor\_tag} que ocupa un \emph{byte}. El segundo elemento que viaja en un descriptor es un campo denominado \emph{descriptor\_length} que denota la longitud $l$ de la estructura en \emph{bytes}. Los siguientes $l$ \emph{bytes} transportan el contenido del descriptor propiamente dicho.

Los descriptores viajan en \emph{loops} de descriptores, y no existe una limitación para la cantidad que pueden viajar en un mismo \emph{loop}. Tampoco existen restricciones para el orden en que deben viajar los descriptores y el mismo no tiene influencia sobre el significado de los mismos. Una lista completa de los tipos de descriptores de ISDB-Tb se provee en ARIB-STD B10\cite{dibeg}.

Un ejemplo de descriptor es el \emph{service\_descriptor} de la SDT. Es identificado por el \emph{descriptor\_tag} 72 y transporta una descripción de un servicio, incluyendo el nombre. En el caso del ejemplo del canal 23, la SDT transporta un \emph{service\_descriptor} por cada uno de los servicios. Del mismo desde donde se obtienen los nombres ``TV Pública'', ``TV Pública HD'' y ``Tecnópolis''.

\subsubsection{Flujos elementales}

El formato con que viajan los audios y videos se denomina \emph{Packetized elementary stream}(\pes). Cada paquete \pes\ de este formato es de longitud variable y, de forma general, se puede asumir más grande que un paquete de flujo de transporte. Se puede establecer una analogía entre los paquetes \pes\ y las secciones. Igual que las secciones, los paquetes \pes\ se dividen entre los paquetes de flujo de transporte. 

A fin de posibilitar la reconstrucción, todos los paquetes que pertenecen al mismo flujo elemental viajan con el mismo PID. Todos estos paquetes con igual \pid\ componen un único flujo elemental. Típicamente, un servicio de televisión dispone de al menos un flujo elemental de audio y un flujo elemental de video. En el caso de ``Televisión Pública HD'' del ejemplo anterior, el servicio dispone de un video HD y dos audios.

En el ejemplo, el servicio ``Televisión Pública HD'', el video viaja con el PID 289 y los audios con PID 290 y 291. Cabe notar que los flujos elementales también pueden corresponder a \emph{closed caption} y contenido interactivo. 

\subsection{Decodificación de tablas en flujos de transporte\label{sec:tunesteps}}

Es sumamente importante para este informe analizar cómo influyen las tablas en los procesos de \emph{scan} y selección de servicios. Es a través de estos procedimientos que la combinación de medios es posibles. En primer instancia, el \emph{scan} permite que los servicios ajenos al flujo de transporte sean presentados al usuario. Y el segundo de ellos efectiviza la búsqueda de información multimedia para su posterior reproducción. Claro está, si se requiere modificar el protocolo estándar es menester comprenderlo.  

Las tareas de construcción de lista de servicios y sintonización de servicios que se trataron en la \cref{sec:consumeisdbt} se basan en la información provista por las tablas de la norma ISDB-Tb. A continuación se detalla cómo influye cada una:

\subsubsection{Tablas en la construcción de lista de servicios}

El proceso de construcción de la lista de servicios se resume a recorrer todas las frecuencias por las que viajan flujos de transporte, capturando la información contenida por la \sdt\ y \nit. El receptor, con la información incluida en ambas tablas(de cada flujo) y en sus respectivos descriptores, ya puede ofrecer la lista completa. En este paso se genera la asociación entre servicio y flujo de transporte, similar a la \cref{tab:servicestablec23}. Es decir, el proceso de \emph{scan} le indica al receptor que ``TV Pública HD'' es transmitido por Canal 23, al igual que ``Tecnópolis'' y ``TV Pública''. ``DeportTV'' por Canal 24, y así sucesivamente.

\subsubsection{Tablas en la sintonización de servicios}

\begin{enumerate}
\item El primer paso es sintonizar el canal físico por el cual viaja el flujo de transporte que lleva el servicio deseado. El mismo se obtiene de la asociación generada en el \emph{scan}.

\item Una vez el canal físico está en sintonía, y el receptor sincronizado con el flujo de transporte, el receptor debe reconstruir la sección que viaja con \pid\ 0, que corresponde a la \pat. 

En el ejemplo de Canal 23, en la tabla encontrará la lista con los 3 servicios. Sabiendo por la \sdt\ que el nombre ``TV Pública HD'' corresponde al \emph{service\_id} 59201, de la \pat\ se obtiene el PID con que viaja la \pmt, que en el ejemplo es 258.

\item Con el \pid\ de la \pmt, el receptor reconstruye la sección que lleva la tabla. De ella extrae los \pid\ de los flujos elementales. ``TV Pública HD'' envía dos flujos de audio (\pid s 290 y 291) y un flujo de video HD con \pid\ 289. Con éstos \pid, ya es posible reconstruir los contenidos multimedia.

\item Los flujos elementales deben decodificarse y enviarse a los periféricos de entrega.

\end{enumerate}

\section{Generación de contenido de señal ISDB-Tb}

El proceso de transformación de la información desde que se captura en un estudio de televisión hasta que es emitida por una antena emisora está compuesto por tres etapas:

\begin{enumerate}[label=\alph*]
\item \textbf{Generación de contenidos:} en una estación de televisión hay un conjunto de tecnologías para este fin. Cámaras, \emph{switchers}, generadores de efectos, consolas de audio, \etc. que entregan flujos elementales (audio y video) de alta velocidad para su posterior codificación. En general, cada flujo se entrega a \textbf{Codificación} por separado.
\item \textbf{Codificación y empaquetado:} en esta etapa se realiza la compresión del audio y video, para adaptarla a la capacidad de transmisión de los canales físicos. La información contenida en cada flujo elemental es segmentada en paquetes de bits llamados PES(\emph{Packetized elementary streams}), que luego son divididos nuevamente a paquetes \textbf{MPEG-TS} de 188 bytes. En general, cada programa genera tres flujos de paquetes \textbf{MPEG-TS}: video, audio y datos.
\item \textbf{Señalización y multiplexación de programas:} en la etapa final se compone el flujo binario \textbf{MPEG-TS} de entrega. Integra el audio, video y datos de los servicios que lo compongan, completamente optimizado para la transmisión. En este punto se incorporan las tablas que señalizan los servicios.
\end{enumerate}

Las herramientas involucradas en la señalización y multiplexación de programas deben seguir escrictos lineamientos de la norma ISDB-Tb(en concordancia con el formato MPEG-TS). Por ejemplo, cada \pmt\ debe encontrarse en el flujo de transporte con una periodicidad de 200 milisegundos. Existen varios proyectos de utilidades de televisión digital que resuelven estas exigencias.

\subsection{OpenCaster}

OpenCaster es un proyecto de código abierto (bajo licencia GPL\cite{gpl}) que incluye muchas de las herramientas necesarias para la construcción de flujos de transporte de acuerdo al formato \textbf{MPEG-TS}. Estas van desde la creación de paquetes, secciones y tablas hasta la multiplexación del \emph{ts}.

OpenCaster provee una API para \emph{Python} desde la cual se pueden ensamblar tablas aprovechando \emph{hotspots} dispuestos en las clases que modelan entidades de las normas de TVD más populares. Una vez construida una instancia de una tabla, la misma se serializa a un arreglo de \emph{bytes} con el formato \textbf{MPEG-TS}. Esta API provee una librería de elementos que incluye tablas y descriptores, junto con los campos asociados a cada uno.

\subsubsection{Generación de Tablas}

La utilización de la API requiere crear un \emph{script} que genere las estructuras buscadas. Desde el mismo se importan las clases provistas, se instancian y luego, el comportamiento heredado permite serializarlas y empaquetarlas. El producto de la ejecución del \emph{script} son secciones ya divididas en paquetes listos para ser añadidos al flujo de transporte.

\lstinputlisting[language=Python,caption={Ejemplo de creación de tablas en OpenCaster}]{src_code/pmt_example.py}\label{lst:exampleopencaster}

\subsubsection{Multiplexación del flujo de transporte}

Una vez que se poseen todas las componentes del flujo, las mismas se deben multiplexar. Este proceso consiste en inyectar los paquetes TS al flujo de transporte, de modo que se respete la periodicidad requerida por las distintas entidades. Por ejemplo, en el flujo de transporte resultante, una instancia de la PMT debe aparecer cada 200ms a lo sumo. En el caso de los flujos elementales multimedia, es necesario tener en cuenta el \emph{bitrate} para evitar que la distribución de la carga final sea errónea causando así \emph{overflows} o \emph{underflows}. La multiplexiación puede ser realizada a través de una herramienta provista en el proyecto OpenCaster llamada \texttt{tscbrmuxer}. Con esta herramienta se puede determinar el \emph{bitrate} final del \emph{ts}.

En las primeras dos secciones de este capítulo se exploraron conceptos importantes de la norma ISDB-Tb, como la influencia de paquetes, tablas y descriptores en el mecanismo de multiplexación de servicios. Esto dio lugar a la exploración del procedimiento de construcción de un flujo de transporte. A continuación, se expone el extremo opuesto del sistema, la recepción, utilizando como caso de estudio un reproductor de televisión digital existente.

\section{Recepción y decodificación de señal ISDB-Tb}

El estándar\cite{aribb21} establece especificaciones deseadas de recepción, decodificación y reproducción de los servicios de un flujo de transporte. Existen problemas complejos asociados al proceso:

\begin{itemize}
	\item La mayoría de los eventos de recepción y reproducción son asincrónicos. La lectura de tablas, en concreto, implica esperar la llegada al receptor de todos los paquetes necesarios para construir la sección por la que viaja. Salvo por las limitaciones de tiempo que impone la norma sobre la emisión de las diferentes tablas, no hay forma de predecir el momento en que esto ocurre. En concreto, el estándar establece que la PMT debe ser transmitida en un período no mayor a 200 milisegundos. A partir de ahí, el decodificador no posee más garantías para la espera.
	\item Es una aplicación que debe responder correctamente a las exigencias de un sistema \emph{soft real time}\cite{realtime}.
	\begin{itemize}
		\item Por un lado, el flujo de transporte es una fuente constante de paquetes que se acumulan en un \emph{buffer}. Si el sistema no llega a consumir suficientes paquetes en un intervalo de tiempo determinado, esto puede incurrir en un \emph{overflow}, lo cual significa que existe pérdida, y esto a su vez se traduce en una degradación del servicio.
		\item Por el otro lado, la presentación de los cuadros del video debe responder a las exigencias de un sistema multimedia. La omisión de cuadros, si ocurre con suficiente periodicidad, también implica una degradación de la calidad.
	\end{itemize}
\end{itemize}

El manejo de los eventos asincrónicos exige el uso de concurrencia. Esto se puede ver reflejado en la \cref{fig:flux_diagram_scan} y la  \cref{fig:flux_diagram_play} que incluyen diagramas de flujo que representan el proceso de \emph{scan} y reproducción de un servicio, respectivamente. Es útil analizar la adaptación de estos procesos en el marco práctico de un reproductor de televisión digital. Para esto, se introduce \emph{Wari}.

 \begin{figure}
	\begin{center}
	\includegraphics[height=13cm]{imgs/scan_seq_diag.png}
	\caption{Diagrama de Flujo del procedimiento tradicional de \emph{Scanning}\label{fig:flux_diagram_scan}} 
	\end{center}
\end{figure}

 \begin{figure}
	\begin{center}
	\includegraphics[height=19cm]{imgs/play_seq_diagram.png}
	\caption{Diagrama de Flujo del procedimiento tradicional de Reproducción de Servicios\label{fig:flux_diagram_play}} 
	\end{center}
\end{figure}

\subsection{Reproductor de Televisión Digital Wari}

\emph{Wari} es un reproductor de televisión digital en la norma ISDB-Tb ideado para ser utilizado en computadoras personales. Es actualmente desarrollado y mantenido por Lifia\cite{lifia}, bajo la licencia LGPL\cite{lgpl}. Está desarrollado mayoritariamente en C++ y Lua. Información útil respecto al reproductor se puede encontrar en el \cref{app:appendix_wari}. En esta sección se exploran los conceptos estrictamente necesarios para el desarrollo de esta tesina.

Los diagramas de secuencia presentados en este informe presentan un único hilo de ejecución. En realidad, Wari utiliza un \emph{dispatcher} de tareas a través del cual los hilos se asignan invocaciones de funciones que deben ser realizadas cuando el control está disponible. Para la notificación de finalización de estas tareas (como podría ser la lectura satisfactoria de una tabla), se puede utilizar este mismo mecanismo o invocación de funciones \emph{callback}. Si bien la ejecución de los métodos es en realidad diferida, la simplificación ayuda drásticamente la lectura y comprensión de los procesos.

%En [TODO: Apéndice ] se realiza una breve explicación del sistema de comunicación de \emph{threads} en Wari. Para más información, el se puede consultar el sitio de descarga de código fuente y manuales de Wari.

\subsection{Construcción de lista de servicios en Wari}

Contruir la lista de servicios consiste en identificar todos los servicios que aparecen en todos los flujos de transporte disponibles para el sistema receptor. En el caso común, recorrer las \sdt\ de todos los flujos de transporte sería suficiente, dado que esta indica los nombres y tipos de los servicios. Wari da un paso extra e involucra también las tablas \pat\ y \pmt. Si bien este no es exactamente igual al procedimiento descripto por el estandar, garantiza que los servicios que aparecen en la lista de servicios sean seleccionables para el usuario\footnote{No es algo completamente extraño encontrar flujos de transporte mal formados donde no se emiten tablas necesarias o hay errores de referencia por PID.}. El procedimiento completo se describe en la \cref{fig:descparse_wari}, la \cref{fig:class_scan_diag} muestra un enfoque estático de la lógica utilizada en Wari a través de un diagrama de clases.

\begin{figure}[]
\begin{center}

\resizebox{\linewidth}{!}{
\input{diagrams/descriptor_parsing_class_diagram}
}

\caption{Diagrama de Clases de parseo de descriptores en Wari\label{fig:class_scan_diag}}
\end{center}
\end{figure}

La solicitud del usuario de un \emph{scan} lleva a la invocación del método \texttt{startScan} de la clase \texttt{Tuner}. Ésta solicitará sistemáticamente al \texttt{Provider} que sintonice las frecuencias disponibles. Sobre cada una de las frecuencias, el \texttt{ServiceProvider} esperará por la \sdt, la \pat, y la \pmt. Cuando las tablas llegan al \texttt{Provider}, se notifica a las instancias de la clase \texttt{Service} correspondiente, y esta se actualiza acordemente. Parte del procesamiento de las tablas, como se indica en la \cref{fig:descparse_wari}, implica procesar también los descriptores que incluye la tabla.

Para obtener las tablas \sdt, \pat, y \pmt, es necesario antes construir las secciones por las que viajan. A su vez, las secciones requieren de los paquetes sobre los que viajan. Los paquetes se asocian a las tablas a través del \pid. Cada tabla tiene un \pid\ asignado. 

Para obtener los paquetes de un \pid\ dado, el sistema utiliza los \emph{demuxers}. Los \emph{demuxers} son \emph{listeners} que se ubican sobre el flujo de transporte que esperan un paquete con un \pid\ dado. De modo que cuando el \texttt{ServiceProvider} desea construir la lista de servicios, le pide al \texttt{Provider} que cree un \emph{demuxer} para cada tabla que necesitan, a través del método \texttt{startFilter(aDemuxer)}\footnote{El método se llama \texttt{startFilter} en lugar de \texttt{startDemuxer} porque la componente que conecta el \emph{demuxer} con el flujo de transporte se llama \texttt{filter}.}. 

\begin{figure}[]
\begin{center}

\resizebox{\linewidth}{!}{
\input{diagrams/descriptor_parsing_sequence_diagram}
}
\caption{Diagrama de Secuencia de construcción de lista de servicios en Wari\label{fig:descparse_wari}}
\end{center}
\end{figure}

Un diagrama de la relación estática entre las clases del sistema se presenta en la \cref{fig:class_scan_diag}.  Descripción de la responsabilidad de las clases:

\begin{itemize}
	\item \texttt{Tuner} coordina el proceso de \emph{scan} desde el tope de la jerarquía de abstracción. La clase \texttt{Tuner} responde a todos los requerimientos del \emph{Zapper}\footnote{Se denomina \emph{Zapper} a un dispositivo utilizado para sintonizar servicios en un televisor.} que utiliza el usuario. 
	\item \texttt{ServiceProvider} junto con \texttt{ServiceManager} gestionan los servicios(que se modelan a través de la clase \texttt{Service}), durante todo su ciclo de vida. Es esta clase la que posee la lista de servicios propiamente dicha.
	\item \texttt{Provider} encapsula y abstrae las operaciones de \emph{hardware} del dispositivo de sintonización subyacente. También gestiona los \emph{demuxers}. 
	\item Cada instancia de \texttt{Service}, finalmente, modela un servicio que viene por alguno de los flujos de transporte disponible. Guarda información como \emph{service\_id} nombre y tipo.  
\end{itemize}


\subsection{Demultiplexación y reproducción de servicios en Wari}

%%%
%%% Complete
%%%

El proceso de demultiplexación de servicios consiste en la reconstrucción de los flujos elementales originales, que habían sido fragmentados en paquetes TS para su multiplexación en el flujo de transporte. Antes de comenzar la recolección de estos paquetes TS, el receptor debe conocer los \pid\ de todos los flujos elementales requeridos para reproducir enteramente el servicio. Por ejemplo, en el caso de ``TV Pública HD'', se deben obtener del flujo de transporte todos los paquetes de \pid\ 289 y 290, que corresponden al video HD y al primero de los audios, respectivamente, como se indica en la \cref{fig:esquema_servicios_c23}. La carga útil contenida en los paquetes TS se ensambla para obtener paquetes PES, que pueden ser interpretados por un reproductor multimedia. Información más detallada se puede encontrar en el \cref{App:AppendixA}.

El proceso de reproducción de flujos elementales comienza una vez se dispone de los flujos elementales reconstruidos, luego que se ha realizado \emph{buffering} de suficientes paquetes. Consiste en decodificarlos y obtener las imagenes y el audio que componen al servicio. En Wari, este proceso es realizado por alguna librería de reproducción existente, como VLC\cite{vlc}. Wari sólo se limita a facilitar el acceso a los flujos elementales a la librería de reproducción elegida\footnote{Este es uno de los tantos aspectos parametrizables en la configuración de compilación de Wari.}. La \cref{fig:classdiagramservices} muestra un diagrama de clases de la infraestructura relacionada con la recolección de flujos elementales. 

\begin{figure}[]
	\begin{center}

	\resizebox{\linewidth}{!}{
	\input{diagrams/play_class_diagram}
	}
	\caption{Diagrama de clases de infraestructura de reproducción en Wari\label{fig:classdiagramservices}}
	\end{center}
\end{figure}

Las clases representadas en la \cref{fig:classdiagramservices} son:
\begin{itemize}
	\item \texttt{PlayerExtension}: Representa la máxima abstracción en términos de reproducción de servicios que provienen de un flujo de transporte, gestiona los mecanismos de comunicación internos.
	\item \texttt{Player}: Es la superclase de la jerarquía de destinos de reproducción. Cualquier clase que vaya a representar un tipo de reproducción, debe ser sublcase de \texttt{Player}.
	\item \texttt{AvPlayer}: Representa el reproductor de Audio/Video de servicios que provienen de un flujo de transporte que se captura a través de un dispositivo sintonizador. 
	\item \texttt{ServiceManager} y \texttt{ServiceProvider}: La jerarquía gestiona el ciclo de vida de los servicios y encapsula todo el procesamiento relacionados con ellos, como el que se realiza en la captura de tablas relacionadas con servicios.
	\item \texttt{Tuner}: Clase que provee la interfaz genérica de un \emph{Zapper}. Permite escanear y sintonizar servicios.
	\item \texttt{Service}: Clase que modela a los servicios de los flujos de transporte disponibles para el receptor. Almacenan toda la información vinculada a los mismos, como nombre, id, o información de flujos elementales.
\end{itemize}


La \cref{fig:playsecwari} presenta un diagrama de secuencia del proceso de recolección y reproducción de flujos elementales a partir de la solicitud de sintonización de un servicio. Este protocolo deriva del formato MPEG-TS.

\begin{figure}[]
\begin{center}

\resizebox{\linewidth}{!}{
\input{diagrams/play_sequence_diagram_wari}
}
\caption{Diagrama de secuencia de infraestructura de reproducción en Wari\label{fig:playsecwari}}
\end{center}
\end{figure}

En Wari, cuando el usuario solicita el cambio de servicio, el control llega a la clase \texttt{Tuner}. A partir de entonces, el primer paso es buscar la instancia de la clase \texttt{Service} que corresponde al servicio solicitado por el usuario. Una vez que se dispone de esta, se le debe indicar al \texttt{PlayerExtension} que se busca reproducir el servicio. Éste obtiene de la instancia de \texttt{Service} la información asociada a los flujos elementales que se deben reproducir, como los \pid\ de los mismos. Toda esta información es enviada al \texttt{AvPlayer}.

Los \pid\ permiten ubicar filtros sobre los flujos de transporte. El filtro, a su vez, facilita la recepción de todos los paquetes con un \pid\ determinado. Es el \texttt{AvPlayer} quien crea los filtros para los flujos elementales del servicio a reproducir. Sin embargo, aún es necesario indicarle al reproductor la forma de reproducirlos. Esto se entrega en un \emph{Uniform Resource Locator} o URL. 

El URL de reproducción se construye en el método \texttt{makeURL} de \texttt{PlayerExtension}. Este URL se almacena en el \texttt{AvPlayer} para que posteriormente, cuando el proceso de cambio de canal haya terminado, el \emph{main thread} se lo solicite y se lo envie al reproductor de audio y video. En el caso de selección de servicios tradicional, este URL refiere al dispositivo de sintonización y parámetros que sirven, en conjunto, para que la librería de reproducción multimedia pueda obtener los paquetes PES directamente. La observación pertinente a realizar es que los URL disponen de un dominio casi universal. Esta flexibilidad permite que se localicen no sólo dispositivos de hardware, sino también recursos en una red IP, o potencialmente recursos web. Este parámetro es un excelente punto de introducción para nuevos medios de transmisión, permitiendo la fácil reproducción de IPTV en el esquema global de transmisión.


% TODO: Acá tenemos que enganchar el capítulo de IPTV!

% \{Obtención de servicios}

% La lectura de los servicios de un \emph{ts} se hace de forma independiente respecto del medio del cual se obtiene. A fin de comprender cualquier tipo de modificación de la librería \textbf{mpeg-parser}, es necesario ver el proceso de obtención y reproducción de servicios:

% \begin{enumerate}
% \item Se sintoniza el canal físico por el que viaja el \emph{ts} que lleva el servicio.
% \item Se filtra la \pat\ y se obtiene de la misma el \pid\ con el que viaja la \pmt\ asociada al servicio.
% \item Se filtra la \pmt\ del servicio y se extraen los \pid\ de los flujos elementales, sean audio y video.
% \item Los \pid\ de los flujos elementales se entregan a la librería \emph{Canvas}.
% \end{enumerate}

% \subsection{Reproducción}

% La entrega de los flujos al reproductor se realiza a través de una URL que incluye los \pid\ de los flujos elementales componentes del servicio a entregar. Una característica a notar de la librería \emph{Canvas} que interpreta la URL es la naturaleza polimórfica del parámetro, dado que interpreta esquemas (o protocolos) diversos. \eg:

% \begin{itemize}
% \item srvdtv://audioPID=4000,audioType=3,pcrPID=3000,videoPID=3000,videoType=2
% \item udp://@127.0.0.1:4000
% \end{itemize}

% El primero corresponde a un \emph{ts} consumido desde un dispositivo de sintonización de radiofrecuencia. El segundo a un socket alocado localmente asignado al puerto 4000. Es interesante notar que tal URL no debe estar necesariamente ligada un socket local.

% \section{Descripción de clases}

% \includegraphics[width=12cm]{imgs/classes.png}

% A continuación se presentan descripciones de las clases más relevantes de la librería \textbf{mpeg-parser} en términos de identificación y entrega de servicios. El enfoque es descendente. Esto es, las primeras clases son las más cercanas a conceptos ya presentadas y, a partir de ellas, se reduce el nivel de abstracción.

% \subsection{\texttt{Tuner}}

% Esta clase(podría traducirse como \texttt{Sintonizador}), provee interfaz para escanear y sintonizar servicios, y es accedida directamente desde las librerías que utilizan \textbf{mpeg-parser}. Para realizar estas tareas hace uso de la jerarquía compuesta por \texttt{ServiceProvider} y su superclase \texttt{ServiceManager}.

% \subsection{\texttt{ServiceProvider}}

% Permite comenzar el proceso de \emph{scanning} de servicios. Al detectar un servicio, crea el modelo del mismo, asociando un \emph{listener} sobre el flujo de transporte para los elementos del \emph{ts} relacionados a los servicios como lo son su \pmt, la \sdt, la \nit\ y sus respectivos flujos elementales. Estos últimos sólo al momento de su reproducción. Este modelo es reflejado por la clase \texttt{Service}. 

% \texttt{Service provider} es una especialización de \texttt{ServiceManager}, pero actualmente no existe otra utilidad para la clase más genérica, por ello no se realiza una diferenciación explícita de las responsabilidades de cada una. 

% \subsection{\texttt{Service}}

% Modela un servicio de alguno de los \emph{ts} capturados por la librería. Entre otras responsabilidades, procesa las tablas y descriptores encontrados en una tabla, modificándose acordemente. Lleva información sobre los flujos elementales componentes que resulta necesaria para la sintonización del servicio.

% \subsection{Tablas: \texttt{PAT}, \texttt{PMT}, \texttt{SDT}}

% Cada tabla del estándar posee un modelo que la refleja en la librería e incluye toda la información que pudiera viajar por estos medios. De esta manera, un servicio adquiere su nombre a través del procesamiento de una instancia de la clase que corresponde a la \sdt.

% \subsection{\texttt{Descriptors}}

% Esta clase modela un \emph{loop} de descriptores. Cada descriptor posee a su vez una representación a través de un registro \texttt{struct}, sin comportamiento. El servicio utiliza la información que obtenga del descriptor de la forma que corresponda. Es importante remarcar que una clase descriptors se modela con un arreglo de \emph{bytes}, de modo que el salto de abstracción se debe realizar de alguna manera. De este proceso se encargan los \emph{descriptor parsers}.

% \subsection{Macro: \texttt{DESC\_PARSE}, \emph{descriptor tag} y función asociada}

% Los servicios usan el \texttt{DESC\_PARSE} para encontrar descriptores en un \emph{loop} de descriptores. Para esto, se debe iterar una función de \emph{parsing} a lo largo de todo el arreglo. A cada paso, en el proceso de iteración, se invoca la función de \emph{parsing} asociada al \emph{descriptor tag} encontrado. La asociación se realiza a nivel de compilación por \emph{matching} de nombres descriptor/función.

% La función de \emph{parsing} entonces recibe un arreglo de \emph{bytes} con un \emph{offset} que permite encontrar el comienzo de su descriptor dentro del \emph{loop}. A partir de ahí utiliza el formato para extraer los datos que transporta.

% \subsection{\texttt{Filter} y \texttt{Demuxer}}

% Como ya se sabe, los descriptores se encuentran en tablas. Pero para obtener las tablas es necesario antes construir la sección en la que se ubica la tabla. Entonces, si se buscan los descriptores de la \sdt, antes debe obtener suficientes paquetes con \pid\ 17(el correspondiente a la tabla) como para reconstruir la sección y luego, a partir de la misma, obtener la información que contiene, verificando ausencia de errores.

% De la tarea de filtrar paquetes con cierto \pid\ se encarga la clase \texttt{Filter}. De la segunda tarea se encargan las instancias de la clase \texttt{Demuxer}.

\section{IPTV, \emph{Internet protocol television}}

La \cref{def:iptv} de la \emph{International Telecommunication Union}, presentada en la \cref{sec:concep_prelim}, explica el término forma abstracta, en consideración de las posibles variantes del uso del término. Pone énfasis en la garantía de calidad y confiabilidad. Siendo que estos aspectos de la transmisión de televisión a través de internet no son centrales para este trabajo, se buscará acotar la definición para que se adapte al uso que se le dará en los caplitulos siguientes. Previo a introducir la misma, es necesario explorar aspectos específicos del medio para diferenciarlo del medio terrestre. 

\begin{itemize}
	\item \textbf{Bitrate varaible}: A diferencia de la señal radioeléctrica, el uso de ancho de banda se adapta a los contenidos transmitidos.
	\item \textbf{Conmutación de paquetes}: La delimitación de paquetes en las redes IP es una garantía de la infraestructura, no es necesario que el formato contenedor respete tamaños de información específicos, ni que el receptor se sincronice\footnote{Siempre y cuando se alineen los comienzos de paquetes TS y paquetes IP.}.
	\item \textbf{\emph{Multicasting}}: Las redes IP permiten la emisión multicast, ideal para los contenidos televisivos. La señal ISDB-Tb llega a todos los receptores(con alcance físico) por igual y estos optan por consumirla o ignorarla. En las redes IP, los \emph{hosts} deben solicitar la emisión para que esta les sea provista. Además, contar con la dirección IP y el puerto del grupo son suficientes para identificarlo y obtener los contenidos que emite.
	% TODO: Quizá algún ITEM más que se me esté pasando por alto.
\end{itemize}

El objetivo de este trabajo es incrementar el tamaño de la lista de servicios sin incurrir en una mayor exigencia de ancho de banda en el flujo de transporte. A partir del objetivo se puede elaborar una nueva definición de IPTV que se adecúa más al ámbito de desarrollo de estos objetivos.

\begin{definition}
	IPTV define la entrega de servicios audiovisuales en emisión \emph{multicast} a través de una red IP, donde cada servicio se limita a la multiplexación de un flujo de audio y uno de video junto con la información indispensable para la reproducción simultánea y sincronizada.
\end{definition}

\subsection{Multicasting IP}

El multicasting IP\cite{multicastip} es un método de envío de datagramas a través de una única transmisión, a un grupo de receptores interesados. Es una técnica \emph{uno a muchos} utilizada en la entrega de contenidos multimedia en tiempo real, como es el caso de IPTV.

El protocolo más común de capa de transporte utilizado para multicast IP es UDP\cite{udp}. UDP no posee protección ante pérdida de paquetes o errores de transmisión, de modo que es necesario contemplar estos problemas en alguna de las capas superiores. 

Para soportar multicasting, los \emph{routers} de una red IP debe dar soporte y permitir su uso a los \emph{host} de la misma. El multicasting IP consiste en un conjunto de \emph{grupos multicast} identificados unívocamente por una dirección IP. En el caso de IP versión 4, las direcciones que identifican grupos multicast van desde \emph{224.0.0.0} hasta \emph{239.255.255.255}. Cuando un \emph{host} desea comenzar a recibir los paquetes correspondientes a una emisión multicast, debe unirse al grupo multicast por el cual se realiza la emisión. Cabe notar que los paquetes UDP poseen un puerto destino, de modo que también es necesario conocer el puerto al que se envian estos paquetes. 

Con \emph{multicasting} IP acaba la lista de conceptos necesarios para la comprensión de la combinación de medios explorada en el capítulo que continúa. Lo que resta estudiar es la forma de encastrar las piezas existentes y cubrir las brechas que aparezcan, evitando construir agentes de software complejos que rompan las compatibilidades existentes y los objetivos de este trabajo. 

\ifx\all\undefined
\end{document}
\fi