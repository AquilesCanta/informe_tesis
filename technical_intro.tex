\ifx\all\undefined
\include{base}
\begin{document}
\fi
\chapter{Introducción técnica}

\textbf{ISDB-Tb} es un estándar de transmisión de televisión digital terrestre de origen japonés con modificaciones brasileñas. Es el adoptado en Argentina. La multiplexación de los servicios respeta el estándar \textbf{MPEG-2 Transport Stream}. Los reproductores de televisión digital terrestre deben adoptar estas normas para capturar, demultiplexar, procesar y entregar los servicios al usuario. \textbf{Lifia} lleva adelante el desarrollo del proyecto \emph{Kuntur} que incluye, entre otras cosas, el reproductor de televisión digital \emph{Wari}.

\section{Transmisión}

La TV terrestre aprovecha el espectro de radiofrecuencia para la transmisión de contenido. La señal se divide en canales físicos de 6 MHz por los que viaja un flujo multiplexado de servicios. Cada uno de estos canales dispone de un \emph{bitrate} constante definido por los parámetros de modulación. La capacidad máxima de transmisión del sistema \textbf{ISDB-Tb} es de unos 23 Mbps[TODO: agregar cita a Liendo].

Esta limitación de bitrate establece una cota superior para el número se servicios ofrecidos. Dependiendo ulteriormente del ancho de banda requerido por los mismos. Para ejemplificar, con esquemas de compresión MPEG-4 AVC, se consiguen promedios de unos 3 Mbps para un video SD y 13 Mbps para HD. [TODO: Glosario de siglas]

\subsection{Estructura general del sistema \textbf{ISDB-Tb}}

El sistema \textbf{ISDB-Tb} se puede dividir en niveles. [NOTA: Esta imagen debe cambiarse para respetar un esquema de colores y traducirse al español]

\includegraphics[width=8cm]{imgs/services.png}

\begin{itemize}
\item \textbf{Red de transmisión o \emph{network}:} Uno o más flujos de transporte emitidos por una misma entidad.
\item \textbf{Flujo de transporte:} Un flujo \textbf{MPEG-2} que lleva uno o más servicios.
\item \textbf{Servicio:} Algún contenido que puede consumir un receptor, \eg\ un canal de televisión, un canal de radio o un servicio de ingeniería. 
\item \textbf{Evento:} Un programa de televisión. Dos eventos de un mismo servicio sólo están diferenciados por el momento en que se está sintonizando un servicio específico.
\item \textbf{Flujo elemental o \emph{elementary stream}:} Un evento está compuesto por uno o más flujos elementales. A su vez, puede contener más de un flujo del mismo tipo. \eg\ un show de televisión puede estar emitiéndose en varios idiomas al mismo tiempo (un audio en inglés y otro en español). Los flujos elementales requieren de la mayor parte del ancho de banda de un flujo de transporte.
\end{itemize}

\section{Multiplexación}

La estructura del flujo multiplexado de servicios está dado por el formato estándar \textbf{MPEG-2 TS}. El mismo se compone de paquetes de tamaño fijo de 188 \emph{bytes} que contienen un prefijo de 4 \emph{bytes} con varias utilidades. Uno de los campos primordiales transporta el \emph{packet identifier}(\textbf{PID}) del paquete, que consiste en un entero sin signo de 13 \emph{bits} que asigna el paquete a un flujo específico.

El contenido de un flujo de transporte se puede dividir en información y contenido multimedia. El primer grupo, los datos que se incorporan al \emph{ts}, viajan en forma de tablas sobre un formato específico denominado ``secciones'', a diferencia del audio y el video, que utilizan paquetes \pes. Tanto las secciones como los paquetes \pes\ tienen longitud variable y potencialmente muy superior a la de un paquete \textbf{TS} de 188 \emph{bytes}. Luego, se dividen para poder ser enviados a través de este esquema. Parte de la responsabilidad de un receptor es reconstruir estas estructuras. 

\subsection{Tablas}

Como se mencionó ya, es necesario incluir información al \emph{ts} a fin de identificar los servicios que incluye y proveer al receptor de datos útiles. Estos contenidos viajan en tablas, las cuales se clasifican en 3 tipos:
\begin{itemize}
\item \textbf{PSI (Program Specific Information):} Contienen información esencial sobre la composición del flujo \textbf{TS}, necesaria para que el receptor pueda demultiplexar y decodificar los distintos servicios. Son tablas obligatorias. En este grupo se encuentran las tablas \pat, \cat\ y \pmt. La \pat\ y \pmt\ serán explicadas más adelante. La \cat\ incluye datos referentes al acceso condicional.
\item \textbf{SI (System information):} Contiene información asociada a servicios y eventos. Son tablas privadas, algunas de ellas opcionales. A este conjunto pertenecen la \textbf{BAT}, \textbf{NIT}, \textbf{SDT}, \textbf{EIT}, \textbf{TDT}, \textbf{TOT} y \textbf{ST}. Más adelante se revisará la \textbf{SDT}. 
\item \textbf{ECM, EMM y DSM-CC:} Contienen información relacionada con el manejo de claves de acceso, información de control y datos de usuarios, entre otros. La DSM-CC envía información de acceso a servicios digitales interactiovs. Estas tablas escapan al alcance de este trabajo. [TODO: Esto me hace ruido. Quizás se debería eliminar.]
\end{itemize}


\subsubsection{\emph{Program allocation table}}

La \pat\ es la primera tabla que debe buscar el decodificador. Viaja con \pid\ 0. Existe una \pat\ por flujo de transporte. Lleva información general del flujo y de la red de transmisión. Más importante aún, la \pat\ entrega al decodificador la asociación \textbf{PMT}(que se explica a continuación) con \textbf{PID}. Cada \textbf{PMT} corresponde a un servicio incluido en el \textbf{Transport stream}. Es decir que la \pat\ describe una lista de los servicios del \emph{ts}. A cada uno de estos le corresponde un número identificador que será utilizado por el resto de las tablas para adjuntar información específica, como el nombre, su tipo o \emph{elementary streams}.

\subsubsection{\emph{Program mapping table}}

La \pmt\ define los programas. Tiene un \pid\ referido por la \pat. Cada \pmt\ está asociada a un servicio que viaja por el \emph{ts} y le permite al decodificador acceder a los paquetes que llevan los \emph{elementary streams} a través de la definición de sus respectivos \pid. Además de esta asociación incluye información de los flujos elementales.

\subsubsection{\emph{Service description table}}

La \sdt\ describe con más detalle que otras los programas transportados por un \emph{ts}. Es una tabla descriptiva, como el nombre lo indica, en términos de que incluye información textual sobre el servicio, como su nombre. También establece de qué tipo de servicio se trata: radio, TV, \etc

\subsection{Descriptores}

Buena parte de la información de las tablas viaja en un formato de longitud variable denominado ``descriptores''. Cada descriptor es identificado unívocamente por un \emph{descriptor tag} que ocupa un \emph{byte}. El segundo elemento que viaja en un descriptor es un campo denominado \emph{descriptor length} que denota la longitud $l$ de la estructura en \emph{bytes}. Los siguientes $l$ \emph{bytes} transportan el contenido del descriptor propiamente dicho.

Los descriptores viajan en \emph{loops} de descriptores, y no existe una limitación para la cantidad que pueden viajar en un mismo \emph{loop}. Tampoco existen restricciones para el orden en que deben viajar los descriptores y el mismo no tiene influencia sobre el significado de los mismos. 

\subsection{\emph{Packetized elementary streams}}

El contenido multimedia enviado en un \emph{ts} utiliza paquetes \textbf{PES}, que poseen longitud variable. Estos paquetes se dividen luego entre paquetes \textbf{TS} para ser multiplexados finalmente al flujo de transporte resultante. El formato \textbf{MPEG-TS} permite la multiplexación de varios servicios de \emph{bitrate} variable, pero el \emph{ts} debe garantizar la salud de los \emph{buffers} del receptor. Esto es, en ningún punto de la reproducción del servicio pueden ocurrir \emph{overflows} o \emph{underflows}. Esto implica que en ningún punto de la transmisión la suma de los \emph{bitrates} individuales debe exceder al \emph{bitrate} del \emph{ts}.

\section{Decodificación}

El reproductor \emph{Wari} se utiliza la librería \textbf{mpeg-parser}, también incluida en el proyecto \emph{Kuntur}, para la manipulación de \textbf{MPEG-TS}. La responsabilidad de esta libería es capturar los paquetes de \textbf{Transport stream}, reconstruir secciones y flujos elementales, para identificar los servicios y poder entregarlos para su reproducción.

\subsection{Obtención de servicios}

La lectura de los servicios de un \emph{ts} se hace de forma independiente respecto del medio del cual se obtiene. A fin de comprender cualquier tipo de modificación de la librería \textbf{mpeg-parser}, es necesario ver el proceso de obtención y reproducción de servicios:

\begin{enumerate}
\item Se sintoniza el canal físico por el que viaja el \emph{ts} que lleva el servicio.
\item Se filtra la \pat\ y se obtiene de la misma el \pid\ con el que viaja la \pmt\ asociada al servicio.
\item Se filtra la \pmt\ del servicio y se extraen los \pid\ de los flujos elementales, sean audio y video.
\item Los \pid\ de los flujos elementales se entregan a la librería \emph{Canvas}. [TODO: No se ha introcido aún la librería]
\end{enumerate}

\subsection{Reproducción}

La entrega de los flujos al reproductor se realiza a través de una URL que incluye los \pid\ de los flujos elementales componentes del servicio a entregar. Una característica a notar de la librería \emph{Canvas} que interpreta la URL es la naturaleza polimórfica del parámetro, dado que interpreta esquemas (o protocolos) diversos. \eg:

\begin{itemize}
\item srvdtv://videoPID:1234\&audioPID:5678 [TODO: Agregar un ejemplo bien]
\item udp://@127.0.0.1:4000
\end{itemize}

El primero corresponde a un \emph{ts} consumido desde un dispositivo de sintonización de radiofrecuencia. El segundo a un socket alocado localmente asignado al puerto 4000. Es interesante notar que tal URL no debe estar necesariamente ligada un socket local.

\section{Descripción de clases}

\includegraphics[width=12cm]{imgs/classes.png}

A continuación se presentan descripciones de las clases más relevantes de la librería \textbf{mpeg-parser} en términos de identificación y entrega de servicios. El enfoque es descendente. Esto es, las primeras clases son las más cercanas a conceptos ya presentadas y, a partir de ellas, se reduce el nivel de abstracción.

\subsection{\texttt{Tuner}}

Esta clase(podría traducirse como \texttt{Sintonizador}), provee interfaz para escanear y sintonizar servicios, y es accedida directamente desde las librerías que utilizan \textbf{mpeg-parser}. Para realizar estas tareas hace uso de la jerarquía compuesta por \texttt{ServiceProvider} y su superclase \texttt{ServiceManager}.

\subsection{\texttt{ServiceProvider}}

Permite comenzar el proceso de \emph{scanning} de servicios. Al detectar un servicio, crea el modelo del mismo, asociando un \emph{listener} sobre el flujo de transporte para los elementos del \emph{ts} relacionados a los servicios como lo son su \pmt, la \sdt, la \nit\ y sus respectivos flujos elementales. Estos últimos sólo al momento de su reproducción. Este modelo es reflejado por la clase \texttt{Service}. 

\texttt{Service provider} es una especialización de \texttt{ServiceManager}, pero actualmente no existe otra utilidad para la clase más genérica, por ello no se realiza una diferenciación explícita de las responsabilidades de cada una. 

\subsection{\texttt{Service}}

Modela un servicio de alguno de los \emph{ts} capturados por la librería. Entre otras responsabilidades, procesa las tablas y descriptores encontrados en una tabla, modificándose acordemente. Lleva información sobre los flujos elementales componentes que resulta necesaria para la sintonización del servicio.

\subsection{Tablas: \texttt{PAT}, \texttt{PMT}, \texttt{SDT}}

Cada tabla del estándar posee un modelo que la refleja en la librería e incluye toda la información que pudiera viajar por estos medios. De esta manera, un servicio adquiere su nombre a través del procesamiento de una instancia de la clase que corresponde a la \sdt.

\subsection{\texttt{Descriptors}}

Esta clase modela un \emph{loop} de descriptores. Cada descriptor posee a su vez una representación a través de un registro \texttt{struct}, sin comportamiento. El servicio utiliza la información que obtenga del descriptor de la forma que corresponda. Es importante remarcar que una clase descriptors se modela con un arreglo de \emph{bytes}, de modo que el salto de abstracción se debe realizar de alguna manera. De este proceso se encargan los \emph{descriptor parsers}.

\subsection{Macro: \texttt{DESC\_PARSE}, \emph{descriptor tag} y función asociada}

Los servicios usan el \texttt{DESC\_PARSE} para encontrar descriptores en un \emph{loop} de descriptores. Para esto, se debe iterar una función de \emph{parsing} a lo largo de todo el arreglo. A cada paso, en el proceso de iteración, se invoca la función de \emph{parsing} asociada al \emph{descriptor tag} encontrado. La asociación se realiza a nivel de compilación por \emph{matching} de nombres descriptor/función.

La función de \emph{parsing} entonces recibe un arreglo de \emph{bytes} con un \emph{offset} que permite encontrar el comienzo de su descriptor dentro del \emph{loop}. A partir de ahí utiliza el formato para extraer los datos que transporta.

\subsection{\texttt{Filter} y \texttt{Demuxer}}

Como ya se sabe, los descriptores se encuentran en tablas. Pero para obtener las tablas es necesario antes construir la sección en la que se ubica la tabla. Entonces, si se buscan los descriptores de la \sdt, antes debe obtener suficientes paquetes con \pid\ 17(el correspondiente a la tabla) como para reconstruir la sección y luego, a partir de la misma, obtener la información que contiene, verificando ausencia de errores.

De la tarea de filtrar paquetes con cierto \pid\ se encarga la clase \texttt{Filter}. De la segunda tarea se encargan las instancias de la clase \texttt{Demuxer}.

\ifx\all\undefined
\end{document}
\fi