\ifx\all\undefined
\include{base}
\begin{document}
\fi
\chapter{Introducción técnica}

La televisión digital(TVD) es un servicio innovador que significa la mayor revolución tecnológica en el rubro televisivo desde la televisión a color en la década del '50. El término \textbf{Televisión digital} define a la transmisión de audio y video a través de una señal procesada y multiplexada digitalmente, en contrapartida con la señal analógica utilizada por la \emph{televisión analógica}, antecesora de la primera. Muchos países continúan hoy en día reemplazando la televisión analógica por televisión digital, haciendo un mejor y más variado uso del espectro de radiofrecuencia.

Las ventajas de la televisión digital por sobre la analógica son numerosas:
\begin{enumerate}
\item Exhibe una mejor calidad de sonido e imagen.
\item Permite contenidos en alta definición.
\item Posibilita la multiprogramación, dado que permite la transmisión de varias señales en el mismo ancho de banda asignado a la emisora.
\item Permite que se integren y complementen los contenidos con Internet.
\item Permite nuevos servicios asociados a la interactividad y otros como la guía electrónica de programación, ejecución de aplicaciones, \etc.
\item Ahorra ancho de banda. Es posible transmitir más servicios en el mismo ancho de banda.
\item Permite brindar servicios a una mayor cantidad de dispositivos, como teléfonos celulares, computadoras portátiles, GPS con sintonizador, \etc.
\item Permite que un contenido audivisual pueda verse en diferentes aparatos con diferentes calidades, esto se conoce como \emph{producción para multiplataforma}.
\end{enumerate}

El término televisión digital define a cualquier formato de difusión de programación de audio y video digitalizado, que utiliza \emph{bits} como medio de codificación de la información esencial y que puede ser canalizado por distintos medios y distintos protocolos. Los principales medios utilizados son:
\begin{itemize}
\item Terrestre: Emite la señal través del espectro de radiofrecuencia de la atmósfera terrestre.
\item Satelital: Consiste en retransmitir desde un satélite una señal emitida desde un punto en la Tierra. 
\item Cable: Utilizan la señal propagada por redes de cable coaxial o fibra óptica.
\item IPTV: Consiste en la distribución de programación y servicios mediante redes que utilizan la \emph{suite} de protocolos IP.
\end{itemize}

Las primeras dos categorías se denominan \emph{de radiodifusión}, dado que utilizan el espectro radioeléctrico en formato \emph{broadcast}. Son considerados servicios públicos y se encuentran rigurosamente legislados y regulados en todos los países del mundo. Teniendo en mente particularmente el caso de la televisión digital terrestre (\textbf{TDT}), hay cuatro estándares ampliamente adoptados en el mundo:

\begin{itemize}
\item \emph{Terrestrial Integrated Services Digital Broadcasting (ISDB-T)}: Adoptado en Japón y las islas Filipinas. \textbf{ISDB-T International} es una una adaptación de este estándar ha sido adoptado en gran parte de sudamérica.
\item \emph{Digital Video Broadcasting-Terrestrial (DVB-T)}: Estándar adoptado en Europa, Australia y Nueva Zelanda. 
\item \emph{Advanced Television System Committee (ATSC)}: Estándar adoptado en Estados Unidos, Canadá, México, Corea del Sur, República Dominicana y Honduras.
\item \emph{Digital Terrestrial Multimedia Broadcasting (DTMB)}: Estándar adoptado en la República Popular China, incluyendo Hong Kong y Macao.
\end{itemize} 

La última categoría, IPTV, generalmente hace uso de redes privadas que emplean la infraestructura de planteles telefónicos, tendidos eléctricos (BPL, \emph{broadband over power lines}), cable coaxial o fibra óptica. Los proveedores de servicios suelen proveer un \emph{set top box} o receptor junto con la conexión. Al ser redes privadas, el formato de la distribución de contenidos no está regulada. 

\section{ISDB-Tb}

\textbf{ISDB-Tb} es un estándar de transmisión de televisión digital terrestre de origen japonés con modificaciones brasileñas. Es el adoptado en Argentina.

\subsection{Modulación y bitrate disponible}

La TV terrestre aprovecha el espectro de radiofrecuencia para la transmisión de contenido. La señal se divide en canales físicos de 6 MHz por los que viaja un flujo multiplexado de servicios. Cada uno de estos canales físicos dispone de un \emph{bitrate} constante definido por los parámetros de modulación. La capacidad máxima de transmisión del sistema \textbf{ISDB-Tb} es de unos 23 Mbps[TODO: agregar cita a Liendo] que debe distribuirse entre los contenidos a transmitir.

\begin{figure}[h!]
	\includegraphics[width=12cm]{imgs/cable_flujo_mpeg.png}
	\caption{Diagrama de composición de un flujo de transporte} 
	\centering 
\end{figure}

La limitación de bitrate de los canales físicos establece una cota superior para el número se servicios ofrecidos. Dependiendo ulteriormente del ancho de banda requerido por los mismos. Con esquemas de compresión MPEG-4 AVC, se consiguen promedios de unos 3 Mbps para un video SD y 13 Mbps para HD. [TODO: Glosario de siglas]

Para ejemplificar, un fragmento de la señal emitida por el canal 23 (frecuencia 527 Mhz) de la Televisión Digital Abierta argentina[TODO: Agregar cita de tda] de Junio de 2014 dispone de un ancho de banda de 17,3 Mbps. Presenta 3 servicios: TV Pública HD(un video HD, dos audios), Tecnópolis(un video SD, un audio) y TV Pública(un video LD, un audio). El bitrate promedio para estos videos es $11,7$Mbps, $2,0$Mbps y $0,3$Mbps, respectivamente. Lo cual suma un total de $14$ Mbps. Los audios toman un bitrate promedio de $0,4$ Mbps entre los 4. Parte de los $2,9$ Mpbs restantes son utilizados para \emph{closed caption}, guía electrónica de programación y datos adicionales.

Cuando el contenido de un canal físico no llega a cubrir el ancho de banda disponible, el emisor debe completar con contenido \emph{dummy} que el receptor debe ignorar. De modo que en la muestra utilizada por el ejemplo anterior, un promedio de $2,4$ Mbps son llenados con contenidos sin más finalidad que completar el bitrate disponible.

Considerando los promedios del ejemplo, podría pensarse en la posibilidad de agregar un servicio LD sin riesgo de que falte bitrate. No obstante, es importante tener en mente que las magnitudes presentes son calculadas por promedio. En el caso del servicio HD, el video alcanza los $24$ Mbps, por momentos. Por la variabilidad del bitrate de los contenidos multimedia, es necesario que la suma de los bitrate promedio sea inferior al bitrate total si se busca una calidad estable en los servicios. 

% +---------------+---------------+---------------+---------------+
% |PID            |Bytes          |Percentage     |Mbps           |
% +---------------+---------------+---------------+---------------+
% |0              |280496         |            0.0|            0.0|
% +---------------+---------------+---------------+---------------+
% |16             |28012          |            0.0|            0.0|
% +---------------+---------------+---------------+---------------+
% |17             |13912          |            0.0|            0.0|
% +---------------+---------------+---------------+---------------+
% |18             |2308264        |            0.7|            0.1|
% +---------------+---------------+---------------+---------------+
% |20             |5640           |            0.0|            0.0|
% +---------------+---------------+---------------+---------------+
% |36             |28012          |            0.0|            0.0|
% +---------------+---------------+---------------+---------------+
% |39             |41736          |            0.0|            0.0|
% +---------------+---------------+---------------+---------------+
% |258            |280496         |            0.0|            0.0|
% +---------------+---------------+---------------+---------------+
% |259            |280496         |            0.0|            0.0| PMT del servicio 59202
% +---------------+---------------+---------------+---------------+
% |288            |485416         |            0.1|            0.0| Probablemente PES
% +---------------+---------------+---------------+---------------+
% |289            |218471416      |           67.7|           11.7| Video HD
% +---------------+---------------+---------------+---------------+
% |290            |1830932        |            0.5|            0.0| Probablemente PES
% +---------------+---------------+---------------+---------------+
% |291            |4685524        |            1.4|            0.2| Probablemente PES
% +---------------+---------------+---------------+---------------+
% |304            |485416         |            0.1|            0.0| Ni idea, probablemente PES (tiene PCR)
% +---------------+---------------+---------------+---------------+
% |305            |37562964       |           11.6|            2.0| VIDEO SD, pero igual a los de abajo.
% +---------------+---------------+---------------+---------------+
% |306            |1874172        |            0.5|            0.1| Ni idea, probablemente PES
% +---------------+---------------+---------------+---------------+
% |528            |121448         |            0.0|            0.0| Ni idea, probablemente PES (tiene PCR)
% +---------------+---------------+---------------+---------------+
% |529            |6201556        |            1.9|            0.3| Ni idea, probablemente PES
% +---------------+---------------+---------------+---------------+
% |530            |935488         |            0.2|            0.0| Ni idea, probablemente PES
% +---------------+---------------+---------------+---------------+
% |532            |42300          |            0.0|            0.0| Es un PES pero no se aún de qué
% +---------------+---------------+---------------+---------------+ 
% |8136           |280496         |            0.0|            0.0| PMT del programa 59224
% +---------------+---------------+---------------+---------------+
% |8191           |46091208       |           14.2|            2.4|
% +---------------+---------------+---------------+---------------+


\section{MPEG Transport stream}
 
 El formato de los datos mencionado previamente está definido por el estándar \textbf{MPEG-2 Transport Stream} o \emph{flujo de transporte}, o simplemente \textbf{MPEG-TS}. Esto se debe a que el flujo de transporte MPEG está diseñado para ambientes de transmisión o persistencia no confiables, es decir, con presencia de errores. En el caso de ISDB-Tb, este medio son los canales físicos de radiofrecuencia.

[TODO:  MPEG-2 ISO/IEC standard 13818-1 or ITU-T Rec. H.222.0]

La capacidad de transmisión de cada canal físico de radiofrecuencia permite la inclusión de varios servicios. El flujo de transporte MPEG permite la multiplexación se servicios con bitrates variables independientes e incluye mecanismos para la identificación y presentación de estos servicios. Se puede pensar en cada canal físico como un flujo constante de bits. Para organizar este sistema, el flujo de transporte MPEG agrupa los bits en paquetes de 188 bytes. 

Los paquetes de longitud fija poseen la característica de simplificar la inclusión de campos para la detección y corrección de errores. A su vez, permite transportar varios servicios en una misma línea de tiempo, sin la necesidad de contar con una referencia de reloj común a todos ellos, puesto que se intercalan paquetes de cada uno.

\subsection{Análisis de la estructura general del sistema \textbf{MPEG-TS}}

Para analizar la estructura del sistema \textbf{MPEG-TS}, ampliaremos sobre el ejemplo anterior del canal 23. A continuación se detallan los pasos que deber seguir un dispositivo de recepción para brindar los servicios al usuario:

\begin{enumerate}
\item Cada canal físico ISDB-T transporta un flujo de transporte independiente. El receptor debe comenzar su funcionamiento con un ``SCAN'', que consiste en recorrer todas las frecuencias posibles, sincronizándose y memorizando información del sistema.

En el ejemplo, el SCAN habrá recorrido la frecuencia 527MHz, memorizando toda la información que su flujo de transporte provee. Ejemplo de esta información son el nombre de la red transmisora (``RTA C23''), los nombres de los servicios (``TV Pública'', ``TV Pública HD'' y ``Tecnópolis'') o el nombre del flujo de transporte (``TVPublica'').

\item De acuerdo a lo obtenido en el paso anterior, se debe construir la lista de servicios, que queda disponible para que el usuario pueda seleccionar cualquiera independientemente del servicio sintonizado en ese momento. También se incluye en este paso información de la guía electrónica de programación, si la hubiera.

En el ejemplo, los tres servicios se sumarían a todos los de otros flujos de transporte de otros canales físicos, como ``Encuentro'' de canal 22 (Frecuencia 521Mhz).

\hrulefill

\item Si el usuario está mirando ``TV Pública HD'' y decide sintonizar ``Encuentro'', es necesario realizar un salto de frecuencia en el receptor. Esto se debe a que el primero viene por el canal 23 (Frecuencia 527MHz) y el segundo por el canal físico 22 (Frecuencia 521MHz). Si por el contrario el usuario quisiera sintonizar ``Tecnópolis'' en lugar de ``Encuentro'', este paso podría ignorarse, dado que ambos se encuentran en el mismo flujo de transporte, ya sintonizado.

El proceso de cambiar de canal físico, implica demodular la nueva señal y sincronizarse con la emisión, para distinguir el comienzo de cada paquete e interpretar correctamente la información.

\item Una vez el receptor esté recibiendo el flujo buscado, debe lograr distinguir y filtrar los paquetes que pertenecen al servicio requerido por el usuario. Es decir, si se sintoniza ``Encuentro'', el receptor debe decodificar el video de este canal de televisión, y no de ``TV Pública HD''. Lo mismo ocurre con audio y \emph{closed caption}.

\item Para finalizar, todo el contenido multimedia debe ser redirigido a los dispositivos de entrega: Televisor, monitor y altavoces, dispositivo móvil, etc.

\item Un cambio de servicio de parte del usuario, implica comenzar desde el paso 3.


\end{enumerate}

\subsubsection{Estructura de los paquetes \textbf{MPEG-TS}}

Cada paquete de un flujo de transporte contiene un prefijo de 4 \emph{bytes}. El primer byte de ellos es el byte de sincronización, que sirve al receptor para identificar el comienzo de los paquetes. Entonces, cuando el receptor sintoniza un canal de radiofrecuencia dado, debe utilizar este campo para encontrar el comienzo de los paquetes.

Otro campo del prefijo transporta el \emph{packet identifier}(\textbf{PID}) del paquete, que consiste en un entero sin signo de 13 \emph{bits} que identifica los contenidos. Con este identificador, el receptor puede filtrar los paquetes. Tanto de datos como de video y audio.

\begin{figure}[h!]
	\includegraphics[width=14cm]{imgs/ts_packet.png}
	\caption{Estructura de un paquete de flujo de transporte} 
	\centering 
\end{figure}



% \subsubsection{Secciones}

% El último grupo, los metadatos que se incorporan al flujo de transporte con información \emph{sobre} el mismo, viajan en construcciones sintácticas sobre un formato específico denominado ``secciones''. Las consrucciones sintácticas mencionadas se denominan \textbf{tablas}. El problema de la transmisión de secciones, es que las mismas poseen longitud variable y potencialmente más grande que lo que permite transportar un sólo paquete de flujo de transporte. Por ello, las secciones se deben dividir entre tantos paquetes como sean necesarios. Puede establecerse una analogía y decir que las secciones son a las tablas lo que los paquetes \pes\ son al audio y video.

% \subsubsection{Flujos elementales}

% El primer grupo de contenido, el que incluye a los audios y videos, corresponde a los flujos elementales o \emph{elementary streams}. Típicamente, un servicio de televisión dispone de al menos un flujo elemental de audio y un flujo elemental de video. En el caso de ``Televisión Pública HD'' del ejemplo anterior, el servicio dispone de un video HD y dos audios.

% El formato con que viajan los audios y videos se denomina \emph{Packetized elementary stream}(\pes). Cada paquete \pes\ de este formato es de longitud variable y, de forma general, se puede asumir más grande que un paquete de flujo de transporte. Por eso, los paquetes \pes\ se dividen entre los paquetes de flujo de transporte. A fin de posibilitar la reconstrucción, todos los paquetes que pertenecen al mismo flujo elemental viajan con el mismo PID.

% En el ejemplo, el servicio ``Televisión Pública HD'', el video viaja con el PID 289 y los audios con PID 290 y 291. Cabe notar que los flujos elementales también pueden corresponder a \emph{closed caption} y contenido interactivo. 

\subsection{Tablas}

A excepción del 5, los pasos que realiza el receptor requieren de información por parte del emisor, fuera del contenido multimedia propiamente dicho. Por ejemplo, para construir la lista de servicios. Para esto, se utilizan las \textbf{tablas}. Las tablas son una definición sintáctica para entregar información al receptor.

Los paquetes tienen tamaño de 188 bytes y disponen de aún menos para enviar contenidos. Las tablas, por ejemplo, pueden exceder este tamaño. Por ello viajan en un formato denominado ``secciones'' de longitud variable, que se dividen entre tantos paquetes como sean necesarios. El receptor debe recostruir las secciones para obtener las tablas que contiene. 

El formato \textbf{MPEG-TS} define una lista de tablas, donde cada una cumple un rol específico. A su vez, ISDB-T extiende esta lista con algunas tablas. Una lista completa de las tablas de formato \textbf{ISDB-T} se incluye en [TODO: Agregar apéndice].

\subsubsection{\emph{Program allocation table} (\pat)}

La \pat\ es la primera tabla que debe buscar el decodificador para sintonizar un servicio. Viaja con \pid\ 0. Existe una \pat\ por flujo de transporte y asocia a cada servicio con un \textbf{PID}. La identificación del servicio se hace a través del número de \emph{service\_id}.

\subsubsection{\emph{Program map table} (\pmt)}

La \pmt\ define los contenidos multimedia que corresponden a un programa. El \pid\ que tiene asignado un servicio por \pat, es el \pid\ con el que viaja la \pmt\ de tal servicio. Esta tabla le permite al decodificador acceder a los paquetes que llevan los flujos con contenidos multimedia a través de sus respectivos \pid. 

\subsubsection{\emph{Service description table} (\sdt)}

La \sdt\ describe con más detalle que otras los programas transportados por un \emph{ts}. Es una tabla descriptiva, como el nombre lo indica, en términos de que incluye información textual sobre el servicio, como su nombre. También establece de qué tipo de servicio se trata: radio, TV, \etc

\subsubsection{\emph{Network Information Table} (\nit)}

La transmisión de la \nit\ es obligatoria en los sistemas de televisión terrestre. Contiene información obligatoria sobre la organización física de la red de transmisión que la emite, pero también de forma opcional puede enviar información de otras redes.

\subsubsection{Descriptores}

Dentro de las tablas, parte de la información viaja en un formato de longitud variable denominado ``descriptores''. Cada descriptor es identificado numéricamente de forma unívoca por un \emph{descriptor tag} que ocupa un \emph{byte}. El segundo elemento que viaja en un descriptor es un campo denominado \emph{descriptor length} que denota la longitud $l$ de la estructura en \emph{bytes}. Los siguientes $l$ \emph{bytes} transportan el contenido del descriptor propiamente dicho.

Los descriptores viajan en \emph{loops} de descriptores, y no existe una limitación para la cantidad que pueden viajar en un mismo \emph{loop}. Tampoco existen restricciones para el orden en que deben viajar los descriptores y el mismo no tiene influencia sobre el significado de los mismos. Una lista completa de los tipos de descriptores de ISDB-T se provee en [TODO: Apéndice de descriptores].

Un ejemplo de descriptor es el \emph{service descriptor} con \emph{descriptor tag} 0x48 que transporta una descripción de un servicio, incluyendo el nombre. En el caso del ejemplo del canal 23, la SDT transporta un \emph{service descriptor} por cada uno de los servicios. Es del mismo desde donde se obtienen los nombres ``TV Pública'', ``TV Pública HD'' y ``Tecnópolis''.

\subsection{Decodificación de tablas en flujos de transporte}

Se define a continuación la relevancia de las tablas en el proceso de obtención de servicios para el usuario:

 \begin{enumerate}

\item En el proceso de SCAN, la información del sistema se obtiene de las tablas \nit\ y \sdt. De la primera se extrae la información relacionada con la red de transmisión. De la segunda se extrae la información de los servicios. Para decodificar estas tablas el receptor filtra los paquetes por los que viajan de acuerdo a su \pid. La \nit\ viaja con \pid\ 0x10 y la \sdt\ viaja con \pid\ 0x11. El proceso de decodificación incluye la extracción de cualquier descriptor que incluya la tabla. 

\item La construcción de la lista de servicios se basa en la \sdt. Del \emph{service\_descriptor}, el receptor puede obtener el nombre y el tipo de servicio, para distinguir televisión de radio, por ejemplo.

\hrulefill

\item La sintonización de un canal físico es un proceso independiente de los contenidos de los flujos de transporte salvo por la asociación entre servicio y frecuencia. Esto es, si el usuario decide reproducir ``TV Pública HD'' de la lista, del paso 2, luego de haber memorizado la información de la SDT, el receptor sabe que se encuentra en el canal 23. Nuevamente, si el servicio que se estaba sintonizando hasta entonces ya se encontraba en la misma frecuencia, como ``Tecnópolis'', el cambio de frecuencia es innecesario.

\item Una vez el canal físico está en sintonía, y el receptor sincronizado con el flujo de transporte, el receptor debe reconstruir la sección que viaja con \pid\ 0 y que corresponde a la \pat. En la tabla encontrará los 3 servicios. Sabiendo que el nombre ``TV Pública HD'' corresponde al \emph{service\_id} [[[TODO AGREGAR EL SERVICE ID]]], de la \pat\ se obtiene el PID con que viaja la \pmt. En el caso de la muestra de canal 23, éste es [[[TODO: Agregar PID de la PMT de TV PUBLICA HD]]].

\item Conociendo el \pid, el receptor extrae los \pid\ de los flujos elementales y de los relojes para sincronizar audio y video. Con ésta información, ya es posible reconstruir los contenidos multimedia. En el caso del ejemplo [[[TODO: agregar pids de audio y video en el ejemplo.]]]

\item Para finalizar, todo el contenido multimedia debe ser redirigido a los dispositivos de entrega: Televisor, monitor y altavoces, dispositivo móvil, etc.

\item Un cambio de servicio de parte del usuario, implica comenzar desde el paso 3.


\end{enumerate}




% \subsection{\emph{Packetized elementary streams}}

% El contenido multimedia enviado en un \emph{ts} utiliza paquetes \textbf{PES}, que poseen longitud variable. Estos paquetes se dividen luego entre paquetes \textbf{TS} para ser multiplexados finalmente al flujo de transporte resultante. El formato \textbf{MPEG-TS} permite la multiplexación de varios servicios de \emph{bitrate} variable, pero el \emph{ts} debe garantizar la salud de los \emph{buffers} del receptor. Esto es, en ningún punto de la reproducción del servicio pueden ocurrir \emph{overflows} o \emph{underflows}. Esto implica que en ningún punto de la transmisión la suma de los \emph{bitrates} individuales debe exceder al \emph{bitrate} del \emph{ts}.

\subsection{Generación de \emph{transport streams}}

OpenCaster es un proyecto de código abierto para la construcción de flujos de transporte de acuerdo al formato \textbf{MPEG-TS}. Incluye un número de herramientas que van desde la creación de paquetes, secciones y tablas hasta la multiplexación del \emph{ts}.

El proyecto OpenCaster provee una API para \emph{Python} desde la cual se pueden ensamblar tablas aprovechando las características de programación orientada a objetos que provee el lenguaje. Una vez construido un modelo de la tabla, el mismo se serializa a un arreglo de \emph{bytes} con el formato \textbf{MPEG-TS}. Esta API provee una librería de elementos que incluye tablas y descriptores, junto con los campos asociados a cada una.

La utilización de la API requiere crear un \emph{script} que genere las estructuras buscadas. Desde el mismo se importan las clases provistas, se instancian y luego, el comportamiento heredado permite serializarlas y empaquetarlas. El producto de la ejecución del \emph{script} son secciones ya divididas en paquetes listas para ser multiplexadas al \emph{ts}.

Una vez se poseen todas las componentes del flujo, las mismas se pueden multiplexar a través de la herramienta provista en el proyecto. Con esta herramienta se puede determinar el \emph{bitrate} final del \emph{ts}. Es necesario tener en cuenta el \emph{bitrate} de los flujos elementales contenidos para evitar que la distribución de la carga final sea errónea.

\section{Decodificación}

 \textbf{Lifia} lleva adelante el desarrollo del proyecto \emph{Kuntur} que incluye, entre otras cosas, el reproductor de televisión digital \emph{Wari}.

El reproductor \emph{Wari} se utiliza la librería \textbf{mpeg-parser}, también incluida en el proyecto \emph{Kuntur}, para la manipulación de \textbf{MPEG-TS}. La responsabilidad de esta libería es capturar los paquetes de \textbf{Transport stream}, reconstruir secciones y flujos elementales, para identificar los servicios y poder entregarlos para su reproducción. La reproducción es realizada por la librería \emph{Canvas}, también parte de \emph{Kuntur}.

\subsection{Obtención de servicios}

La lectura de los servicios de un \emph{ts} se hace de forma independiente respecto del medio del cual se obtiene. A fin de comprender cualquier tipo de modificación de la librería \textbf{mpeg-parser}, es necesario ver el proceso de obtención y reproducción de servicios:

\begin{enumerate}
\item Se sintoniza el canal físico por el que viaja el \emph{ts} que lleva el servicio.
\item Se filtra la \pat\ y se obtiene de la misma el \pid\ con el que viaja la \pmt\ asociada al servicio.
\item Se filtra la \pmt\ del servicio y se extraen los \pid\ de los flujos elementales, sean audio y video.
\item Los \pid\ de los flujos elementales se entregan a la librería \emph{Canvas}.
\end{enumerate}

\subsection{Reproducción}

La entrega de los flujos al reproductor se realiza a través de una URL que incluye los \pid\ de los flujos elementales componentes del servicio a entregar. Una característica a notar de la librería \emph{Canvas} que interpreta la URL es la naturaleza polimórfica del parámetro, dado que interpreta esquemas (o protocolos) diversos. \eg:

\begin{itemize}
\item srvdtv://audioPID=4000,audioType=3,pcrPID=3000,videoPID=3000,videoType=2
\item udp://@127.0.0.1:4000
\end{itemize}

El primero corresponde a un \emph{ts} consumido desde un dispositivo de sintonización de radiofrecuencia. El segundo a un socket alocado localmente asignado al puerto 4000. Es interesante notar que tal URL no debe estar necesariamente ligada un socket local.

\section{Descripción de clases}

\includegraphics[width=12cm]{imgs/classes.png}

A continuación se presentan descripciones de las clases más relevantes de la librería \textbf{mpeg-parser} en términos de identificación y entrega de servicios. El enfoque es descendente. Esto es, las primeras clases son las más cercanas a conceptos ya presentadas y, a partir de ellas, se reduce el nivel de abstracción.

\subsection{\texttt{Tuner}}

Esta clase(podría traducirse como \texttt{Sintonizador}), provee interfaz para escanear y sintonizar servicios, y es accedida directamente desde las librerías que utilizan \textbf{mpeg-parser}. Para realizar estas tareas hace uso de la jerarquía compuesta por \texttt{ServiceProvider} y su superclase \texttt{ServiceManager}.

\subsection{\texttt{ServiceProvider}}

Permite comenzar el proceso de \emph{scanning} de servicios. Al detectar un servicio, crea el modelo del mismo, asociando un \emph{listener} sobre el flujo de transporte para los elementos del \emph{ts} relacionados a los servicios como lo son su \pmt, la \sdt, la \nit\ y sus respectivos flujos elementales. Estos últimos sólo al momento de su reproducción. Este modelo es reflejado por la clase \texttt{Service}. 

\texttt{Service provider} es una especialización de \texttt{ServiceManager}, pero actualmente no existe otra utilidad para la clase más genérica, por ello no se realiza una diferenciación explícita de las responsabilidades de cada una. 

\subsection{\texttt{Service}}

Modela un servicio de alguno de los \emph{ts} capturados por la librería. Entre otras responsabilidades, procesa las tablas y descriptores encontrados en una tabla, modificándose acordemente. Lleva información sobre los flujos elementales componentes que resulta necesaria para la sintonización del servicio.

\subsection{Tablas: \texttt{PAT}, \texttt{PMT}, \texttt{SDT}}

Cada tabla del estándar posee un modelo que la refleja en la librería e incluye toda la información que pudiera viajar por estos medios. De esta manera, un servicio adquiere su nombre a través del procesamiento de una instancia de la clase que corresponde a la \sdt.

\subsection{\texttt{Descriptors}}

Esta clase modela un \emph{loop} de descriptores. Cada descriptor posee a su vez una representación a través de un registro \texttt{struct}, sin comportamiento. El servicio utiliza la información que obtenga del descriptor de la forma que corresponda. Es importante remarcar que una clase descriptors se modela con un arreglo de \emph{bytes}, de modo que el salto de abstracción se debe realizar de alguna manera. De este proceso se encargan los \emph{descriptor parsers}.

\subsection{Macro: \texttt{DESC\_PARSE}, \emph{descriptor tag} y función asociada}

Los servicios usan el \texttt{DESC\_PARSE} para encontrar descriptores en un \emph{loop} de descriptores. Para esto, se debe iterar una función de \emph{parsing} a lo largo de todo el arreglo. A cada paso, en el proceso de iteración, se invoca la función de \emph{parsing} asociada al \emph{descriptor tag} encontrado. La asociación se realiza a nivel de compilación por \emph{matching} de nombres descriptor/función.

La función de \emph{parsing} entonces recibe un arreglo de \emph{bytes} con un \emph{offset} que permite encontrar el comienzo de su descriptor dentro del \emph{loop}. A partir de ahí utiliza el formato para extraer los datos que transporta.

\subsection{\texttt{Filter} y \texttt{Demuxer}}

Como ya se sabe, los descriptores se encuentran en tablas. Pero para obtener las tablas es necesario antes construir la sección en la que se ubica la tabla. Entonces, si se buscan los descriptores de la \sdt, antes debe obtener suficientes paquetes con \pid\ 17(el correspondiente a la tabla) como para reconstruir la sección y luego, a partir de la misma, obtener la información que contiene, verificando ausencia de errores.

De la tarea de filtrar paquetes con cierto \pid\ se encarga la clase \texttt{Filter}. De la segunda tarea se encargan las instancias de la clase \texttt{Demuxer}.

\section{IPTV, \emph{Internet protocol television}}

Se denomina de esta manera a cualquier contenido televisivo cuya entrega se realice a través de una red IP. Existen tres variantes de este tipo de servicios:

\begin{itemize}
\item \textbf{Televisión en vivo}: Entrega de manera simultánea a un grupo de receptores un servicio que se está emitiendo en el momento. Presenta la posibilidad de ser implementado a través de un esquema \emph{multicast}.
\item \textbf{Televisión en diferido}: Reproducción de un servicio que fue emitido previamente con una limitación predefinida de diferencia temporal.
\item \textbf{\emph{Video on demand}}: Entrega de un servicio elegido de un catálogo en cualquier momento. La única implementación posible es a través de \emph{unicast}.
\end{itemize}


\ifx\all\undefined
\end{document}
\fi