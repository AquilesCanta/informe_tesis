\ifx\all\undefined
\include{base}
\begin{document}
\fi
\chapter{Introducción técnica}

La Televisión Digital(TVD) es un servicio innovador que significa la mayor revolución tecnológica en el rubro televisivo desde la televisión a color en la década del '50.

El término \textbf{Televisión digital} define la transmisión de audio y video a través de una señal procesada y multiplexada digitalmente, en contrapartida con la señal analógica utilizada por la \emph{televisión analógica}, antecesora de la primera. Muchos países continúan hoy en día reemplazando la televisión analógica por televisión digital, haciendo un mejor y más variado uso del espectro de radiofrecuencia.

Las ventajas de la televisión digital por sobre la analógica son numerosas:
\begin{enumerate}
	\item Exhibe una mejor calidad de sonido e imagen.
	\item Permite contenidos en alta definición.
	\item Posibilita la multiprogramación, dado que permite la transmisión de varias señales en el mismo ancho de banda asignado a la emisora\footnote{En la televisión analógica existe una correspondencia unívoca entre los canales de radiofrecuencia y los servicios provistos por la emisora. Es decir, en cada canal viaja un único servicio. Por eso, en la televisión analógica se suele referir a los servicios como canales. El término correcto, sin embargo, es \emph{servicio}. Canal hace referencia a una división en el espectro de radiofrecuencia.}.
	\item Permite que un mismo servicio provea varios flujos distintos de un mismo tipo. Por ejemplo, para transmitir una película con audio en varios idiomas.
	\item Permite que se integren y complementen los contenidos con Internet. Por ejemplo, referenciando recursos que se encuentran en la web.
	\item Permite brindar servicios complementarios, como aplicaciones interactivas y guía electrónica de programación.
	\item Ahorra ancho de banda. Es posible transmitir más servicios en el mismo ancho de banda.
	\item Permite brindar servicios a una mayor cantidad de dispositivos, como teléfonos celulares, computadoras portátiles, o GPS's con sintonizador.
	\item Permite que un contenido audivisual pueda verse en diferentes aparatos con diferentes calidades, esto se conoce como \emph{producción para multiplataforma}. Esto es, que un mismo servicio se reproduzca con una resolución en un televisor, y con una menor en un dispositivo pequeño.
\end{enumerate}

El término televisión digital define a cualquier formato de difusión de programación de audio y video digitalizado, que utiliza \emph{bits} para codificar la información. Puede ser canalizada por distintos medios y viajar con distintos formatos. Los principales tipos de televisión digital son (ver \cite{liendo}):
\begin{itemize}
\item Terrestre: Emite la señal a través del espectro de radiofrecuencia de la atmósfera terrestre sobre las bandas UHF\footnote{\emph{Ultra High Frequency}: designación del \emph{Iternational Telecommunication Union} para las frecuencias que oscilan entre los 300MHz y 3GHz}.
\item Satelital: Consiste en retransmitir desde un satélite una señal emitida desde un punto en la Tierra utilizando SHF\footnote{\emph{Super High Frequency}: designación del \emph{Iternational Telecommunication Union} para las frecuencias que oscilan entre los 3GHz y 30GHz}. 
\item Cable: Utilizan la señal propagada por redes de cable coaxial o fibra óptica.
\item \emph{Internet Protocol Television}(IPTV): El término ha adquirido varias definiciones con el crecimiento de las tecnologías. En este marco utilizaremos la definición provista por la \emph{Internation Telecommunication Union}\cite{ituiptv}:

	IPTV define a la entrega de servicios como televisión/video/audio/texto/imágenes/datos sobre redes basadas en IP manejadas para proveer el nivel requerido de calidad de servicio y experiencia, seguridad, interactividad y confiabilidad.
% IPTV is defined as multimedia services such as television/video/audio/text/graphics/data delivered over IP based networks managed to provide the required level of quality of service and experience, security, interactivity and reliability.

\item \emph{Over the Top}(OTT): Consiste en la transmisión de televisión por internet. A diferencia de IPTV, al no utilizar una red manejada, no presenta garantías de calidad de servicio.
\end{itemize}

%TODO: Podemos agregar la categoría WebTV (OTT). Y explicar en qué se diferencia de IPTV, en el alcance de este informe.

Las primeras dos categorías se denominan \emph{de radiodifusión}, dado que utilizan el espectro radioeléctrico en emisión \emph{broadcast}. La televisión digital terrestre y satelital se encuentran rigurosamente legisladas y reguladas en todos los países del mundo\cite{liendotodospaisesdelmundo}. En el caso particular de la televisión digital terrestre, hay cuatro estándares ampliamente adoptados en el mundo:

\begin{itemize}
\item \emph{Terrestrial Integrated Services Digital Broadcasting (ISDB-T)}: Adoptado en Japón y las islas Filipinas. \textbf{ISDB-T International} (también denomiado \textbf{ISDB-Tb)} es una una adaptación de este estándar ha sido aplicado en gran parte de sudamérica. 
\item \emph{Digital Video Broadcasting-Terrestrial (DVB-T)}: Estándar adoptado en Europa, Australia y Nueva Zelanda. 
\item \emph{Advanced Television System Committee (ATSC)}: Estándar adoptado en Estados Unidos, Canadá, México, Corea del Sur, República Dominicana y Honduras.
\item \emph{Digital Terrestrial Multimedia Broadcasting (DTMB)}: Estándar adoptado en la República Popular China, incluyendo Hong Kong y Macao.
\end{itemize} 

\section{ISDB-Tb}

\textbf{ISDB-Tb} (o ISDB-T Internacional) es un estándar de transmisión de televisión digital terrestre. Fue desarrollado originalmente por la Asociación de Empresas e Industrias de Radio(ARIB\cite{arib}) del Japón y, posteriormente, incluyó modificaciones propuestas por la Asociación Brasileña de Normas Técnicas\cite{abnt}. Es la norma de televisión digital adoptada en Argentina y utilizada en la Televisión Digial Abierta (TDA\cite{tda}).

La televisión terrestre envía información a través del espectro de radiofrecuencia de la atmósfera que oscila entre los 300Mhz y los 3GHz. Al ser éste un fenómeno físico intrínsecamente analógico, la información digital que se desea transmitir se codifica por medio de variaciones de amplitud y fase de la señal. Estas variaciones se denominan \textbf{modulación}. ISDB-Tb permite utilizar varios parámetros de modulación distintos.

Por sobre la codificación de la información digital, la norma define una forma de organización de los bytes. Ésta organización compone lo que se denomina \emph{formato contenedor}. En el caso de ISDB-Tb, el formato contenedor de la transmisión es el \textbf{Flujo de Transporte MPEG} (\emph{MPEG Transport Stream}), definido en MPEG-2 ISO/IEC standard 13818.

\subsection{Modulación y bitrate disponible}

En la norma ISDB-Tb, el espectro de radiofrecuencia se divide en canales físicos de 6 MHz (denominados \emph{bandas UHF}) por los que viaja un flujo multiplexado de servicios, que denominaremos ``flujo de transporte''. Cada uno de estos canales físicos dispone de un \emph{bitrate} constante definido por los parámetros de modulación de la señal. La capacidad máxima de transmisión del sistema \textbf{ISDB-Tb} es de unos 23 Mbps\cite{liendo} que debe distribuirse entre los contenidos a transmitir.

\begin{figure}[h!]
	\begin{center}
	\includegraphics[width=8cm]{imgs/canal_fisico.png}
	\caption{Diagrama esquemático de un flujo de transporte} 
	\end{center}
\end{figure}

La limitación de bitrate de los canales físicos establece una cota superior para el número se servicios que puede transportar, dependiendo ulteriormente del ancho de banda requerido por los mismos. Cada servicio está compuesto a su vez por flujos más pequeños que llevan audio, video u otras componentes.

\begin{figure}[h!]
	\begin{center}
	\includegraphics[width=12cm]{imgs/cable_flujo_mpeg.png}
	\caption{Composición de servicios en un flujo de transporte} 
	\end{center}
\end{figure}

Para ejemplificar, un fragmento de la señal emitida por el canal 23 (frecuencia 527 Mhz) de la Televisión Digital Abierta argentina[TODO: Agregar cita de tda] de Junio de 2014 dispone de un ancho de banda de 17,3 Mbps. Presenta 3 servicios: TV Pública HD(un video HD, dos audios), Tecnópolis(un video SD, un audio) y TV Pública(un video LD, un audio). El bitrate promedio para estos videos se presenta en \cref{tab:avgbitrates}.

\begin{table}[H]
\begin{center}
\resizebox{\linewidth}{!}{
	\begin{tabular}{| l | c | c | c |}
	\hline 
	\textbf{Nombre del servicio} & \textbf{Tipo de video} & \textbf{Bitrate promedio utilizado} & \textbf{Porcentaje del bitrate del flujo utilizado}\\
	\hline 
	TV Pública HD & \emph{High Definition Video} & 11,7 Mbps & 67,7\% \\
	\hline
	TV Pública & \emph{Low Definition Video} & 0,3 Mbps & 1,9\% \\
	\hline
	Tecnópolis & \emph{Standard Definition Video} & 2,0 Mpbs & 11,7\% \\
	\hline
	\hline
	\textbf{Total:} & --- & 14 Mbps & 81,3\% \\
	\hline 
	\end{tabular}
}
\caption{Utilización de bitrate en ejemplo de Canal 23\label{tab:avgbitrates}}
\end{center}
\end{table}

En la \cref{tab:avgbitrates} resta indicar en qué se utiliza un 18,7\%(3.3 Mbps) del bitrate siendo que, como se ha dicho, el mismo es constante en la norma ISDB-Tb. Los audios toman un bitrate promedio de $0,4$ Mbps entre los 4. Una pequeña parte de los $2,9$ Mbps (específicamente $0,5$ Mpbs) restantes son utilizados para \emph{closed caption}, guía electrónica de programación, y datos.

Pero como en este caso, cuando el contenido de un canal físico no llega a cubrir el ancho de banda disponible, el emisor debe completar con contenido \emph{dummy} que el receptor debe ignorar. Este contenido se compone de \emph{paquetes nulos}. De modo que en la muestra utilizada por el ejemplo anterior, un promedio de $2,4$ Mbps son llenados con paquetes nulos. Contenidos sin más finalidad que completar el bitrate disponible.

Considerando los promedios del ejemplo, podría pensarse en la posibilidad de agregar un servicio LD sin riesgo de que falte bitrate. No obstante, es importante tener en mente que las magnitudes presentes son calculadas por promedio. En el caso del servicio HD, el video alcanza los $24$ Mbps, por momentos. Por la variabilidad del bitrate de los contenidos multimedia, es necesario que la suma de los bitrate promedio sea inferior al bitrate total si se busca una calidad estable en los servicios. 

% +---------------+---------------+---------------+---------------+
% |PID            |Bytes          |Percentage     |Mbps           |
% +---------------+---------------+---------------+---------------+
% |0              |280496         |            0.0|            0.0|
% +---------------+---------------+---------------+---------------+
% |16             |28012          |            0.0|            0.0|
% +---------------+---------------+---------------+---------------+
% |17             |13912          |            0.0|            0.0|
% +---------------+---------------+---------------+---------------+
% |18             |2308264        |            0.7|            0.1|
% +---------------+---------------+---------------+---------------+
% |20             |5640           |            0.0|            0.0|
% +---------------+---------------+---------------+---------------+
% |36             |28012          |            0.0|            0.0|
% +---------------+---------------+---------------+---------------+
% |39             |41736          |            0.0|            0.0|
% +---------------+---------------+---------------+---------------+
% |258            |280496         |            0.0|            0.0|
% +---------------+---------------+---------------+---------------+
% |259            |280496         |            0.0|            0.0| PMT del servicio 59202
% +---------------+---------------+---------------+---------------+
% |288            |485416         |            0.1|            0.0| Probablemente PES
% +---------------+---------------+---------------+---------------+
% |289            |218471416      |           67.7|           11.7| Video HD
% +---------------+---------------+---------------+---------------+
% |290            |1830932        |            0.5|            0.0| Probablemente PES
% +---------------+---------------+---------------+---------------+
% |291            |4685524        |            1.4|            0.2| Probablemente PES
% +---------------+---------------+---------------+---------------+
% |304            |485416         |            0.1|            0.0| Ni idea, probablemente PES (tiene PCR)
% +---------------+---------------+---------------+---------------+
% |305            |37562964       |           11.6|            2.0| VIDEO SD, pero igual a los de abajo.
% +---------------+---------------+---------------+---------------+
% |306            |1874172        |            0.5|            0.1| Ni idea, probablemente PES
% +---------------+---------------+---------------+---------------+
% |528            |121448         |            0.0|            0.0| Ni idea, probablemente PES (tiene PCR)
% +---------------+---------------+---------------+---------------+
% |529            |6201556        |            1.9|            0.3| Ni idea, probablemente PES
% +---------------+---------------+---------------+---------------+
% |530            |935488         |            0.2|            0.0| Ni idea, probablemente PES
% +---------------+---------------+---------------+---------------+
% |532            |42300          |            0.0|            0.0| Es un PES pero no se aún de qué
% +---------------+---------------+---------------+---------------+ 
% |8136           |280496         |            0.0|            0.0| PMT del programa 59224
% +---------------+---------------+---------------+---------------+
% |8191           |46091208       |           14.2|            2.4|
% +---------------+---------------+---------------+---------------+


\subsection{MPEG Transport stream}
 
 El formato contenedor de los datos que viajan en las emisiones ISDB-Tb, está definido por el estándar \textbf{MPEG-2 Transport Stream} o simplemente \emph{flujo de transporte}. El flujo de transporte MPEG posee características que lo hacen ideal para la televisión terrestre. 

\begin{itemize}
	\item Está diseñado para ambientes de transmisión o persistencia no confiables, es decir, con presencia de errores. En el caso de ISDB-Tb, este medio son los canales físicos de radiofrecuencia.
	\item El flujo de transporte MPEG permite la multiplexación se servicios con bitrates variables e independientes. Esto permite aprovechar al máximo la capacidad de transmisión de los canales de radiofrecuencia. Incluye mecanismos para la identificación y presentación de estos servicios.
	\item Especifica mecanismos para la sincronización de flujos de audio y video.
	\item Es un formato extensible para adecuarse a los medios sobre los que se utiliza.
\end{itemize}

La modulación de la señal, permite pensar en cada canal físico como un flujo constante de bits. Para organizarlo, el flujo de transporte MPEG agrupa los bits en paquetes de 188 bytes cada uno. Los paquetes de longitud fija poseen la característica de simplificar la inclusión de campos para la detección y corrección de errores. A su vez, permite transportar varios servicios en una misma línea de tiempo, sin la necesidad de contar con una referencia de reloj común a todos ellos, puesto que se intercalan paquetes de cada uno.

\subsection{Estructura de los paquetes \textbf{MPEG-TS}}

Desde el punto de vista de un receptor de señal, el flujo de transporte es una serie de dígitos binarios, de modo que es imposible definir dónde termina un paquete y comienza el siguiente. El receptor también necesita saber qué información viaja en el interior de un paquete, para interpretar el contenido binario. Con estos objetivos, entre otros, cada paquete de un flujo de transporte contiene un prefijo de 4 \emph{bytes}.

El primer byte de ellos es el byte de sincronización, que sirve al receptor para identificar el comienzo de los paquetes. Transporta siempre el valor 71 (0x47). Entonces, cuando el receptor sintoniza un canal de radiofrecuencia dado, debe utilizar este campo para encontrar el comienzo de los paquetes. Este proceso se conoce como \emph{sincronización}. El estándar \textbf{MPEG-TS}\cite{isoiec13818} define que, al encontrar 5 bytes de sincronización intercalados por 187 bytes, el receptor puede asumir que se ha sincronizado al flujo.

%El estándar de implementación de un sistema de recepción establece que al encontrar 5 bytes de sync en sus lugares, el receptor puede asumir que ha logrado sincronización. y si no encuentra uno en 3 lugares, ha perdido la sincronización.

Otro de los campos del prefijo transporta el \emph{packet identifier}(\textbf{PID}) del paquete, que consiste en un entero sin signo de 13 \emph{bits} que identifica los contenidos. Todo filtrado de paquetes en el flujo depende del valor que transporta el PID. Con este identificador, el receptor puede filtrar los paquetes de audio, video y datos.

\begin{figure}[H]
	\begin{center}
	\includegraphics[width=14cm]{imgs/ts_packet.png}
	\caption{Estructura de un paquete de flujo de transporte} 
	\end{center}
\end{figure}

Para información más detallada relacionada con la estructura de los paquetes del flujo de transporte ver [TODO: Apéndice].

\subsection{Consumo de emisión \textbf{ISDB-Tb}\label{sec:consumeisdbt}}

Los receptores de señal ISDB-Tb tienen dos tareas básicas. La primera tarea es entregar al usuario la lista de servicios disponibles. La segunda es reproducir aquel servicio que el usuario elija. Ambas necesitan la información provista a través del formato contenedor, el flujo de transporte MPEG. Para el análisis de los pasos, se usará como base el ejemplo de Canal 23.

\subsubsection{Construcción de la lista de servicios}

A diferencia de la televisión analógica, en televisión digital cada canal contiene más de un servicio, de forma general. Si se desea conocer los servicios que viajan por un canal, es necesario sintonizar ese canal e identificar los servicios a través de la información que contiene el flujo de transporte.

Cada canal físico ISDB-Tb transporta un flujo de transporte independiente. Antes de comenzar a funcionar normalmente, un receptor debe construir la lista de servicios, proceso que se conoce con el nombre de ``SCAN''. Esto consiste en recorrer todas las frecuencias posibles, sincronizándose y memorizando información del sistema. A partir de esta información, el receptor puede conocer los nombres de los servicios y su tipo. A su vez, recordará en qué canal se encuentra cada uno, para su posterior sintonización.

En el ejemplo, el SCAN debe recorrer el Canal 23 (frecuencia 527MHz), memorizando toda la información que su flujo de transporte provee. Ejemplo de esta información son el nombre de la red transmisora (``RTA C23''), los nombres de los servicios (``TV Pública'', ``TV Pública HD'' y ``Tecnópolis'') o el nombre del flujo de transporte (``TVPublica''). Estos tres servicios se sumarían a todos los de otros flujos de transporte de otros canales físicos, como ``Encuentro'' de canal 22 (Frecuencia 521Mhz).

El proceso de SCAN puede demorar algunos minutos, dependiendo de la cantidad de frecuencias recorridas. Por eso, la información obtenida y construida hasta aquí suele ser persistida. Así, aún luego de apagar el sistema de recepción, el usuario no requerirá volver a repetir este procedimiento.

\subsubsection{Sintonización de servicios}

Esta tarea se puede realizar únicamente una vez la lista de servicios está disponible y se debe llevar a cabo cada vez que el usuario solicita un servicio. 

\begin{enumerate}
\item Si el usuario está mirando ``TV Pública HD'' y decide sintonizar ``Encuentro'', es necesario realizar un salto de frecuencia en el receptor. El primero viene por Canal 23 (Frecuencia 527MHz) y el segundo por Canal 22 (Frecuencia 521MHz).

Si por el contrario el usuario quisiera sintonizar ``Tecnópolis'' en lugar de ``Encuentro'', este paso podría ignorarse, dado que ambos se encuentran en el mismo flujo de transporte, ya sintonizado.

El proceso de cambiar de canal físico, implica demodular la nueva señal y sincronizarse con la emisión, para distinguir el comienzo de cada paquete e interpretar correctamente la información.

\item Una vez el receptor esté recibiendo el flujo buscado, debe lograr distinguir y filtrar los paquetes que pertenecen al servicio requerido por el usuario. Es decir, si se sintoniza ``Encuentro'', el receptor debe decodificar el video de este canal de televisión, y no de ``TV Pública HD''. Lo mismo ocurre con audio.

\item Para finalizar, todo el contenido multimedia debe ser redirigido a los dispositivos de entrega: Televisor, monitor y altavoces, dispositivo móvil, etc.
\end{enumerate}



\subsection{Tablas}

En la televisión analógica, un sistema de recepción se limita a sintonizar un canal físico, interpretar la señal y reproducirla para el usuario. La televisión digital requiere de procesos más complejos, como la construcción de la lista de servicios. Para estos, el receptor requiere información por parte del emisor fuera del contenido multimedia propiamente dicho.

ISDB-Tb utiliza las \textbf{tablas} provistas por el formato \textbf{MPEG-TS} para entregar dicha información. Las tablas son una definición sintáctica para transportar información. El formato \textbf{MPEG-TS} define una lista de tablas, donde cada una cumple un rol específico. A su vez, ISDB-Tb extiende esta lista con algunas tablas. Una lista completa de las tablas de formato \textbf{ISDB-Tb} se incluye en [TODO: Agregar apéndice].

Los paquetes tienen tamaño de 188 bytes y disponen de aún menos para enviar contenidos. Las tablas, por ejemplo, pueden exceder este tamaño. Por ello viajan en un formato denominado ``secciones'' de longitud variable, que se dividen entre tantos paquetes como sean necesarios. El receptor debe recostruir las secciones para obtener las tablas que contiene. 

La \cref{fig:esquema_servicios_c23} muestra la relación entre las distintas tablas. Las referencias entre tablas se realizan a través del PID que tienen asignado. A continuación se desarrolla la utilidad de cada una.

\begin{figure}[H]
\begin{center}
\includegraphics[width=12cm]{imgs/canal_23_tables.png}
\caption{Esquema general de tablas en el ejemplo de Canal 23\label{fig:esquema_servicios_c23}}
\end{center}
\end{figure}


\subsubsection{\emph{Program allocation table} (\pat)}

La \pat\ es la primera tabla que debe buscar el decodificador para sintonizar un servicio. Viaja con \pid\ 0. Existe una \pat\ por flujo de transporte y asocia a cada servicio con un \textbf{PID}. La identificación del servicio se hace a través del número de \emph{service\_id}. El término programa se puede utilizar como sinónimo de servicio.\\

\begin{table}[H]
\begin{center}
\begin{tabular}{ l | c }
\emph{service\_id} & Program PID (o PID de PMT) \\
\hline 
59201 & 258 \\
59202 & 8136 \\
59224 & 259 \\
\end{tabular}
\caption{Contenidos de la PAT emitida por Canal 23}
\end{center}
\end{table}

\subsubsection{\emph{Program map table} (\pmt)}

La \pmt\ define los contenidos multimedia que corresponden a un programa. El \pid\ que tiene asignado un servicio por \pat, es el \pid\ con el que viaja la \pmt\ de tal servicio. Esta tabla le permite al decodificador acceder a los paquetes que llevan los flujos con contenidos multimedia a través de sus respectivos \pid.

Todos los paquetes de un mismo \pid\ que transportan contenido multimedia componen lo que se denomina \emph{flujo elemental}. De modo que la \pmt\ permite al receptor encontrar los flujos elementales.\\

\begin{table}[H]
\begin{center}
\begin{tabular}{ l | c }
Tipo de flujo & PID del flujo \\
\hline 
27(Video) & 289 \\
17(Audio) & 290 \\
17(Audio) & 291 \\
\end{tabular}
\caption{PMT que viaja con PID 258 en el ejemplo de Canal 23}
\end{center}
\end{table}

\subsubsection{\emph{Service description table} (\sdt)}

La \sdt\ describe con más detalle que otras los programas transportados por un flujo de transporte. Viaja con \pid\ 17. Es una tabla descriptiva, como el nombre lo indica, en términos de que incluye información textual sobre el servicio, como su nombre. También establece de qué tipo de servicio se trata: radio, TV, \etc\\

\begin{table}[H]
\begin{center}
\begin{tabular}{ l | c | c }
\emph{service\_id} & Nombre del servicio & Tipo del servicio \\
\hline 
59201 & TV Pública HD & Televisión \\
59202 & Tecnópolis & Televisión \\
59224 & TV Pública & (Data Service) Televisión Móvil \\
\end{tabular}
\caption{Contenidos de la SDT emitida por Canal 23}
\end{center}
\end{table}

\subsubsection{\emph{Network Information Table} (\nit)}

La transmisión de la \nit\ es obligatoria en los sistemas de televisión terrestre. Viana con \pid\ 16 y contiene información obligatoria sobre la organización física de la red de transmisión que la emite, pero también de forma opcional puede enviar información de otras redes.

\subsubsection{Descriptores}

Dentro de las tablas, parte de la información viaja en un formato de longitud variable denominado ``descriptores''. Cada descriptor es identificado numéricamente de forma unívoca por un \emph{descriptor\_tag} que ocupa un \emph{byte}. El segundo elemento que viaja en un descriptor es un campo denominado \emph{descriptor\_length} que denota la longitud $l$ de la estructura en \emph{bytes}. Los siguientes $l$ \emph{bytes} transportan el contenido del descriptor propiamente dicho.

Los descriptores viajan en \emph{loops} de descriptores, y no existe una limitación para la cantidad que pueden viajar en un mismo \emph{loop}. Tampoco existen restricciones para el orden en que deben viajar los descriptores y el mismo no tiene influencia sobre el significado de los mismos. Una lista completa de los tipos de descriptores de ISDB-Tb se provee en [TODO: Apéndice de descriptores].

Un ejemplo de descriptor es el \emph{service\_descriptor} con \emph{descriptor\_tag} 72 que transporta una descripción de un servicio, incluyendo el nombre. En el caso del ejemplo del canal 23, la SDT transporta un \emph{service\_descriptor} por cada uno de los servicios. Es del mismo desde donde se obtienen los nombres ``TV Pública'', ``TV Pública HD'' y ``Tecnópolis''.

\subsubsection{Flujos elementales}


El formato con que viajan los audios y videos se denomina \emph{Packetized elementary stream}(\pes). Cada paquete \pes\ de este formato es de longitud variable y, de forma general, se puede asumir más grande que un paquete de flujo de transporte. Se puede establecer una analogía entre los paquetes \pes\ y las secciones. Igual que las secciones, los paquetes \pes\ se dividen entre los paquetes de flujo de transporte. 

A fin de posibilitar la reconstrucción, todos los paquetes que pertenecen al mismo flujo elemental viajan con el mismo PID. Todos estos paquetes con igual \pid\ componen un único flujo elemental. Típicamente, un servicio de televisión dispone de al menos un flujo elemental de audio y un flujo elemental de video. En el caso de ``Televisión Pública HD'' del ejemplo anterior, el servicio dispone de un video HD y dos audios.

En el ejemplo, el servicio ``Televisión Pública HD'', el video viaja con el PID 289 y los audios con PID 290 y 291. Cabe notar que los flujos elementales también pueden corresponder a \emph{closed caption} y contenido interactivo. 

\subsection{Decodificación de tablas en flujos de transporte\label{sec:tunesteps}}

Las tareas de construcción de lista de servicios y sintonización de servicios que se tratan en la \cref{sec:consumeisdbt} se basan en la información provista por las tablas de la norma ISDB-Tb. A continuación se detalla cómo influye cada una:

\subsubsection{Construcción de la lista de servicios}

El proceso de construcción de la lista de servicios se resume a recorrer todas las frecuencias por las que vienen flujos de transporte, capturando la información que viaja por la \sdt\ y \nit. El receptor, con la información contenida en ambas(en todos los flujos) y en sus respectivos descriptores ya puede ofrecer la lista completa. 

En este paso también se genera una asociación entre servicio y flujo de transporte. Es decir, el proceso de SCAN le indica al receptor que ``TV Pública HD'' es transmitido por Canal 23.

\subsubsection{Sintonización de servicios}

\begin{enumerate}
\item El primer paso es sintonizar el canal físico por el cual viaja el flujo de transporte que lleva el servicio deseado. El mismo se obtiene de la asociación generada en el SCAN.

\item Una vez el canal físico está en sintonía, y el receptor sincronizado con el flujo de transporte, el receptor debe reconstruir la sección que viaja con \pid\ 0, que corresponde a la \pat. 

En el ejemplo de Canal 23, en la tabla encontrará la lista con los 3 servicios. Sabiendo por la \sdt\ que el nombre ``TV Pública HD'' corresponde al \emph{service\_id} 59201, de la \pat\ se obtiene el PID con que viaja la \pmt, que en el ejemplo es 258.

\item Con el \pid\ de la \pmt, el receptor reconstruye la sección que lleva la tabla. De ella extrae los \pid\ de los flujos elementales. ``TV Pública HD'' envía dos flujos de audio (\pid s 290 y 291) y un flujo de video HD con \pid\ 289. Con éstos \pid, ya es posible reconstruir los contenidos multimedia.

\item Los flujos elementales deben decodificarse y enviarse a los periféricos de entrega.

\end{enumerate}

\section{Generación de contenido de señal ISDB-Tb}

El proceso de transformación de la información desde que se captura en un estudio de televisión hasta que es emitida por una antena emisora está compuesto por tres etapas:

\begin{enumerate}[label=\alph*]
\item \textbf{Generación de contenidos:} en una estación de televisión hay un conjunto de tecnologías para este fin. Cámaras, \emph{switchers}, generadores de efectos, consolas de audio, \etc. que entregan flujos elementales (audio y video) de alta velocidad para su posterior codificación. En general, cada flujo se entrega a \textbf{Codificación} por separado.
\item \textbf{Codificación y empaquetado:} en esta etapa se realiza la compresión del audio y video, para adaptarla a la capacidad de transmisión de los canales físicos. La información contenida en cada flujo elemental es segmentada en paquetes de bits llamados PES(\emph{Packetized elementary streams}), que luego son divididos nuevamente a paquetes \textbf{MPEG-TS} de 188 bytes. En general, cada programa genera tres flujos de paquetes \textbf{MPEG-TS}: video, audio y datos.
\item \textbf{Señalización y multiplexación de programas:} en la etapa final se compone el flujo binario \textbf{MPEG-TS} de entrega. Integra el audio, video y datos de los servicios que lo compongan, completamente optimizado para la transmisión. En este punto se incorporan las tablas que señalizan los servicios.
\end{enumerate}

Las herramientas involucradas en la señalización y multiplexación de programas deben seguir escrictos lineamientos de la norma ISDB-Tb(en concordancia con el formato MPEG-TS). Por ejemplo, cada \pmt\ debe encontrarse en el flujo de transporte con una periodicidad de 200 milisegundos. Existen varios proyectos de utilidades de televisión digital que resuelven estas exigencias.

\subsection{OpenCaster}

OpenCaster es un proyecto de código abierto (bajo licencia GPL\cite{gpl}) que incluye muchas de las herramientas necesarias para la construcción de flujos de transporte de acuerdo al formato \textbf{MPEG-TS}. Éstas van desde la creación de paquetes, secciones y tablas hasta la multiplexación del \emph{ts}.

OpenCaster provee una API para \emph{Python} desde la cual se pueden ensamblar tablas aprovechando \emph{hotspots} dispuestos en las clases que modelan tablas y descriptores. Una vez construido una instancia de una tabla, el mismo se serializa a un arreglo de \emph{bytes} con el formato \textbf{MPEG-TS}. Esta API provee una librería de elementos que incluye tablas y descriptores, junto con los campos asociados a cada una.

\subsubsection{Generación de Tablas}

La utilización de la API requiere crear un \emph{script} que genere las estructuras buscadas. Desde el mismo se importan las clases provistas, se instancian y luego, el comportamiento heredado permite serializarlas y empaquetarlas. El producto de la ejecución del \emph{script} son secciones ya divididas en paquetes listas para ser multiplexadas al flujo de transporte.

\lstinputlisting[language=Python,caption={Ejemplo de creación de tablas en OpenCaster}]{src_code/pmt_example.py}\label{lst:exampleopencaster}

\subsubsection{Multiplexación del flujo de transporte}

Una vez se poseen todas las componentes del flujo, las mismas se pueden multiplexar a través de una herramienta provista en el proyecto llamada \texttt{tscbrmuxer}. Con esta herramienta se puede determinar el \emph{bitrate} final del \emph{ts}. Es necesario tener en cuenta el \emph{bitrate} de los flujos elementales contenidos para evitar que la distribución de la carga final sea errónea.

\section{Recepción y decodificación de señal ISDB-Tb}

El estándar\cite{aribb21} establece especificaciones deseadas de recepción, decodificación y reproducción de los servicios de un flujo de transporte. Existen problemas complejos asociados al proceso.

\begin{itemize}
	\item La mayoría de los eventos de recepción y reproducción son asincrónicos.
	\begin{itemize}
		\item Para ejemplificar, la lectura de tablas implica esperar que lleguen al receptor todos los paquetes necesarios para construir la sección por la que viaja. Salvo por las limitaciones de tiempo que impone la norma sobre los tiempos de emisión de la misma, no hay forma de predecir el momento en que esto ocurre.
	\end{itemize}
	\item Es un sistema que debe responder correctamente a las exigencias de un sistema \emph{soft real time}\cite{realtime}.
	\begin{itemize}
		\item Por un lado, el flujo de transporte es una fuente constante de paquetes que se acumulan en un \emph{buffer}. Si el sistema no llega a consumir suficientes paquetes en un intervalo de tiempo determinado, esto puede incurrir en un \emph{overflow}, lo cual significa que existe pérdida, y esto a su vez se traduce en una degradación del servicio.
		\item Por el otro lado, la presentación de los cuadros del video debe responder a las exigencias de un sistema multimedia. La omisión de cuadros, si ocurre con suficiente periodicidad, también implica una degradación de la calidad.
	\end{itemize}
\end{itemize}

Éstas características hacen que los receptores sean sistemas \emph{multithreaded}. Esto se puede ver reflejado en la \cref{fig:flux_diagram_play} y la \cref{fig:flux_diagram_scan} que representan el proceso común de reproducción y SCAN de un reproductor. Estos pueden variar dependiendo de la implementación.

%
%
%
%
%
%
%
%
%
%%
%
%
%
%
% Agregar los diagramas de flujo y explicar un poco y después pasar a wari. Se sacó la máquina de estados pedorra que había
%

% La máquina de estados de la \cref{fig:player_state_machine} presenta los posibles estados de un reproductor de televisión digital básico. 

 \begin{figure}
	\begin{center}
	\includegraphics[height=19cm]{imgs/play_seq_diagram.png}
	\caption{Diagrama de flujo de reproducción\label{fig:flux_diagram_play}} 
	\end{center}
\end{figure}

 \begin{figure}
	\begin{center}
	\includegraphics[height=13cm]{imgs/scan_seq_diag.png}
	\caption{Diagrama de flujo de reproducción\label{fig:flux_diagram_scan}} 
	\end{center}
\end{figure}

\subsection{Reproductor de Televisión Digital Wari}

\emph{Wari} es un reproductor de televisión digital en la norma ISDB-Tb ideado para ser utilizado en computadoras personales. Es actualmente desarrollado y mantenido por Lifia\cite{lifia}, bajo la licencia LGPL\cite{lgpl}.

Está desarrollado mayoritariamente en C++ y es un sistema \emph{multithreaded}. Con el único fin de simplificar, los diagramas de secuencia que se introducen a continuación se representan como sistemas de un único hilo.

En realidad, Wari utiliza un \emph{dispatcher} de tareas a través del cual los hilos se asignan invocaciones de funciones que deben ser realizadas cuando el control está disponible. Para la notificación de finalización de estas tareas (como podría ser la lectura satisfactoria de una tabla), se puede utilizar este mismo mecanismo o invocación de funciones \emph{callback}.

En [TODO: Apéndice ] se realiza una breve explicación del sistema de comunicación de \emph{threads} en Wari. Para más información, el se puede consultar el sitio de descarga de código fuente y manuales de Wari.

\subsection{Construcción de lista de servicios en Wari}

Contruir la lista de servicios consiste en identificar todos los servicios que aparecen en todos los flujos de transporte disponibles para el sistema receptor. En el caso común, recorrer las \sdt\ de todos los flujos de transporte sería suficiente, dado que esta indica los nombres y tipos de los servicios. No obstante, Wari realiza un proceso algo diferente explicado en la \cref{fig:descparse_wari}, donde intervienen la \pat\ y \pmt.

\begin{figure}[]
\begin{center}

\resizebox{\linewidth}{!}{
\input{diagrams/descriptor_parsing_sequence_diagram}
}
\caption{Diagrama de Secuencia de construcción de lista de servicios en Wari\label{fig:descparse_wari}}
\end{center}
\end{figure}

La solicitud del usuario de un SCAN lleva a la invocación del método \texttt{startScan} de la clase \texttt{Tuner}. Ésta solicitará sistemáticamente al \texttt{Provider} que sintonice las frecuencias disponibles.

Sobre cada una de las frecuencias, el \texttt{ServiceProvider} esperará por la \sdt, la \pat, y la \pmt. Cuando las tablas llegan al \texttt{Provider}, se notifica a las instancias de la clase \texttt{Service} correspondiente, y esta se actualiza acordemente. Parte del procesamiento de las tablas, como se indica en la \cref{fig:descparse_wari}, implica procesar también los descriptores que incluye la tabla.

Para obtener las tablas \sdt, \pat, y \pmt, es necesario antes construir las secciones por las que viajan. A su vez, las secciones requieren de los paquetes sobre los que viajan. Los paquetes se asocian a las tablas a través del \pid. Cada tabla tiene un \pid\ asignado. 

Para obtener los paquetes de un \pid\ dado, el sistema utiliza los \emph{demuxers}. Los \emph{demuxers} son \emph{listeners} que se ubican sobre el flujo de transporte que esperan un paquete con un \pid\ dado. De modo que cuando el \texttt{ServiceProvider} desea construir la lista de servicios, le pide al \texttt{Provider} que cree un \emph{demuxer} para cada tabla que necesitan, a través del método \texttt{startFilter(aDemuxer)}\footnote{El método se llama \texttt{startFilter} en lugar de \texttt{startDemuxer} porque la componente que conecta el \emph{demuxer} con el flujo de transporte se llama \texttt{filter}.}. 

Un diagrama de la relación estática entre las clases del sistema se presenta en la \cref{fig:class_scan_diag}. 

\begin{figure}[]
\begin{center}

\resizebox{\linewidth}{!}{
\input{diagrams/descriptor_parsing_class_diagram}
}

\caption{Diagrama de Clases de parseo de descriptores en Wari\label{fig:class_scan_diag}}
\end{center}
\end{figure}

Descripción de la responsabilidad de las clases:
\begin{itemize}
	\item \texttt{Tuner} coordina el proceso de SCAN desde el tope de la jerarquía de abstracción. La clase \texttt{Tuner} responde a todos los requerimientos del \emph{Zapper}\footnote{Se denomina \emph{Zapper} a un dispositivo utilizado para sintonizar servicios en un televisor.} que utiliza el usuario. 
	\item \texttt{ServiceProvider} junto con \texttt{ServiceManager} gestionan los servicios(que se modelan a través de la clase \texttt{Service}), durante todo su ciclo de vida. Es esta clase la que posee la lista de servicios propiamente dicha.
	\item \texttt{Provider} encapsula y abstrae las operaciones de \emph{hardware} del dispositivo de sintonización subyacente. También gestiona los \emph{demuxers}. 
	\item Cada instancia de \texttt{Service}, finalmente, modela un servicio que viene por alguno de los flujos de transporte disponible. Guarda información como \emph{service\_id} nombre y tipo.  
\end{itemize}


\subsection{Recolección y reproducción de flujos elementales}

%%%
%%% Complete
%%%

El proceso de recolección de flujos consiste en la reconstrucción del flujo elemental original que se deconstruye en la multiplexación del flujo de transporte. Antes de comentzar la recolección, el receptor debe conocer los \pid\ de todos los flujos elementales requeridos para reproducir enteramente el servicio. Por ejemplo, en el caso de ``TV Pública HD'', se deben obtener del flujo de transporte todos los paquetes de \pid\ 289 y 290, que corresponden al video HD y al primero de los audios, respectivamente, como se indica en la \cref{fig:esquema_servicios_c23}.

El proceso de reproducción de flujos elementales, por el contrario, comienza una vez se dispone de los flujos elementales reconstruidos, luego que se ha realizado un \emph{buffering} de suficientes paquetes. Consiste en decodificarlos y obtener las imagenes y el audio que componen al servicio. En Wari, este proceso es realizado por algún reproductor existente. Sin embargo, el reproductor debe tener forma de acceder a estos flujos elementales.

La \cref{fig:playsecwari} presenta un diagrama de secuencia del proceso de recolección y reproducción de flujos elementales a partir de la solicitud de sintonización de un servicio. El proceso de decodificación escapa al objetivo de este informe.[TODO: ¿Apéndice?]

\begin{figure}[]
\begin{center}

\resizebox{\linewidth}{!}{
\input{diagrams/play_sequence_diagram_wari}
}
\caption{Diagrama de secuencia de infraestructura de reproducción en Wari\label{fig:playsecwari}}
\end{center}
\end{figure}

%Usa un callback que se llama onStarted. Pero nosotros los simplificamos.



La \cref{fig:classdiagramservices} muestra un diagrama de clases de la infraestructura relacionada con la recolección de flujos elementales. 

\begin{figure}[]
	\begin{center}

	\resizebox{\linewidth}{!}{
	\input{diagrams/play_class_diagram}
	}
	\caption{Diagrama de clases de infraestructura de reproducción en Wari\label{fig:classdiagramservices}}
	\end{center}
\end{figure}

Las clases representadas en la \cref{fig:classdiagramservices} son:
\begin{itemize}
	\item \texttt{PlayerExtension}: Representa la máxima abstracción en términos de reproducción de servicios que provienen de un flujo de transporte, gestiona los mecanismos de comunicación internos.
	\item \texttt{Player}: Es la superclase de la jerarquía de destinos de reproducción. Cualquier clase que vaya a representar un tipo de reproducción, debe ser sublcase de \texttt{Player}.
	\item \texttt{AvPlayer}: Representa el reproductor de Audio/Video de servicios que provienen de un flujo de transporte que se captura a través de un dispositivo sintonizador. 
	\item \texttt{ServiceManager} y \texttt{ServiceProvider}: La jerarquía gestiona el ciclo de vida de los servicios y encapsula todo el procesamiento relacionados con ellos, como el que se realiza en la captura de tablas relacionadas con servicios.
	\item \texttt{Tuner}: Clase que provee la interfaz genérica de un \emph{Zapper}. Permite escanear y sintonizar servicios.
	\item \texttt{Service}: Clase que modela a los servicios de los flujos de transporte disponibles para el receptor. Almacenan toda la información vinculada a los mismos, como nombre, id, o información de flujos elementales.
\end{itemize}

En Wari, cuando el usuario solicita el cambio de canal, el control llega e la clase \texttt{Tuner}. A partir de entonces, los pasos de ejecución responden al procedimiento indicado en \cref{sec:tunesteps}.

TODO: Explicación de recolección de flujos. Descripciones de clases del diagrama, intervención de URL en la reproducción a través de VLC u otro reproductor.

TODO: El proceso de recolección de flujos elementales implica solicitar a la clase \texttt{Provider} que filtre los paquetes con PID... TODO.

TODO: Finalmente indicarle al reproductor de audio y video cómo acceder a los flujos elementales.

% \{Obtención de servicios}

% La lectura de los servicios de un \emph{ts} se hace de forma independiente respecto del medio del cual se obtiene. A fin de comprender cualquier tipo de modificación de la librería \textbf{mpeg-parser}, es necesario ver el proceso de obtención y reproducción de servicios:

% \begin{enumerate}
% \item Se sintoniza el canal físico por el que viaja el \emph{ts} que lleva el servicio.
% \item Se filtra la \pat\ y se obtiene de la misma el \pid\ con el que viaja la \pmt\ asociada al servicio.
% \item Se filtra la \pmt\ del servicio y se extraen los \pid\ de los flujos elementales, sean audio y video.
% \item Los \pid\ de los flujos elementales se entregan a la librería \emph{Canvas}.
% \end{enumerate}

% \subsection{Reproducción}

% La entrega de los flujos al reproductor se realiza a través de una URL que incluye los \pid\ de los flujos elementales componentes del servicio a entregar. Una característica a notar de la librería \emph{Canvas} que interpreta la URL es la naturaleza polimórfica del parámetro, dado que interpreta esquemas (o protocolos) diversos. \eg:

% \begin{itemize}
% \item srvdtv://audioPID=4000,audioType=3,pcrPID=3000,videoPID=3000,videoType=2
% \item udp://@127.0.0.1:4000
% \end{itemize}

% El primero corresponde a un \emph{ts} consumido desde un dispositivo de sintonización de radiofrecuencia. El segundo a un socket alocado localmente asignado al puerto 4000. Es interesante notar que tal URL no debe estar necesariamente ligada un socket local.

% \section{Descripción de clases}

% \includegraphics[width=12cm]{imgs/classes.png}

% A continuación se presentan descripciones de las clases más relevantes de la librería \textbf{mpeg-parser} en términos de identificación y entrega de servicios. El enfoque es descendente. Esto es, las primeras clases son las más cercanas a conceptos ya presentadas y, a partir de ellas, se reduce el nivel de abstracción.

% \subsection{\texttt{Tuner}}

% Esta clase(podría traducirse como \texttt{Sintonizador}), provee interfaz para escanear y sintonizar servicios, y es accedida directamente desde las librerías que utilizan \textbf{mpeg-parser}. Para realizar estas tareas hace uso de la jerarquía compuesta por \texttt{ServiceProvider} y su superclase \texttt{ServiceManager}.

% \subsection{\texttt{ServiceProvider}}

% Permite comenzar el proceso de \emph{scanning} de servicios. Al detectar un servicio, crea el modelo del mismo, asociando un \emph{listener} sobre el flujo de transporte para los elementos del \emph{ts} relacionados a los servicios como lo son su \pmt, la \sdt, la \nit\ y sus respectivos flujos elementales. Estos últimos sólo al momento de su reproducción. Este modelo es reflejado por la clase \texttt{Service}. 

% \texttt{Service provider} es una especialización de \texttt{ServiceManager}, pero actualmente no existe otra utilidad para la clase más genérica, por ello no se realiza una diferenciación explícita de las responsabilidades de cada una. 

% \subsection{\texttt{Service}}

% Modela un servicio de alguno de los \emph{ts} capturados por la librería. Entre otras responsabilidades, procesa las tablas y descriptores encontrados en una tabla, modificándose acordemente. Lleva información sobre los flujos elementales componentes que resulta necesaria para la sintonización del servicio.

% \subsection{Tablas: \texttt{PAT}, \texttt{PMT}, \texttt{SDT}}

% Cada tabla del estándar posee un modelo que la refleja en la librería e incluye toda la información que pudiera viajar por estos medios. De esta manera, un servicio adquiere su nombre a través del procesamiento de una instancia de la clase que corresponde a la \sdt.

% \subsection{\texttt{Descriptors}}

% Esta clase modela un \emph{loop} de descriptores. Cada descriptor posee a su vez una representación a través de un registro \texttt{struct}, sin comportamiento. El servicio utiliza la información que obtenga del descriptor de la forma que corresponda. Es importante remarcar que una clase descriptors se modela con un arreglo de \emph{bytes}, de modo que el salto de abstracción se debe realizar de alguna manera. De este proceso se encargan los \emph{descriptor parsers}.

% \subsection{Macro: \texttt{DESC\_PARSE}, \emph{descriptor tag} y función asociada}

% Los servicios usan el \texttt{DESC\_PARSE} para encontrar descriptores en un \emph{loop} de descriptores. Para esto, se debe iterar una función de \emph{parsing} a lo largo de todo el arreglo. A cada paso, en el proceso de iteración, se invoca la función de \emph{parsing} asociada al \emph{descriptor tag} encontrado. La asociación se realiza a nivel de compilación por \emph{matching} de nombres descriptor/función.

% La función de \emph{parsing} entonces recibe un arreglo de \emph{bytes} con un \emph{offset} que permite encontrar el comienzo de su descriptor dentro del \emph{loop}. A partir de ahí utiliza el formato para extraer los datos que transporta.

% \subsection{\texttt{Filter} y \texttt{Demuxer}}

% Como ya se sabe, los descriptores se encuentran en tablas. Pero para obtener las tablas es necesario antes construir la sección en la que se ubica la tabla. Entonces, si se buscan los descriptores de la \sdt, antes debe obtener suficientes paquetes con \pid\ 17(el correspondiente a la tabla) como para reconstruir la sección y luego, a partir de la misma, obtener la información que contiene, verificando ausencia de errores.

% De la tarea de filtrar paquetes con cierto \pid\ se encarga la clase \texttt{Filter}. De la segunda tarea se encargan las instancias de la clase \texttt{Demuxer}.

\section{IPTV, \emph{Internet protocol television}}

Adaptando la definición anterior a las necesidades de este trabajo, IPTV es la transmisión de televisión digital sobre una red manejada que utiliza la \emph{suite} de protocolos IP. Las redes manejadas permiten aprovechar la infraestructura para garantizar estándares de calidad.

En el caso de televisión, donde el número de receptores suele ser grande y el contenido se distribuye sin modificación, el esquema de transmisión multicast es el ideal.

\subsection{Multicasting}

Desarrollar conceptos:
\begin{enumerate}
	\item Máxima unidad de transmisión
	\item Routing multicast
	\item UDP.
\end{enumerate}


\ifx\all\undefined
\end{document}
\fi