\ifx\all\undefined
\include{base}
\begin{document}
\fi

\newpage

\chapter{Introducción al \emph{MPEG-2 Transport Stream}} \label{App:AppendixA}

En este apéndice se revisan conceptos introductorios útiles del flujo de transporte MPEG. Inicialmente se realiza un recorrido sobre el ciclo de vida de los contenidos. Luego se estudia más en detalle la estructura de la información en el formato. Si bien este apéndice tiene caracter informativo, la referencia ulterior es el estándar oficial. En lo que a formato de datos respecta, particulamente el documento ARIB STD-B10.

\section{Codificación y empaquetado de los datos}

\begin{figure}[h!]
\begin{centering}
	\includegraphics[width=12cm]{imgs/appendix_data_gen.png}
	\caption{Diagrama funcional de una estación de televisión digital terrestre\label{fig:appendix_data_gen}} 
\end{centering}
\end{figure}

La \cref{fig:appendix_data_gen} es una imagen simplificada de una estación que produce contenidos de televisión digital. Los componentes incluídos en la imagen son los siguientes:

\begin{itemize}
	\item \textbf{Generación de programa:} Las estaciones de TV incluyen equipamiento para la creación del servicio que se entrega finalmente al espectador. Dentro de este equipamiento se encuentras las cámaras, los \emph{switchers}\footnote{Equipo selector del video utilizado en el servicio a emitir.}, los generadores de efectos, los distribuidores, consolas de audio, etc. La salida de esta etapa es un flujo de contenido binario a tasas elevadas, no aptas para la distribución a través de radiofrecuencia.
	\item \textbf{Codificación}: La señal recibida es codificada y empaquetada en bloques que contienen una cantidad relativamente reducida de bits, conformando un flujo de paquetes de longitud variable.
	\item \textbf{Paquetización y Multiplexación:} Los paquetes producidos en la etapa anterior son nuevamente fragmentados para producir paquetes de tamaño aún menor, esta vez de longitud fija, utilizados en el flujo de transporte MPEG \emph{transport stream}. Es necesario en esta etapa incluir datos adicionales relativos al programa, como nombre, metainformación de transmisión y de demultiplexación.
	\item \textbf{Multiplexación de programas:} Es poco común la transmisión de un flujo de transporte con un único servicio. En esta etapa se combinan varios para construir un \textbf{MPTS}, \emph{Multiple Program Transport Stream}.
	\item \textbf{Remultiplexación:} Esta etapa recibe el flujo de transporte con múltiples servicios y le agrega información útil de transmisión, que incluye \emph{timestamps} entre otras cosas. Al resultado de esta etapa se lo denomina \emph{Broadcast transport stream}.
	\item \textbf{Modulador y transmisor:} En esta última etapa, la información es convertida en una señal de radiofrecuencia que luego es emitida por la antena.
\end{itemize}

\subsection{Formato de paquetes TS}

La información recibida por los receptores se estructura en el flujo de transporte. Este formato se adapta perfectamente a la televisión digital terrestre. Por la longitud de los paquetes, es fácil la inclusión de datos para corrección de errores. Por sus mecanismos de multiplexación, es posible incluir varios servicios simultáneamente, sin contar con una referencia de reloj común. 

El flujo TS incluye paquetes de audio, video y datos. Además, otros paquetes suministran información para el receptor. En demultiplexación, la separación de paquetes es posible gracias a sus encabezados que incluyen un byte de sincronización y un PID (\emph{Packet Identifier}), que identifica el contenido.

\begin{figure}[h!]
\begin{centering}
	\includegraphics[width=9cm]{imgs/appendix_ts_packet.png}
	\caption{Representación de un paquete TS.\label{fig:appendix_ts_packet}} 
	\centering 
\end{centering}
\end{figure}


La \cref{fig:appendix_ts_packet} representa un paquete de un flujo de transporte, que se compone de un total de 1504 bits. Los primeros 4 bytes forman el encabezado del paquete. El primero de estos es el byte de sincronización que siempre contiene el valor $47_H$ (71 en notación decimal). Siendo fija la longitud de los paquetes TS, no es necesario un campo de longitud de \emph{payload} que es siempre 184. Cuando un decodificador halla 5 bytes de sincronización consecutivos, asume que ha logrado sincronizarse con la señal\footnote{Asimismo, un error en tres bytes de sincronización consecutivos se consideran pérdida de sincronismo.}.

La longitud de los paquetes TS es fija. Siendo que los datos no se pueden ubicar arbitrariamente hasta rellenar este tamaño, a veces es necesario completar con contenidos descartables. Con este fin y otros, existe el campo de adaptación que se ubica en el encabezado de 4 bytes. En caso de que este campo esté presente, el encabezado aumenta su tamaño.

\begin{figure}[h!]
\begin{centering}
	\includegraphics[width=14cm]{imgs/appendix_ts_packet_detail.png}
	\caption{Estructura del encabezado del paquete de flujo de transporte\label{fig:appendix_ts_packet_detail}} 
	\centering 
\end{centering}
\end{figure}

La \cref{fig:appendix_ts_packet_detail} presenta en detalle la estructura del encabezado de los paquetes. La función de los campos del encabezado se detalla a continuación:

\begin{itemize}
	\item \textbf{Sync:} Preámbulo de sincronización $47_H$.
	\item \textbf{Indicador de error de transporte: } Señaliza la existencia de error dentro del paquete. Cuando ese bit es puesto en 1, el decodificador procede a descartar el paquete.
	\item \textbf{Indicador de comienzo de unidad de carga: } Cuando este bit está en 1, el paquete transporta el comienzo de una tabla o de un paquete de flujo elemental.
	\item \textbf{Prioridad de transporte: } Indica que el paquete que contiene el bit en uno contiene mayor prioridad que aquellos con el mismo PID.
	\item \textbf{PID: } Identifica el contenido del paquete. [TODO: Poner una referencia a la tabla con PIDs, pero no se si ponerla.]
	\item \textbf{Control de codificación de transporte: } El término original en inglés es \emph{scrambling}. A diferencia de la encriptación, que opera en el campo digital, el \emph{scrambling} suele denominar operaciones en el campo analógico y tiene el objetivo de modificar la señal para que sólo sea interpretable por aquellos que posean el aparato necesario, sea físico o una llave digital. En conclusión, este campo provee información acerca de la codificación de la señal.
		\begin{table}[h]
		\centering
		\begin{tabular}{|c|l|}
		\hline
		\rowcolor[HTML]{C0C0C0} 
		\textbf{Valor} & \textbf{Significado}                 \\ \hline
		00    &  Sin  {\it scrambling}        \\ \hline
		01    & Reservado                   \\ \hline
		10    & Codificador con llave par   \\ \hline
		11    & Codificador con llave impar \\ \hline
		\end{tabular}
		\caption{Significado de los posibles valores de \emph{scrambling}.}
		\end{table}
	\item \textbf{Control de campo de adaptación: }Indica la presencia o no dentro del paquete TS de los campos de adaptación y carga útil, de acuerdo a la siguiente tabla.

		\begin{table}[h]
		\centering
		\begin{tabular}{|c|l|}
		\hline
		\rowcolor[HTML]{C0C0C0} 
		\textbf{Valor} & \textbf{Significado}                 \\ \hline
		00    & Reservado      \\ \hline
		01    & Sólamente carga útil                   \\ \hline
		10    & Sólamente campo de adaptación   \\ \hline
		11    & Campo de adaptación seguido de la carga útil \\ \hline
		\end{tabular}
		\caption{Significado de los posibles valores del control de campo de adaptación.}
		\end{table}

	\item \textbf{Contador de continuidad: } Contador progresivo de paquetes identificados con el mismo PID, que transportan carga útil. Su valor se incrementa en una unidad con cada paquete de la serie, realizando un \emph{wrap around} cuando todos los bits están en uno. En ciertas situaciones, es necesario retransmitir un paquete. En estos casos, el contador no debe tener en cuenta el paquete duplicado.
	\item \textbf{Campo de adaptación: } Es de carácter opcional, y su extensión depende de los \emph{flags} que posee en su interior. Una de sus importantes funciones es el rellenado de paquetes cuando su carga no alcanza a completar los 184 bytes necesarios. Este es el caso cuando se transporta la información de reloj denominada \emph{Program Clock Reference}(PCR), que se utiliza en el receptor. A continuación se detallan los 3 campos más relevantes. Para más detalle, se puede consultar el documento ISO 13818-1.
		\begin{itemize}
			\item \textbf{Longitud de campo de adaptación:} Indica el número de bytes que tiene el campo de adaptación, contando a partir del byte siguiente a este. Si el paquete TS no contiene ninguna carga útil, entonces este campo puede contener 184 bytes de longitud. En caso de contener paquetes PES, suele ser necesario agregar el campo de adaptación para incluir relleno. Para los bytes de relleno se utilizan ceros.
			\item \textbf{Indicador de discontinuidad:} Se emplea para indicar si dentro del paquete se presenta alguna discontinuidad. Por ejemplo, en la base de tiempo en relación al \emph{Program clock reference} o en el contador de discontinuidad. El valor uno indica la presencia de discontinuidad.
			\item \textbf{\emph{Program Clock Reference}(PCR):} Transporta la referencia del reloj principal utilizado en los procesos de decodificación. Ocupa un campo de 42 bits, conformado por una base de 33 bits (con un \emph{tick} de 90Khz) y una extensión de 9 bits que agrega precisión (corriendo a 27Mhz). El PCR sirve para la presentación de flujos elementales sincronizados. La norma permite un error de, a lo sumo, 500 nanosegundos.
		\end{itemize}
\end{itemize}

\subsection{Obtención de paquetes PES a partir de paquetes TS}

El formato de \emph{Packetized Elementary Stream} está definido en ISO 13818-1. Es el contenedor en el que se ubica el contenido multimedia comprimido. El problema de esta representación es que la longitud (demasiado grande) variable no resulta adecuada para su emisión en un ambiente no confiable como el espectro de radiofrecuencia.

Para obtener el flujo TS, los paquetes PES deben ser segmentados en porciones de 184 bytes, a las que se le agregan encabezados de 4 bytes para formar los paquetes TS de 188 bytes. La longitud de los paquetes PES en bytes no es necesariamente múltiplo de 184; cuando este este es el caso el último paquete TS contendrá menos de la totalidad disponible de bytes como carga. La diferencia se compensa en el rellenado del campo de adaptación.

Algunas reglas generales:
\begin{itemize}
	\item El comienzo de un paquete PES debe siempre coincidir con el inicio de cargar útil de un paquete TS.
	\item El último byte de un PES debe coincidir con el último byte de un paquete TS.
	\item El contenido de los paquetes TS debe pertenecer a un mismo programa o servicio y no pueden mezclarse servicios diferentes en un mismo paquete. 
\end{itemize}

\begin{figure}[h!]
	\begin{center}
	\includegraphics[width=12cm]{imgs/appendix_pes_in_ts.png}
	\caption{Ejemplo de distribución de paquetes PES en un flujo de transporte.\label{fig:appendix_pes_in_ts}} 
	\end{center}
\end{figure}

La \cref{fig:appendix_pes_in_ts} representa la distribución de paquetes PES a lo largo de un flujo de transporte MPEG. El primero de los paquetes no tiene una longitud múltiplo de 184, por lo que un pequeño resto debe ubicarse en el último paquete TS, que debe ser rellenado con el campo de adaptación. El segundo paquete PES del gráfico sí es múltiplo y por ende no requiere bytes de rellenado.

\subsection{Terminología útil en el flujo de transporte MPEG-2}

\begin{figure}[h!]
	\begin{center}
	\includegraphics[width=9cm]{imgs/mpeg_structure.png}
	\caption{Diagrama de composición de un flujo de transporte} 
	\end{center}
\end{figure}

\begin{itemize}
\item \textbf{Red de transmisión o \emph{network}:} Uno o más flujos de transporte emitidos por una misma entidad.
\item \textbf{Flujo de transporte:} Un flujo \textbf{MPEG-2} que lleva uno o más servicios.
\item \textbf{Servicio:} Algún contenido que puede consumir un receptor, \eg\ un canal de televisión, un canal de radio o un servicio de ingeniería. 
\item \textbf{Evento:} Un programa de televisión. Dos eventos de un mismo servicio sólo están diferenciados por el momento en que se está sintonizando un servicio específico.
\item \textbf{Flujo elemental o \emph{elementary stream}:} Un evento está compuesto por uno o más flujos elementales. A su vez, puede contener más de un flujo del mismo tipo. \eg\ un show de televisión puede estar emitiéndose en varios idiomas al mismo tiempo (un audio en inglés y otro en español). Los flujos elementales requieren de la mayor parte del ancho de banda de un flujo de transporte.
\end{itemize}

\subsubsection{Ejemplo de transport stream}

Continuando con el ejemplo introducido previamente transmitido por la frecuencia 527 Mhz, se puede ahondar en el análisis a través de la jerarquía anterior:

\begin{itemize}
\item \textbf{Red de transmisión o \emph{network}:} El nombre de la red de transmisión es ``RTA C23'' que es administrada por Radio y Televisión Argentina S.E[TODO: Agregar cita]. 
\item \textbf{Flujo de transporte:} El flujo de transporte son los contenidos enviados por el canal físico 23 correspondiente a la frecuencia 527 Mhz.
\item \textbf{Servicios:} Presenta 3. TV Pública HD, Tecnópolis y TV Pública.
\item \textbf{Evento:} Son los distintos shows de cada canal. Por ejemplo, a las 14:00 horas del 5 de Junio comienza una emisión de ``Ciencia ahora''.
\item \textbf{Flujo elemental o \emph{elementary stream}:} Los flujos elementales pueden cambiar dependiendo del evento emitido en el momento. En el caso del fragmento utilizado, presenta 4 audios y 3 videos. Existen en el flujo de transporte otros \emph{elementary streams} que caen fuera del alcance de este informe.
\end{itemize}

\newpage
\chapter{Introducción a Wari}

Acá sacamos las cosas del tur de Kuntur y sale with frits.

\newpage
\chapter{Temas de apéndice}

\begin{itemize}
\item Estructura del paquete de transport stream / Repasar el formato mpeg entero

\item Lista completa de las tablas de ISDB-Tb. Juntar con la de abajo.
\item Lista completa de los descriptores ISDB-Tb. Juntar con el de abajo
\item Lista de pids reservados, puede ir junto a lo de la tabla.

\item Comunicación de threads en Wari
\item Descompresión de audio y video? 

\item Compilación de Mara?
\item Construcción y utilización de herramientas en wari
\item OpenCaster?
\item DSM-CC explicado quizá es demasiado.
\end{itemize}

\ifx\all\undefined
\end{document}
\fi



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
